(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{202:function(t,e,r){"use strict";r.r(e),function(t){r.d(e,"onload",(function(){return i}));var o=r(33),n=r(23),a=r(6),s=r(17);function i(){return n.register("db.kmbeta.ml",!0),n.register("rt.data.gov.hk",!0),o.registerProvider("gtwp-ctbnwfb","ctbnwfb",["CTB","NWFB"],new c),!0}var c=function(){this.checkDatabaseUpdate=function(e,r,o){t.ajax({url:"https://db.kmbeta.ml/ctbnwfb_db-version.json",cache:!1,dataType:"json",success:function(t){var r,n;try{r=parseInt(t.version),n=parseInt(o)}catch(t){console.error("Error: Could not parse ctbnwfb_db last updated time or cached version! Forcing to be no update"),e(!1)}e(r>n)},error:function(t){console.error("Error: Could not check ctbnwfb_db update!"),e(!1)}})},this.getRefStopId=function(t){(t=t.toUpperCase()).split("/");for(var e of this.db.stops)if(t.includes(e.stopName.toUpperCase()))return e.stopId;return!1},this.fetchEta=function(e,r,o){var n=o.agency.agency_id,i=!1;if(n.includes("+")){i=!0;var c=n.split("+");for(var p of c)if("CTB"===p||"NWFB"===p){n=p;break}}if("CTB"!==n&&"NWFB"!==n)return console.error("Error: Cannot request ETA from companies that are not CTB and NWFB! Requested: "+n),void r();a.f("gtwp-hktransit","hktransit",n).then(c=>{var p=o.stop.stop_id,d=a.t(n,o.stop.stop_name),u=this.getRefStopId(d);if(!u)return console.error("Error: Could not find CTBNWFB reference stop ID using "+d),void r();var f="https://rt.data.gov.hk/v1/transport/citybus-nwfb/eta/"+n+"/"+u+"/"+o.route.route_short_name;t.ajax({url:f,method:"GET",dataType:"json",cache:!1,success:function(t){var r,n,a,d,u=[],f=[],h=[],l={tripId:o.trip.trip_id,startTime:"00:00:00",startDate:"20190101"},b=t.data;if(b.length>0)for(g=0;g<b.length;g++)if((n=b[g]).eta&&""!==n.eta&&(a=n.eta,d=void 0,d=a.split(/[: T-]/).map(parseFloat),r=new Date(d[0],d[1]-1,d[2],d[3]||0,d[4]||0,d[5]||0,0),f.push({stopId:p,arrival:{time:r.getTime()}})),n.rmk_en&&""!==n.rmk_en||n.rmk_tc&&""!==n.rmk_tc||n.rmk_sc&&""!==n.rmk_sc){var m=[{text:n.rmk_en,language:"en"},{text:n.rmk_tc,language:"zh-HK"},{text:n.rmk_sc,language:"zh-CN"}];h.push({informedEntity:[{trip:l,stopId:p}],headerText:{translation:m},descriptionText:{translation:m}})}var g,_=Date.now();if(f.length>0){var v={label:s.localizedKey(c,"agency_short_name")},w={id:o.agency.agency_id+"-"+o.stop.stop_id+"-"+o.route.route_short_name+"-trip-update-"+_,tripUpdate:{trip:l,stopTimeUpdate:f}};i&&(w.vehicle={vehicle:v}),u.push(w)}if(h.length>0)for(g=0;g<h.length;g++){w={id:o.agency.agency_id+"-"+o.stop.stop_id+"-"+o.route.route_short_name+"-alert-"+g+"-"+_,alert:h[g]};u.push(w)}e({header:{gtfsRealtimeVersion:"2.0",incrementality:"FULL_DATASET",timestamp:_},entity:u})},error:function(t,e,o){r()}})})},this.fetchDatabase=function(e,r){t.ajax({url:"https://db.kmbeta.ml/ctbnwfb_db.json",cache:!1,dataType:"json",success:function(t){t.routes&&t.stops&&t.version?(t.package="gtwp-ctbnwfb",t.provider="ctbnwfb",e(t)):console.error("Error: CTBNWFB downloaded database is in wrong structure! Report to GitHub for this problem!")},error:function(t,e,o){r()}})}}}.call(this,r(0))}}]);
//# sourceMappingURL=45.7cc9a26a226b2f507371.js.map