{"version":3,"sources":["webpack:///./src/gtw-ui-tab-transit.js","webpack:///./src/gtw-ui-touchkeypad.js"],"names":["searchTimeout","updateStopEtaTimer","updateEtaTimer","allNearbyRoutes","maxRequest","touchKeypadListener","eventUiBackListener","eventLocChgListener","eventLocSuccessListener","eventLocErrorListener","lastLat","lastLng","searchMode","hideTouchKeypad","filterProviderSort","listNodeCss","$","each","pkg","this","attr","provider","agency","length","css","realtimeShown","GTFS_CALENDAR_IDS","GTFS_CALENDAR_NAMES","JS_WEEKDAY_NAMES","combineCalendars","calendars","i","j","out","describeCalendar","calendar","onlyDates","i18n","text","substr","async","searchRoutes","overlayFadeInTimeout","setTimeout","fadeIn","firstLetters","val","html","k","routeName","trips","trip","route","routeId","lastStop","stopTimes","serviceId","serviceIds","pathId","pathIds","agencyId","result","str","includes","push","pathCalendars","hasBadgeBefore","calendarText","console","log","availableKeypads","firstLetter","on","mouseEnterPreviewRoute","mouseClickSelectRoute","clearTimeout","fadeOut","adjustMargin","resetProviderSort","removeClass","addClass","clearSearch","stopId","pathStop","distance","pos","nearestDistance","nearestStop","stopTime","lat","lng","scroll","draw","obj","tripId","exist","lastStopTime","freqByService","freq","freqs","savedFreq","stop","calendarDesc","tabs","tabContent","date","Date","isCurrentService","hasCurrent","currentService","getDay","active","current","min","Math","round","routeListSelectStop","thisId","parent","index","lastIndexOf","newStr","con","children","elId","startsWith","scrollIntoView","coords","title","label","drawTripOnMap","showRouteList","warn","screen","width","node","notNode","icon","notIcon","scrollNode","undefined","targetPos","content","tableNode","currFreq","len","time","getHours","getMinutes","showGtfsStaticFrequencies","clearInterval","func","returned","etaProviders","split","remove","opt","options","code","append","feeds","alerts","pairs","feed","entity","tripUpdate","timestamp","header","alertsHtml","headerText","prepend","pair","stopTimeUpdates","stopTimeUpdate","etaTime","departure","arrival","eta","floor","updateStopEta","setInterval","showStopEta","updateEta","requestLen","max","path","then","badgeClass","calcEta","badge","catch","err","findNearbyRoutes","range","allNearbyStops","testRange","ceil","maxNearbyBusDisplay","stopResult","stopRoutes","routes","nearbyRoutesLocSuccess","nearbyRoutesLocError","error","message","enable","searchText","hasClass","slice","EVENT_UI_BACK","EVENT_LOCATION_ERROR","EVENT_LOCATION_SUCCESS","EVENT_LOCATION_CHANGE","newLoc","agencies","buttonScroll","searchField","cssCond","disable","onClickListeners","mouseClickTouchKeypadValue","blur","listener","reset","showTouchKeypad","addListener","removeListener","indexOf","splice","enableFunctionKeys","disableFunctionKeys","setEnabled","keyMap","keys","Object","sort","a","b","charCodeAt","letterKeypadHtml","key"],"mappings":"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","file":"1.602e26a8780ca0332861.js","sourcesContent":["import * as Transit from './gtw-citydata-transit';\r\nimport * as TransitEta from './gtw-citydata-transit-eta';\r\nimport * as RequestLimiter from './gtw-requestlimiter';\r\nimport * as Settings from './gtw-settings';\r\nimport * as Misc from './gtw-misc';\r\nimport * as Lang from './gtw-lang';\r\nimport * as Loc from './gtw-location';\r\nimport * as TouchKeypad from './gtw-ui-touchkeypad';\r\nimport * as Event from './gtw-event';\r\nimport * as UI from './gtw-ui';\r\nimport * as Map from './gtw-map';\r\nimport * as gtfs from './gtw-citydata-transit-gtfs';\r\nimport { languages } from './gtw-lang';\r\n\r\nvar searchTimeout;\r\nvar updateStopEtaTimer;\r\nvar updateEtaTimer;\r\nvar allNearbyRoutes;\r\nvar maxRequest;\r\nvar touchKeypadListener;\r\nvar eventUiBackListener;\r\nvar eventLocChgListener;\r\nvar eventLocSuccessListener;\r\nvar eventLocErrorListener;\r\nvar lastLat = false;\r\nvar lastLng = false;\r\nvar searchMode = false;\r\n\r\nfunction showTouchKeypad() {\r\n    //$(\"#search-transit-text\").removeAttr(\"readonly\");\r\n    TouchKeypad.showTouchKeypad();\r\n}\r\n\r\nfunction hideTouchKeypad() {\r\n    //$(\"#search-transit-text\").attr(\"readonly\", \"readonly\");\r\n    TouchKeypad.hideTouchKeypad();\r\n}\r\n\r\nfunction showSearchRoutes() {\r\n    searchMode = true;\r\n\r\n    $(\"#button-cancel-search\").removeClass(\"btn-light\");\r\n    $(\"#button-cancel-search\").removeClass(\"disabled\");\r\n    $(\"#button-cancel-search\").addClass(\"btn-danger\");\r\n    $(\"#button-cancel-search\").html(\"<i class=\\\"fas fa-times\\\"></i>\");\r\n\r\n    $(\".nearby-route-list\").css(\"display\", \"none\");\r\n    $(\".all-route-list\").css(\"display\", \"flex\");\r\n    Map.setCenter(Loc.getCurrentPosition());\r\n    Map.setZoom(16);\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n    searchRoutes();\r\n    resetProviderSort();\r\n    filterProviderSort(\".all-route-list\");\r\n}\r\n\r\n\r\nfunction hideSearchRoutes() {\r\n    searchMode = false;\r\n\r\n    $(\"#button-cancel-search\").addClass(\"btn-light\");\r\n    $(\"#button-cancel-search\").addClass(\"disabled\");\r\n    $(\"#button-cancel-search\").removeClass(\"btn-danger\");\r\n    $(\"#button-cancel-search\").html(\"<i class=\\\"fas fa-search\\\"></i>\");\r\n\r\n    $(\".nearby-route-list\").css(\"display\", \"flex\");\r\n    $(\".all-route-list\").css(\"display\", \"none\");\r\n\r\n    Map.setCenter(Loc.getCurrentPosition());\r\n    Map.setZoom(16);\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n\r\n    resetProviderSort();\r\n    filterProviderSort(\".nearby-route-list\");\r\n}\r\n\r\nfunction filterProviderSort(listNodeCss) {\r\n    $(\".gtw-providersort-provider\").each(function () {\r\n        var pkg = $(this).attr(\"data-gtw-package\");\r\n        var provider = $(this).attr(\"data-gtw-provider\");\r\n        var agency = $(this).attr(\"data-gtw-agency\");\r\n\r\n        var cssCond = \"[data-gtw-package='\" + pkg + \"'][data-gtw-provider='\" + provider + \"'][data-gtw-agency='\" + agency + \"']\";\r\n\r\n        var contain = $(listNodeCss + \" .route-selection\" + cssCond + \"\").length > 0;\r\n        if (contain) {\r\n            $(this).css(\"display\", \"\");\r\n        } else {\r\n            $(this).css(\"display\", \"none\");\r\n        }\r\n    });\r\n}\r\n\r\nvar GTFS_CALENDAR_IDS = [\r\n    \"monday\",\r\n    \"tuesday\",\r\n    \"wednesday\",\r\n    \"thursday\",\r\n    \"friday\",\r\n    \"saturday\",\r\n    \"sunday\"\r\n];\r\n\r\nvar GTFS_CALENDAR_NAMES = [\r\n    \"Monday\",\r\n    \"Tuesday\",\r\n    \"Wednesday\",\r\n    \"Thursday\",\r\n    \"Friday\",\r\n    \"Saturday\",\r\n    \"Sunday\"\r\n];\r\n\r\nvar JS_WEEKDAY_NAMES = [\r\n    \"sunday\",\r\n    \"monday\",\r\n    \"tuesday\",\r\n    \"wednesday\",\r\n    \"thursday\",\r\n    \"friday\",\r\n    \"saturday\"\r\n];\r\n\r\nfunction combineCalendars(calendars) {\r\n    var out = {};\r\n    var i;\r\n    for (i = 0; i < GTFS_CALENDAR_IDS.length; i++) {\r\n        out[GTFS_CALENDAR_IDS[i]] = 0;\r\n    }\r\n    var j;\r\n    for (i = 0; i < calendars.length; i++) {\r\n        for (j = 0; j < GTFS_CALENDAR_IDS.length; j++) {\r\n            out[GTFS_CALENDAR_IDS[j]] |= calendars[i][GTFS_CALENDAR_IDS[j]];\r\n        }\r\n    }\r\n    return out;\r\n}\r\n\r\nfunction describeCalendar(calendar, onlyDates = false) {\r\n    if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"] &&\r\n        calendar[\"friday\"] &&\r\n        calendar[\"saturday\"] &&\r\n        calendar[\"sunday\"]) {\r\n        if (onlyDates) {\r\n            return $.i18n(\"transit-calendar-from-monday-to-sunday-dates\");\r\n        } else {\r\n            return false;\r\n        }\r\n    } else if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"] &&\r\n        calendar[\"friday\"] &&\r\n        calendar[\"saturday\"]) {\r\n        return $.i18n(\"transit-calendar-from-monday-to-saturday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"] &&\r\n        calendar[\"friday\"]) {\r\n        return $.i18n(\"transit-calendar-from-monday-to-friday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"]) {\r\n        return $.i18n(\"transit-calendar-from-monday-to-thursday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"saturday\"] &&\r\n        calendar[\"sunday\"]) {\r\n        return $.i18n(\"transit-calendar-from-saturday-to-sunday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"saturday\"]) {\r\n        return $.i18n(\"transit-calendar-on-saturday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"sunday\"]) {\r\n        return $.i18n(\"transit-calendar-on-sunday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    }\r\n    var text = \"\";\r\n    var i;\r\n    var val;\r\n    for (i = 0; i < GTFS_CALENDAR_IDS.length; i++) {\r\n        val = calendar[GTFS_CALENDAR_IDS[i]];\r\n        if (val) {\r\n            text += GTFS_CALENDAR_NAMES[i].substr(0, 1);\r\n        } else {\r\n            text += \".\";\r\n        }\r\n    }\r\n    return text;\r\n}\r\n\r\nasync function searchRoutes() {\r\n    var overlayFadeInTimeout = setTimeout(function () {\r\n        $(\".loading-overlay\").fadeIn(500);\r\n    }, 500);\r\n    TouchKeypad.setEnabled({});\r\n    TouchKeypad.disableFunctionKeys();\r\n\r\n    var val = $(\"#search-transit-text\").val();\r\n\r\n    var useKeypad = true;\r\n    if (!useKeypad) {\r\n        clearSearch();\r\n        return;\r\n    }\r\n    \r\n    var firstLetters;\r\n    \r\n    var html = \"<ul class=\\\"list-group\\\">\";\r\n\r\n    if (val.length === 0) {\r\n        firstLetters = await gtfs.getAllRouteNames(val.length, 1, true);\r\n    } else {\r\n        var result = await gtfs.searchRoutes(val);\r\n\r\n        var i;\r\n        var j;\r\n        var k;\r\n        var l;\r\n        var routeName;\r\n        var trips;\r\n        var trip;\r\n        var route;\r\n        var agency;\r\n        var tripId;\r\n        var routeId;\r\n        var lastStop;\r\n        var stopTimes;\r\n        var calendar;\r\n        var calendars = {};\r\n        var calendarDates = {};\r\n        var serviceId;\r\n        var serviceIds;\r\n        var pathId;\r\n        var pathIds;\r\n        firstLetters = [];\r\n\r\n        var pkg;\r\n        var provider;\r\n        var agencyId;\r\n        \r\n        var serviceArray;\r\n        var noServiceArray;\r\n\r\n        var count = 0;\r\n\r\n        for (i = 0; i < result.length; i++) {\r\n            route = result[i];\r\n            routeId = route[\"route_id\"];\r\n            routeName = Lang.localizedKey(route, \"route_short_name\");\r\n            pkg = route[\"package\"];\r\n            provider = route[\"provider\"];\r\n            agencyId = route[\"agency_id\"];\r\n\r\n            if (val.length < routeName.length) {\r\n                var str = routeName.substr(val.length, 1);\r\n                if (!firstLetters.includes(str)) {\r\n                    firstLetters.push(str);\r\n                }\r\n            }\r\n\r\n            agency = await gtfs.getAgency(pkg, provider, agencyId);\r\n            trips = await gtfs.getTripsByRouteId(pkg, provider, routeId);\r\n            pathIds = [];\r\n            serviceIds = [];\r\n            for (j = 0; j < trips.length; j++) {\r\n                trip = trips[j];\r\n                pathId = trip[\"path_id\"];\r\n                serviceId = trip[\"service_id\"];\r\n                if (!pathIds.includes(pathId)) {\r\n                    pathIds.push(pathId);\r\n                }\r\n                if (!serviceIds.includes(serviceId)) {\r\n                    serviceIds.push(serviceId);\r\n                }\r\n            }\r\n\r\n            for (j = 0; j < pathIds.length; j++) {\r\n                pathId = pathIds[j];\r\n\r\n                html +=\r\n                    \"<li class=\\\"list-group-item list-group-item-action d-flex align-items-center route-selection\\\"  data-gtw-package=\\\"\" + pkg + \"\\\" data-gtw-provider=\\\"\" + provider + \"\\\" data-gtw-agency=\\\"\" + agencyId + \"\\\" data-gtw-route-id=\\\"\" + route[\"route_id\"] + \"\\\" data-gtw-path-id=\\\"\" + pathId + \"\\\">\" +\r\n                    \"    <div class=\\\"d-flex flex-column route-id\\\">\" +\r\n                    \"        <div>\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</div>\" +\r\n                    \"        <div>\" + routeName + \"</div>\" +\r\n                    \"    </div>\" +\r\n                    \"    <div class=\\\"d-flex flex-column stop-info mr-auto\\\">\";\r\n\r\n                stopTimes = await gtfs.getStopTimePathByPathId(pkg, provider, pathId);\r\n                lastStop = await gtfs.getStop(pkg, provider, stopTimes[stopTimes.length - 1][\"stop_id\"]);\r\n\r\n                html += \"        <div><b>\" + $.i18n(\"transit-eta-to\") + \":</b> \" + gtfs.selectAgencyStopName(agency[\"agency_id\"], Lang.localizedKey(lastStop, \"stop_name\")) + \"</div>\";\r\n\r\n                var pathCalendars = [];\r\n                for (k = 0; k < serviceIds.length; k++) {\r\n                    serviceId = serviceIds[k];\r\n\r\n                    if (!calendars[serviceId]) {\r\n                        calendars[serviceId] = await gtfs.getCalendar(pkg, provider, serviceId);\r\n                    }\r\n                    pathCalendars.push(calendars[serviceId]);\r\n                }\r\n\r\n                html += \"<div>\";\r\n                //TODO: Calendar Dates\r\n\r\n                var hasBadgeBefore = false;\r\n\r\n                if (stopTimes[0][\"stop_id\"] === lastStop[\"stop_id\"]) {\r\n                    hasBadgeBefore = true;\r\n                    html +=\r\n                        \"<span class=\\\"badge badge-secondary\\\">\" +\r\n                        $.i18n(\"transit-circular-path\") +\r\n                        \"</span>\"\r\n                        ;\r\n                }\r\n\r\n                calendar = combineCalendars(pathCalendars);\r\n                var calendarText = describeCalendar(calendar)\r\n                if (calendarText) {\r\n                    if (hasBadgeBefore) {\r\n                        html += \" \";\r\n                        hasBadgeBefore = false;\r\n                    }\r\n                    html +=\r\n                        \"<span class=\\\"badge badge-secondary\\\">\" +\r\n                        calendarText +\r\n                        \"</span>\"\r\n                        ;\r\n                }\r\n                html +=\r\n                    \"        </div>\" +\r\n                    \"    </div>\" +\r\n                    \"</li>\";\r\n            }\r\n        }\r\n    }\r\n\r\n    html += \"</ul>\";\r\n    $(\".all-route-list\").html(html);\r\n\r\n    console.log(firstLetters);\r\n    var availableKeypads = {};\r\n    for (var firstLetter of firstLetters) {\r\n        availableKeypads[firstLetter] = true;\r\n    }\r\n    console.log(availableKeypads);\r\n    TouchKeypad.setEnabled(availableKeypads);\r\n    TouchKeypad.enableFunctionKeys();\r\n\r\n    $(\".all-route-list .route-selection\").on(\"mouseenter\", mouseEnterPreviewRoute);\r\n    $(\".all-route-list .route-selection\").on(\"click\", mouseClickSelectRoute);\r\n\r\n    //$(\".all-route-list .route-selection:nth-child(1)\").mouseenter();\r\n\r\n    filterProviderSort(\".all-route-list\");\r\n\r\n    clearTimeout(overlayFadeInTimeout);\r\n    $(\".loading-overlay\").fadeOut(500);\r\n    adjustMargin();\r\n}\r\n\r\nfunction resetProviderSort() {\r\n    $(\".gtw-providersort\").removeClass(\"btn-primary\");\r\n    $(\".gtw-providersort-all\").addClass(\"btn-primary\");\r\n\r\n    //$(\".gtw-providersort-provider\").addClass(\"btn-default\");\r\n    $(\".route-selection\").attr(\"style\", \"\");\r\n}\r\n\r\nfunction clearSearch() {\r\n    $(\".all-route-list\").html(\"\");\r\n    hideTouchKeypad();\r\n    $(\"#search-transit-text\").val(\"\");\r\n    hideSearchRoutes();\r\n    TouchKeypad.reset();\r\n}\r\n\r\nasync function drawTripOnMap(stopTimes) {\r\n    var coords = [];\r\n    var pos;\r\n    var stop;\r\n    var i;\r\n    for (i = 0; i < stopTimes.length; i++) {\r\n        stop = await gtfs.getStop(stopTimes[i][\"package\"], stopTimes[i][\"provider\"], stopTimes[i][\"stop_id\"]);\r\n        pos = { lat: stop[\"stop_lat\"], lng: stop[\"stop_lon\"] };\r\n        coords.push(pos);\r\n        Map.addMarker(pos, {\r\n            title: stop[\"stop_name\"],\r\n            label: \"\" + (i + 1)\r\n        });\r\n    }\r\n    Map.addPolyline(coords, \"#FF0000\", 2);\r\n}\r\n\r\nasync function mouseClickSelectRoute() {\r\n    //fromSearch = $(this).parent().parent().hasClass(\"all-route-list\");\r\n\r\n    var pkg = $(this).attr(\"data-gtw-package\");\r\n    var provider = $(this).attr(\"data-gtw-provider\");\r\n    var agency = $(this).attr(\"data-gtw-agency\");\r\n    var routeId = $(this).attr(\"data-gtw-route-id\");\r\n    var pathId = $(this).attr(\"data-gtw-path-id\");\r\n    var stopId = $(this).attr(\"data-gtw-stop-id\");\r\n\r\n    var stopTimes = await gtfs.getStopTimePathByPathId(pkg, provider, pathId);\r\n\r\n    if (!stopId && Loc.isLocated()) {\r\n        var pos = Loc.getCurrentPosition();\r\n        \r\n        var pathStop;\r\n        var distance;\r\n        var nearestDistance = false;\r\n        var nearestStop = false;\r\n        for (var stopTime of stopTimes) {\r\n            pathStop = await gtfs.getStop(pkg, provider, stopTime[\"stop_id\"]);\r\n            distance = Misc.geoDistance(pathStop[\"stop_lat\"], pathStop[\"stop_lon\"], pos.lat, pos.lng);\r\n            if (!nearestDistance || !nearestStop || distance < nearestDistance) {\r\n                nearestDistance = distance;\r\n                nearestStop = pathStop;\r\n            }\r\n        }\r\n\r\n        console.log(nearestDistance);\r\n        if (nearestDistance <= 2) {\r\n            stopId = nearestStop[\"stop_id\"];\r\n        }\r\n    }\r\n\r\n    var overlayFadeInTimeout = setTimeout(function () {\r\n        $(\".loading-overlay\").fadeIn(500);\r\n    }, 500);\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n\r\n    await showRouteList(pkg, provider, agency, routeId, pathId, stopId, true, true);\r\n\r\n    UI.hidePanel();\r\n    hideTouchKeypad();\r\n\r\n    await routeListSelectStop(pkg, provider, agency, routeId, pathId, stopTimes, stopId);\r\n    clearTimeout(overlayFadeInTimeout);\r\n    $(\".loading-overlay\").fadeOut(500);\r\n}\r\n\r\nfunction mouseEnterPreviewRoute() {\r\n    console.warn(\"TODO: Preview route\");\r\n    /*\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n    var provider = TransitRoutes.getProvider($(this).attr(\"gtw-provider\"));\r\n    var route = provider.getRouteById($(this).attr(\"gtw-route-id\"));\r\n    var sstop = TransitStops.getStopById($(this).attr(\"gtw-stop-id\"));\r\n    var bound = $(this).attr(\"gtw-bound\");\r\n    drawRouteOnMap(route, bound);\r\n\r\n    if (sstop) {\r\n        var targetPos = { lat: sstop.lat, lng: sstop.lng };\r\n        Map.setCenter(targetPos);\r\n        Map.setZoom(18);\r\n    } else {\r\n        var path = route.paths[bound];\r\n\r\n        var latlngs = [];\r\n        var stop;\r\n        for (var stopId of path) {\r\n            stop = TransitStops.getStopById(stopId);\r\n            latlngs.push({ lat: parseFloat(stop.lat), lng: parseFloat(stop.lng) });\r\n        }\r\n        Map.fitBounds(latlngs);\r\n    }\r\n    */\r\n}\r\n\r\nasync function showRouteList(pkg, provider, agencyId, routeId, pathId, stopId, scroll = false, draw = false) {\r\n    var stopTimes = await gtfs.getStopTimePathByPathId(pkg, provider, pathId);\r\n    var route = await gtfs.getRoute(pkg, provider, routeId);\r\n    var agency = await gtfs.getAgency(pkg, provider, agencyId);\r\n    var lastStopTime = stopTimes[stopTimes.length - 1];\r\n    var lastStop = await gtfs.getStop(pkg, provider, lastStopTime[\"stop_id\"]);\r\n    var trips = await gtfs.getTripsByRouteId(pkg, provider, routeId);\r\n\r\n    var freqByService = {};\r\n    var obj;\r\n    var freqs;\r\n    var tripId;\r\n    var serviceId;\r\n    var exist;\r\n    for (i = 0; i < trips.length; i++) {\r\n        if (pathId !== trips[i][\"path_id\"]) {\r\n            continue;\r\n        }\r\n\r\n        tripId = trips[i][\"trip_id\"];\r\n        serviceId = trips[i][\"service_id\"];\r\n        if (!freqByService[serviceId]) {\r\n            freqByService[serviceId] = {\r\n                calendar: await gtfs.getCalendar(pkg, provider, serviceId),\r\n                freqs: []\r\n            };\r\n        }\r\n        obj = freqByService[serviceId];\r\n        freqs = await gtfs.getFrequencies(pkg, provider, tripId);\r\n        for (var freq of freqs) {\r\n            exist = false;\r\n            for (var savedFreq of obj.freqs) {\r\n                if (savedFreq[\"start_time\"] === freq[\"start_time\"] &&\r\n                    savedFreq[\"end_time\"] === freq[\"end_time\"] &&\r\n                    savedFreq[\"headway_secs\"] === freq[\"headway_secs\"]) {\r\n                    exist = true;\r\n                    break;\r\n                }\r\n            }\r\n            if (!exist) {\r\n                obj.freqs.push(freq);\r\n            }\r\n        }\r\n    }\r\n\r\n    //Header\r\n\r\n    var html =\r\n        \"<ul class=\\\"list-group\\\"><li class=\\\"list-group-item d-flex align-items-center route-selection\\\">\" +\r\n        \"    <div class=\\\"d-flex flex-column route-id\\\">\" +\r\n        \"        <div>\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</div>\" +\r\n        \"        <div>\" + Lang.localizedKey(route, \"route_short_name\") + \"</div>\" +\r\n        \"    </div>\" +\r\n        \"    <div class=\\\"d-flex flex-column stop-info mr-auto\\\">\" +\r\n        \"        <div><b>\" + $.i18n(\"transit-eta-to\") + \":</b> \" + gtfs.selectAgencyStopName(agencyId, Lang.localizedKey(lastStop, \"stop_name\")) + \"</div><div>\";\r\n\r\n    var hasBadgeBefore = false;\r\n\r\n    if (stopTimes[0][\"stop_id\"] === lastStop[\"stop_id\"]) {\r\n        hasBadgeBefore = true;\r\n        html +=\r\n            \"<span class=\\\"badge badge-secondary\\\">\" +\r\n            $.i18n(\"transit-circular-path\") +\r\n            \"</span>\"\r\n            ;\r\n    }\r\n\r\n    var pathCalendars = [];\r\n    for (var serviceId in freqByService) {\r\n        pathCalendars.push(freqByService[serviceId].calendar);\r\n    }\r\n\r\n    var calendar = combineCalendars(pathCalendars);\r\n    var calendarText = describeCalendar(calendar)\r\n    if (calendarText) {\r\n        if (hasBadgeBefore) {\r\n            html += \" \";\r\n            hasBadgeBefore = false;\r\n        }\r\n        html +=\r\n            \"<span class=\\\"badge badge-secondary\\\">\" +\r\n            calendarText +\r\n            \"</span>\"\r\n            ;\r\n    }\r\n\r\n    html +=\r\n        \"</div></div></li></ul>\" +\r\n        \"<ul class=\\\"nav nav-pills nav-fill m-2\\\" role=\\\"tablist\\\" id=\\\"pills-route-list-tab\\\">\" +\r\n        \"    <li class=\\\"nav-item\\\">\" +\r\n        \"        <a class=\\\"nav-link active\\\" id=\\\"pills-route-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#pills-route\\\" role=\\\"tab\\\" aria-controls=\\\"pills-route\\\" aria-selected=\\\"true\\\">\" + $.i18n(\"transit-route-tab-route-list\") + \"</a>\" +\r\n        \"    </li>\" +\r\n        \"    <li class=\\\"nav-item\\\">\" +\r\n        \"        <a class=\\\"nav-link\\\" id=\\\"pills-timetable-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#pills-timetable\\\" role=\\\"tab\\\" aria-controls=\\\"pills-timetable\\\" aria-selected=\\\"false\\\">\" + $.i18n(\"transit-route-tab-timetable\") + \"</a>\" +\r\n        \"    </li>\" +\r\n        \"    <li class=\\\"nav-item\\\">\" +\r\n        \"        <a class=\\\"nav-link disabled\\\" id=\\\"pills-other-routes-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#pills-other-routes\\\" role=\\\"tab\\\" aria-controls=\\\"pills-other-routes\\\" aria-selected=\\\"false\\\">\" + $.i18n(\"transit-route-tab-other-routes\") + \"</a>\" +\r\n        \"    </li>\" +\r\n        \"</ul>\"\r\n        ;\r\n    $(\".half-map-tab-panel\").html(html);\r\n\r\n    //Route Tab\r\n\r\n    html =\r\n        \"<div class=\\\"tab-content\\\" id=\\\"pills-route-list-tabContent\\\">\" +\r\n        \"    <div class=\\\"tab-pane fade show active\\\" id=\\\"pills-route\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"pills-route-tab\\\">\" +\r\n        \"        <div class=\\\"row\\\" style=\\\"padding: 2%;\\\">\" +\r\n        \"            <div class=\\\"timeline-centered\\\">\"\r\n        ;\r\n    var i;\r\n    var stop;\r\n    for (i = 0; i < stopTimes.length; i++) {\r\n        //TODO: Fare attributes and rules\r\n        stop = await gtfs.getStop(pkg, provider, stopTimes[i][\"stop_id\"]);\r\n        html +=\r\n            \"<article class=\\\"timeline-entry\\\" data-gtw-package=\\\"\" + pkg + \"\\\" data-gtw-provider=\\\"\" + provider + \"\\\" data-gtw-agency=\\\"\" + agencyId + \"\\\" data-gtw-route-id=\\\"\" + routeId + \"\\\" data-gtw-path-id=\\\"\" + pathId + \"\\\" data-gtw-stop-id=\\\"\" + stop[\"stop_id\"] + \"\\\">\" +\r\n            \"    <div class=\\\"timeline-entry-inner\\\">\" +\r\n            \"        <div class=\\\"timeline-icon bg-light\\\">\" +\r\n            \"            \" + (i + 1) +\r\n            \"        </div>\" +\r\n            \"        <div class=\\\"timeline-label\\\">\" +\r\n            \"            <h2><button style=\\\"padding: 0px;\\\" class=\\\"btn btn-link\\\" data-gtw-package=\\\"\" + pkg + \"\\\" data-gtw-provider=\\\"\" + provider + \"\\\" data-gtw-agency=\\\"\" + agencyId + \"\\\" data-gtw-route-id=\\\"\" + routeId + \"\\\" data-gtw-path-id=\\\"\" + pathId + \"\\\" data-gtw-stop-id=\\\"\" + stop[\"stop_id\"] + \"\\\" data-gtw-stop-sequence=\\\"\" + stopTimes[i][\"stop_sequence\"] + \"\\\" data-gtw-stop-index=\\\"\" + i + \"\\\">\" + gtfs.selectAgencyStopName(agencyId, Lang.localizedKey(stop, \"stop_name\")) + \"</button></h2>\" +\r\n            \"            <p></p>\" +\r\n            \"        </div>\" +\r\n            \"    </div>\" +\r\n            \"</article>\"\r\n            ;\r\n    }\r\n    html +=\r\n        \"            </div>\" +\r\n        \"        </div>\" +\r\n        \"    </div>\" +\r\n        \"    <div class=\\\"tab-pane fade\\\" id=\\\"pills-timetable\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"pills-timetable-tab\\\">\";\r\n\r\n    //Timetable Tab\r\n\r\n    var tabs = \"<ul class=\\\"nav nav-pills nav-fill mb-3\\\" id=\\\"calendar-tab\\\" role=\\\"tablist\\\">\";\r\n    var tabContent = \"<div class=\\\"tab-content\\\" id=\\\"calendar-tabContent\\\">\";\r\n    var calendarDesc;\r\n\r\n    var date = new Date();\r\n    var isCurrentService = {};\r\n    var hasCurrent = false;\r\n    for (var serviceId in freqByService) {\r\n        var currentService = freqByService[serviceId].calendar[JS_WEEKDAY_NAMES[date.getDay()]] === 1;\r\n        isCurrentService[serviceId] = currentService;\r\n        hasCurrent |= currentService;\r\n    }\r\n\r\n    var i = 0;\r\n    for (var serviceId in freqByService) {\r\n        obj = freqByService[serviceId];\r\n        calendarDesc = describeCalendar(obj.calendar, true);\r\n\r\n        var active;\r\n        var current;\r\n        if (hasCurrent) {\r\n            current = isCurrentService[serviceId];\r\n            active = current;\r\n        } else {\r\n            current = false;\r\n            active = i === 0;\r\n        }\r\n\r\n        tabs +=\r\n            \"<li class=\\\"nav-item\\\">\" +\r\n            \"    <a class=\\\"nav-link\" + (active ? \" active\" : \"\") + \"\\\" id=\\\"calendar-\" + serviceId + \"-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#calendar-\" + serviceId + \"\\\" role=\\\"tab\\\" aria-controls=\\\"calendar-\" + serviceId + \"\\\" aria-selected=\\\"\" + (active ? \"true\" : \"false\") + \"\\\">\" + (current ? \"<i class=\\\"fas fa-hourglass-half\\\"></i> \" : \"\") + calendarDesc + \"</a>\" +\r\n            \"</li>\"\r\n            ;\r\n        tabContent +=\r\n            \"<div class=\\\"tab-pane fade\" + (active ? \" show active\" : \"\") + \"\\\" id=\\\"calendar-\" + serviceId + \"\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"calendar-\" + serviceId + \"-tab\\\">\" +\r\n            \"    <table class=\\\"table\\\">\" +\r\n            \"        <thead class=\\\"thead-light\\\">\" +\r\n            \"            <tr>\" +\r\n            \"                <th scope=\\\"col\\\" colspan=\\\"\" + (current && hasCurrent ? \"4\" : \"3\") + \"\\\">\" + $.i18n(\"transit-calendar-header-timeslot\") + \"</th>\" +\r\n            \"                <th scope=\\\"col\\\">\" + $.i18n(\"transit-calendar-header-headway-min\") + \"</th>\" +\r\n            \"            </tr>\" +\r\n            \"        </thead>\" +\r\n            \"        <tbody>\";\r\n        i++;\r\n\r\n        if (obj.freqs.length > 0) {\r\n            for (var freq of obj.freqs) {\r\n                var min = Math.round(freq[\"headway_secs\"] / 60);\r\n                tabContent +=\r\n                    \"            <tr>\";\r\n\r\n                if (current && hasCurrent) {\r\n                    if (gtfs.isCurrentFrequency(freq)) {\r\n                        tabContent +=\r\n                            \"                <td><i class=\\\"fas fa-hourglass-half\\\"></i></td>\";\r\n                    } else {\r\n                        tabContent +=\r\n                            \"                <td></td>\";\r\n                    }\r\n                }\r\n\r\n                tabContent +=\r\n                    \"                <td>\" + freq[\"start_time\"] + \"</td>\" +\r\n                    \"                <td>-</td>\" +\r\n                    \"                <td>\" + freq[\"end_time\"] + \"</td>\" +\r\n                    \"                <td>\" + min + \"</td>\" +\r\n                    \"            </tr>\";\r\n            }\r\n        } else {\r\n            tabContent +=\r\n                \"                <td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-no-timetable\") + \"</td>\" +\r\n                \"            </tr>\";\r\n        }\r\n\r\n        tabContent +=\r\n            \"        </tbody>\" +\r\n            \"    </table>\" +\r\n            \"</div>\";\r\n    }\r\n    tabs += \"</ul>\";\r\n\r\n    html +=\r\n        tabs + tabContent +\r\n        \"    </div>\" +\r\n        \"    <div class=\\\"tab-pane fade\\\" id=\\\"pills-other-routes\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"pills-other-routes-tab\\\">\";\r\n\r\n    //Other routes tab\r\n\r\n    html +=\r\n        \"</div>\" +\r\n        \"</div>\"\r\n        ;\r\n    $(\".half-map-container\").html(html);\r\n\r\n    $(\".half-map-container button\").on(\"click\", function () {\r\n        var pkg = $(this).attr(\"data-gtw-package\");\r\n        var provider = $(this).attr(\"data-gtw-provider\");\r\n        var agencyId = $(this).attr(\"data-gtw-agency\");\r\n        var routeId = $(this).attr(\"data-gtw-route-id\");\r\n        var pathId = $(this).attr(\"data-gtw-path-id\");\r\n        var stopId = $(this).attr(\"data-gtw-stop-id\");\r\n        routeListSelectStop(pkg, provider, agencyId, routeId, pathId, stopTimes, stopId);\r\n    });\r\n\r\n    //I don't know why Bootstrap's tab is not working... custom JS code\r\n    $(\".nav-pills[role='tablist'] .nav-item a\").on(\"click\", function () {\r\n        var thisId = $(this).parent().parent().attr(\"id\");\r\n        var index = thisId.lastIndexOf(\"-tab\");\r\n        var newStr = thisId.substr(0, index) + \"-tabContent\";\r\n        var con = $(this).attr(\"aria-controls\");\r\n        $(\".tab-content[id='\" + newStr + \"']\").children(\".tab-pane\").each(function () {\r\n            var elId = $(this).attr(\"id\");\r\n            if (elId !== con) {\r\n                $(this).removeClass(\"show\");\r\n                $(this).removeClass(\"active\");\r\n            } else {\r\n                $(this).addClass(\"show\");\r\n                $(this).addClass(\"active\");\r\n                if (!elId.startsWith(\"calendar-\")) {\r\n                    $(this)[0].scrollIntoView();\r\n                }\r\n            }\r\n        });\r\n    });\r\n\r\n    if (draw) {\r\n        await drawTripOnMap(stopTimes);\r\n    }\r\n\r\n    adjustMargin();\r\n}\r\n\r\nasync function routeListSelectStop(pkg, provider, agencyId, routeId, pathId, stopTimes, stopId) {\r\n    var parent = screen.width >= 768 ? \".desktop\" : \".mobile\";\r\n\r\n    var node = $(parent + \" .timeline-entry[data-gtw-stop-id='\" + stopId + \"']\");\r\n    var notNode = $(parent + \" .timeline-entry:not([data-gtw-stop-id='\" + stopId + \"'])\");\r\n\r\n    var icon = node.children(\".timeline-entry-inner\").children(\".timeline-icon\");\r\n    var notIcon = node.children(\".timeline-entry-inner\").children(\".timeline-icon\");\r\n\r\n    icon.removeClass(\"bg-light\");\r\n    icon.addClass(\"bg-primary\");\r\n\r\n    notIcon.addClass(\"bg-light\");\r\n    notIcon.removeClass(\"bg-primary\");\r\n\r\n    //var nodeP = node.children(\".timeline-entry-inner\").children(\".timeline-label\").children(\"p\");\r\n    var notNodeP = notNode.children(\".timeline-entry-inner\").children(\".timeline-label\").children(\"p\");\r\n\r\n    notNodeP.html(\"\");\r\n\r\n    if (scroll) {\r\n        var scrollNode = node[0];\r\n        if (scrollNode === undefined) {\r\n            scrollNode = $(parent + \" .timeline-entry\")[0];\r\n        }\r\n        scrollNode.scrollIntoView();\r\n    }\r\n\r\n    if (stopId) {\r\n        var agency = await gtfs.getAgency(pkg, provider, agencyId);\r\n        var route = await gtfs.getRoute(pkg, provider, routeId);\r\n        var trip = await gtfs.getCurrentTrip(pkg, provider, route[\"route_id\"]);\r\n        var stop = await gtfs.getStop(pkg, provider, stopId);\r\n\r\n        var targetPos = { lat: stop[\"stop_lat\"], lng: stop[\"stop_lon\"] };\r\n\r\n        Map.setCenter(targetPos);\r\n        Map.setZoom(18);\r\n\r\n        showStopEta(agency, route, trip, stopTimes, stop);\r\n    }\r\n}\r\n\r\nvar realtimeShown;\r\n\r\nasync function showGtfsStaticFrequencies(pkg, provider, routeId, stopId, pathId) {\r\n    var tableNode = $(\".timeline-entry[data-gtw-stop-id='\" + stopId + \"'] p table tbody\");\r\n\r\n    var freqs = await gtfs.getRoutePathFrequencies(pkg, provider, routeId, pathId);\r\n\r\n    var currFreq = -1;\r\n    var i;\r\n    for (i = 0; i < freqs.length; i++) {\r\n        if (gtfs.isCurrentFrequency(freqs[i])) {\r\n            currFreq = i;\r\n            break;\r\n        }\r\n    }\r\n\r\n    var content = \"\";\r\n    if (currFreq !== -1) {\r\n        var len = currFreq + 3 >= freqs.length ? freqs.length : currFreq + 3;\r\n        for (var i = currFreq; i < len; i++) {\r\n            var min = Math.round(freqs[i][\"headway_secs\"] / 60);\r\n\r\n            var time = gtfs.timeToDate(freqs[i][\"start_time\"]);\r\n\r\n            content +=\r\n                \"<tr class=\\\"table-secondary\" + (i == currFreq ? \" active\" : \"\") + \"\\\">\" +\r\n                \"    <td>\" + $.i18n(\"transit-eta-every-minutes\", min) + \"</td>\" +\r\n                \"    <td colspan=\\\"2\\\">\" + Misc.fillZero(time.getHours()) + \":\" + Misc.fillZero(time.getMinutes()) + \"</td>\" +\r\n                \"</tr>\";\r\n        }\r\n    } else if (freqs.length === 0) {\r\n        content +=\r\n            \"<tr class=\\\"table-dark\\\">\" +\r\n            \"    <td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-no-timetable\") + \"</td>\" +\r\n            \"</tr>\";\r\n    } else {\r\n        content +=\r\n            \"<tr class=\\\"table-dark\\\">\" +\r\n            \"    <td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-not-in-service\") + \"</td>\" +\r\n            \"</tr>\";\r\n    }\r\n\r\n    if (!realtimeShown) {\r\n        tableNode.html(content);\r\n    }\r\n}\r\n\r\nasync function updateStopEta(agency, route, trip, stopTimes, stop) {\r\n    $(\".eta-loading-spinner\").css(\"display\", \"\");\r\n    try {\r\n        var returned = await TransitEta.fetchEta({\r\n            etaProviders: agency[\"agency_id\"].split(\"+\"),\r\n            agency: agency,\r\n            route: route,\r\n            trip: trip,\r\n            stopTimes: stopTimes,\r\n            stop: stop\r\n        });\r\n        $(\".stop-eta-msg\").remove();\r\n        $(\".eta-loading-spinner\").css(\"display\", \"none\");\r\n        console.log(returned);\r\n        var opt = returned.options;\r\n        var content = \"\";\r\n        var node = $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] p table tbody\");\r\n        if (returned.code === -2) {\r\n            var html = \"<p class=\\\"stop-eta-msg\\\">*\" + $.i18n(\"transit-eta-no-eta-providers\") + \"</p>\";\r\n            ;\r\n            $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] p\").append(html);\r\n        } else if (returned.code === -1 || (returned.feeds && returned.feeds.length === 0)) {\r\n            var html = \"<p class=\\\"stop-eta-msg\\\">*\" + $.i18n(\"transit-eta-no-data-received\") + \"</p>\";\r\n            ;\r\n            $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] p\").append(html);\r\n        } else {\r\n            var alerts = [];\r\n            var pairs = [];\r\n            for (var feed of returned.feeds) {\r\n                for (var entity of feed.entity) {\r\n                    var tripUpdate = entity[\"tripUpdate\"];\r\n                    if (tripUpdate) {\r\n                        var timestamp = tripUpdate.timestamp ? tripUpdate.timestamp : feed.header.timestamp;\r\n                        pairs.push({\r\n                            timestamp: timestamp,\r\n                            entity: entity\r\n                        });\r\n                    }\r\n\r\n                    if (entity[\"alert\"]) {\r\n                        alerts.push(entity[\"alert\"]);\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (alerts.length > 0) {\r\n                var alertsHtml = \"\";\r\n                if (alerts.length === 1) {\r\n                    alertsHtml =\r\n                        \"<div class=\\\"stop-eta-msg alert alert-warning\\\"><i class=\\\"fas fa-exclamation-triangle\\\"></i> <b>\" + Lang.translatedString(alerts[0].headerText) + \"</b></div>\";\r\n                } else {\r\n                    alertsHtml =\r\n                        \"<div class=\\\"stop-eta-msg alert alert-warning\\\"><i class=\\\"fas fa-exclamation-triangle\\\"></i> <b>\" + $.i18n(\"transit-eta-alerts-affecting-stop\", alerts.length) + \"</b> <button class=\\\"btn btn-link view-alert-btn\\\">\" + $.i18n(\"transit-eta-view-alerts-affecting-stop\") + \"</button></div>\";\r\n                }\r\n                $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] p\").prepend(alertsHtml);\r\n                $(\".view-alert-btn\").on(\"click\", function () {\r\n                    UI.showModal(\"viewgtfsalerts\", alerts);\r\n                });\r\n            }\r\n\r\n            if (pairs.length === 0) {\r\n                var html = \"<p>*\" + $.i18n(\"transit-eta-no-schedules-pending\") + \"</p>\";\r\n                ;\r\n                $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] p\").append(html);\r\n            } else {\r\n                var content = \"\";\r\n\r\n                var active = false;\r\n                for (var pair of pairs) {\r\n                    var stopTimeUpdates = pair.entity.tripUpdate[\"stopTimeUpdate\"];\r\n                    if (stopTimeUpdates && stopTimeUpdates.length > 0) {\r\n                        for (var stopTimeUpdate of stopTimeUpdates) {\r\n                            if (!stopTimeUpdate[\"scheduleRelationship\"] || stopTimeUpdate[\"scheduleRelationship\"] === \"SCHEDULED\") {\r\n                                var etaTime;\r\n                                //TODO: Calculate non-absolute time from trips\r\n                                if (stopTimeUpdate.departure) {\r\n                                    etaTime = stopTimeUpdate.departure.time;\r\n                                } else if (stopTimeUpdate.arrival) {\r\n                                    etaTime = stopTimeUpdate.arrival.time;\r\n                                }\r\n\r\n                                var eta = Math.floor((etaTime - pair.timestamp) / 1000 / 60);\r\n\r\n                                var html = \"<tr class=\\\"table-\";\r\n\r\n                                if (eta >= 20) {\r\n                                    html += \"secondary\";\r\n                                } else if (eta >= 15) {\r\n                                    html += \"info\";\r\n                                } else if (eta >= 10) {\r\n                                    html += \"success\";\r\n                                } else if (eta >= 5) {\r\n                                    html += \"warning\";\r\n                                } else if (eta >= 1) {\r\n                                    html += \"danger\";\r\n                                } else {\r\n                                    html += \"dark\";\r\n                                }\r\n\r\n                                if (!active && eta > 0) {\r\n                                    active = true;\r\n                                    html += \" active\";\r\n                                }\r\n\r\n                                html += \"\\\">\";\r\n\r\n                                /*\r\n                                //TODO: isOutdated\r\n    \r\n                                var provider = TransitEta.getProvider(schedule.provider);\r\n                                if (!provider) {\r\n                                    console.error(\"Error: Could not find TransitEta provider to get localized names: \" + schedule.provider);\r\n                                    return;\r\n                                }\r\n                                */\r\n\r\n                                var colspan = 4;\r\n\r\n                                /*\r\n                                if (opt.etaProviders.length > 1) {\r\n                                    html += \"<td>\" + Lang.localizedKey(provider, \"name\") + \"</td>\";\r\n                                    colspan--;\r\n                                }\r\n                                */\r\n\r\n                                if (pair.entity[\"vehicle\"] && pair.entity[\"vehicle\"][\"vehicle\"] && pair.entity[\"vehicle\"][\"vehicle\"][\"label\"]) {\r\n                                    html += \"<td>\" + pair.entity[\"vehicle\"][\"vehicle\"][\"label\"] + \"</td>\";\r\n                                    colspan--;\r\n                                }\r\n\r\n                                /*\r\n                                if (schedule.msg !== undefined && schedule.time === undefined) {\r\n                                    html += \"<td colspan=\\\"\" + colspan + \"\\\">\" + schedule.msg + \"</td>\";\r\n                                }\r\n                                */\r\n\r\n                                html += \"<td>\";\r\n                                /*\r\n                                if (schedule.msg !== undefined) {\r\n                                    html += schedule.msg;\r\n                                }\r\n                                if (schedule.time !== undefined) {\r\n                                    if (schedule.msg !== undefined) {\r\n                                        html += \"<br />\";\r\n                                    }\r\n                                }\r\n                                */\r\n\r\n                                if (eta > 0) {\r\n                                    html += $.i18n(\"transit-eta-minutes\", eta);\r\n                                } else {\r\n                                    html += $.i18n(\"transit-eta-arrived-left\");\r\n                                }\r\n\r\n                                html += \"</td><td\";\r\n\r\n                                /*\r\n                                if (schedule.isLive === undefined) {\r\n                                }\r\n                                */\r\n                                html += \" colspan=\\\"2\\\"\";\r\n\r\n                                html += \">\";\r\n\r\n                                var time = new Date(etaTime);\r\n\r\n                                html += Misc.fillZero(time.getHours()) + \":\" + Misc.fillZero(time.getMinutes());\r\n                                /*\r\n                                if (schedule.time !== undefined) {\r\n                                } else {\r\n                                    html += \"---\";\r\n                                }\r\n                                */\r\n\r\n                                html += \"</td>\";\r\n\r\n                                /*\r\n                                if (schedule.isLive !== undefined) {\r\n                                    if (schedule.isLive) {\r\n                                        html += \"<td><span style=\\\"color: red; float: right; font-size: 10px;\\\"><i class=\\\"fa fa-circle\\\"></i> \" + $.i18n(\"transit-eta-live\") + \"</span></td>\";\r\n                                    } else {\r\n                                        html += \"<td><span style=\\\"font-size: 10px; float: right; font-style: italic;\\\">\" + $.i18n(\"transit-eta-scheduled\") + \"</span></td>\";\r\n                                    }\r\n                                }\r\n                                */\r\n\r\n                                html += \"</tr>\";\r\n                                content += html;\r\n                            } else {\r\n                                //TODO: cancelled\r\n                            }\r\n                        }\r\n                    } else {\r\n                        //TODO: NO Data\r\n                    }\r\n                }\r\n\r\n                $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] p table tbody\").html(content);\r\n                realtimeShown = true;\r\n            }\r\n        }\r\n    } catch (options) {\r\n        $(\".eta-loading-spinner\").css(\"display\", \"none\");\r\n        var html = \"<p class=\\\"text-danger\\\">*\" + $.i18n(\"transit-eta-error-fetching-eta\") + \"</p>\";\r\n        ;\r\n        $(\".timeline-entry[data-gtw-stop-id='\" + stop[\"stop_id\"] + \"'] p\").append(html);\r\n        //var node = $(\".timeline-entry[data-gtw-stop-id='\" + options.stop[\"stop_id\"] + \"'] p table tbody\");\r\n        //node.html(\"<tr class=\\\"table-danger\\\"><td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-error-fetching-eta\") + \"</td></tr>\");\r\n    }\r\n}\r\n\r\nasync function showStopEta(agency, route, trip, stopTimes, stop) {\r\n    var node = $(\".timeline-entry[data-gtw-stop-id='\" + stop[\"stop_id\"] + \"'] p\");\r\n\r\n    var content =\r\n        \"<u>\" + $.i18n(\"transit-eta\") + \"</u> <div class=\\\"spinner-border spinner-border-sm eta-loading-spinner\\\" role=\\\"status\\\"></div>\" +\r\n        \"<table class=\\\"table stop-eta\\\">\" +\r\n        \"    <tr class=\\\"table-dark\\\">\" +\r\n        \"        <td colspan=\\\"4\\\"><div class=\\\"spinner-border spinner-border-sm\\\" role=\\\"status\\\"></div> \" + $.i18n(\"transit-eta-retrieving-data\") + \"</td>\" +\r\n        \"    </tr>\" +\r\n        \"</table>\";\r\n    node.html(content);\r\n\r\n    //\r\n    // GTFS-static freqencies\r\n    //\r\n\r\n    realtimeShown = false;\r\n    showGtfsStaticFrequencies(route[\"package\"], route[\"provider\"], route[\"route_id\"], stop[\"stop_id\"], stopTimes[0][\"path_id\"]);\r\n\r\n    //\r\n    // GTFS Realtime data\r\n    //\r\n\r\n    clearInterval(updateStopEtaTimer);\r\n    var func = function () {\r\n        updateStopEta(agency, route, trip, stopTimes, stop);\r\n    };\r\n    func();\r\n    updateStopEtaTimer = setInterval(func, 30000);\r\n}\r\n\r\nfunction updateEta() {\r\n    var requestLen = RequestLimiter.requests.length;\r\n    if (requestLen > 0) {\r\n        $(\".request-progress-panel\").fadeIn(500);\r\n\r\n        var max = maxRequest;\r\n        if (!max || requestLen > max) {\r\n            max = maxRequest = requestLen;\r\n        }\r\n\r\n        $(\".request-progress-panel .progress-bar\").html($.i18n(\"transit-eta-requesting-data\", max - requestLen, max));\r\n        //$(\".request-progress-panel .progress-bar\").html(Math.floor((max - requestLen) / max * 100) + \"%\");\r\n        $(\".request-progress-panel .progress-bar\").css(\"width\", Math.floor((max - requestLen) / max * 100) + \"%\");\r\n    } else {\r\n        maxRequest = 0;\r\n        $(\".request-progress-panel .progress-bar\").css(\"width\", \"100%\");\r\n        $(\".request-progress-panel\").fadeOut(500, function () {\r\n            $(\".request-progress-panel .progress-bar\").css(\"width\", \"0%\");\r\n        });\r\n    }\r\n    //var h;\r\n    for (var result of allNearbyRoutes) {\r\n        var agency = gtfs.get\r\n        var p = TransitEta.fetchEta({\r\n            etaProviders: result.route[\"agency_id\"].split(\"+\"),\r\n            agency: result.agency,\r\n            route: result.route,\r\n            trip: result.trip,\r\n            stop: result.stop,\r\n            stopTimes: result.path\r\n        });\r\n        p.then(function (returned) {\r\n            var text = \"\";\r\n            var opt = returned.options;\r\n\r\n            var node = $(\".nearby-route-list .route-selection[data-gtw-package=\\\"\" + opt.agency[\"package\"] + \"\\\"][data-gtw-provider=\\\"\" + opt.agency[\"provider\"] + \"\\\"][data-gtw-agency=\\\"\" + opt.agency[\"agency_id\"] + \"\\\"][data-gtw-route-id=\\\"\" + opt.route[\"route_id\"] + \"\\\"][data-gtw-path-id=\\\"\" + opt.trip[\"path_id\"] + \"\\\"][data-gtw-stop-id=\\\"\" + opt.stop[\"stop_id\"] + \"\\\"]\");\r\n\r\n            node.removeClass(\"list-group-item-secondary\");\r\n            node.removeClass(\"list-group-item-info\");\r\n            node.removeClass(\"list-group-item-success\");\r\n            node.removeClass(\"list-group-item-warning\");\r\n            node.removeClass(\"list-group-item-danger\");\r\n            node.removeClass(\"list-group-item-light\");\r\n            node.removeClass(\"list-group-item-dark\");\r\n\r\n            var badgeClass = \"btn-secondary\";\r\n\r\n            if (returned.code < 0) {\r\n                text = $.i18n(\"transit-eta-route-not-available-short\");\r\n                node.addClass(\"list-group-item-light\");\r\n            } else if (returned.feeds.length === 0) {\r\n                text = $.i18n(\"transit-eta-no-feed-received\");\r\n                node.addClass(\"list-group-item-light\");\r\n            } else {\r\n                var pairs = [];\r\n                for (var feed of returned.feeds) {\r\n                    for (var entity of feed.entity) {\r\n                        var tripUpdate = entity[\"tripUpdate\"];\r\n                        if (tripUpdate) {\r\n                            var timestamp = tripUpdate.timestamp ? tripUpdate.timestamp : feed.header.timestamp;\r\n                            pairs.push({\r\n                                timestamp: timestamp,\r\n                                tripUpdate: tripUpdate\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n                //TODO: Sort trip updates\r\n                /*\r\n                tripUpdates.sort((a, b) => {\r\n                    if (a[\"stop_time_update\"].departure && b[\"stop_time_update\"].departure) {\r\n                        return a[\"stop_time_update\"].departure - b[\"stop_time_update\"].departure;\r\n                    } else if (a[\"stop_time_update\"].arrival && b[\"stop_time_update\"].departure) {\r\n                        return a[\"stop_time_update\"].arrival - b[\"stop_time_update\"].departure;\r\n                    } else if (a[\"stop_time_update\"].departure && b[\"stop_time_update\"].arrival) {\r\n                        return a[\"stop_time_update\"].departure - b[\"stop_time_update\"].arrival;\r\n                    }\r\n                });\r\n                */\r\n                if (pairs.length === 0) {\r\n                    text = $.i18n(\"transit-eta-no-schedules-pending-short\");\r\n                    node.addClass(\"list-group-item-light\");\r\n                } else {\r\n                    var pair = pairs[0];\r\n\r\n                    var stopTimeUpdates = pair.tripUpdate[\"stopTimeUpdate\"];\r\n                    if (stopTimeUpdates && stopTimeUpdates.length > 0) {\r\n                        var stopTimeUpdate = stopTimeUpdates[0];\r\n\r\n                        if (!stopTimeUpdate[\"scheduleRelationship\"] || stopTimeUpdate[\"scheduleRelationship\"] === \"SCHEDULED\") {\r\n                            var etaTime;\r\n                            //TODO: Calculate non-absolute time from trips\r\n                            if (stopTimeUpdate.departure) {\r\n                                etaTime = stopTimeUpdate.departure.time;\r\n                            } else if (stopTimeUpdate.arrival) {\r\n                                etaTime = stopTimeUpdate.arrival.time;\r\n                            }\r\n\r\n                            //TODO: uncertainty\r\n\r\n                            var calcEta = Math.floor((etaTime - pair.timestamp) / 1000 / 60);\r\n\r\n                            var css = \"\";\r\n\r\n                            if (calcEta >= 20) {\r\n                                css = \"secondary\";\r\n                            } else if (calcEta >= 15) {\r\n                                css = \"info\";\r\n                            } else if (calcEta >= 10) {\r\n                                css = \"success\";\r\n                            } else if (calcEta >= 5) {\r\n                                css = \"warning\";\r\n                            } else if (calcEta >= 1) {\r\n                                css = \"danger\";\r\n                            } else {\r\n                                css = \"dark\";\r\n                            }\r\n                            node.addClass(\"list-group-item-\" + css);\r\n\r\n                            badgeClass = \"badge-primary\";\r\n                            if (calcEta > 0) {\r\n                                text += $.i18n(\"transit-eta-minutes\", calcEta);\r\n                            } else {\r\n                                text += $.i18n(\"transit-eta-arrived-left\", calcEta);\r\n                                badgeClass = \"badge-dark\";\r\n                            }\r\n                            /*\r\n                            if (schedule.msg !== undefined) {\r\n                                var msg = schedule.msg;\r\n                                if (msg.length > 20) {\r\n                                    text = $.i18n(\"transit-eta-transit-notice\");\r\n                                } else {\r\n                                    text = schedule.msg;\r\n                                }\r\n                                badgeClass = \"badge-warning\";\r\n                            } else if (schedule.time !== undefined) {\r\n                                if (schedule.msg !== undefined) {\r\n                                    text += \"<br />\";\r\n                                }\r\n\r\n                                if (schedule.isLive !== undefined) {\r\n                                    text += \"<br /><span style=\\\"font-size: 10px; position: absolute; top: 16px; right: 16px; \";\r\n                                    if (schedule.isLive) {\r\n                                        text += \"color: red;\\\"><i class=\\\"fa fa-circle\\\"></i> \" + $.i18n(\"transit-eta-live\") + \"</span>\";\r\n                                    } else {\r\n                                        text += \"color: black; font-style: italic;\\\">\" + $.i18n(\"transit-eta-scheduled\") + \"</span>\";\r\n                                    }\r\n                                }\r\n                            }\r\n                            */\r\n                        } else {\r\n                            //TODO: No data or skipped\r\n                            console.log(\"NODATA\");\r\n                        }\r\n                    } else {\r\n                        //TODO: Cancelled\r\n                        console.log(\"Cancelled\");\r\n                    }        \r\n                }\r\n            }\r\n\r\n            var badge = node.children(\".transit-eta\");\r\n\r\n            badge.removeClass(\"badge-primary\");\r\n            badge.removeClass(\"badge-secondary\");\r\n            badge.removeClass(\"badge-warning\");\r\n            badge.removeClass(\"badge-danger\");\r\n            badge.removeClass(\"badge-dark\");\r\n            badge.addClass(badgeClass);\r\n\r\n            badge.html(text);\r\n        }).catch(function (options, err) {\r\n            var node = $(\".nearby-route-list .route-selection[data-gtw-package=\\\"\" + options.agency[\"package\"] + \"\\\"][data-gtw-provider=\\\"\" + options.agency[\"provider\"] + \"\\\"][data-gtw-agency=\\\"\"  + options.agency[\"agency_id\"] + \"\\\"][data-gtw-route-id=\\\"\" + options.route[\"route_id\"] + \"\\\"][data-gtw-path-id=\\\"\" + options.trip[\"path_id\"] + \"\\\"][data-gtw-stop-id=\\\"\" + options.stop[\"stop_id\"] + \"\\\"]\");\r\n\r\n            node.removeClass(\"list-group-item-secondary\");\r\n            node.removeClass(\"list-group-item-info\");\r\n            node.removeClass(\"list-group-item-success\");\r\n            node.removeClass(\"list-group-item-warning\");\r\n            node.removeClass(\"list-group-item-danger\");\r\n            node.removeClass(\"list-group-item-light\");\r\n            node.removeClass(\"list-group-item-dark\");\r\n            node.addClass(\"list-group-item-light\");\r\n\r\n            var badge = node.children(\".transit-eta\");\r\n\r\n            badge.removeClass(\"badge-primary\");\r\n            badge.removeClass(\"badge-secondary\");\r\n            badge.removeClass(\"badge-warning\");\r\n            badge.removeClass(\"badge-danger\");\r\n            badge.removeClass(\"badge-dark\");\r\n            badge.addClass(\"badge-danger\");\r\n\r\n            badge.html($.i18n(\"transit-eta-error-fetching-eta-short\"));\r\n        });\r\n    }\r\n}\r\n\r\nasync function findNearbyRoutes() {\r\n    clearInterval(updateEtaTimer);\r\n\r\n    var pos = Loc.getCurrentPosition();\r\n\r\n    var lat = pos.lat;\r\n    var lng = pos.lng;\r\n\r\n    lastLat = lat;\r\n    lastLng = lng;\r\n\r\n    var range = Settings.get(\"min_nearby_transit_range\", 200) / 1000.0;\r\n    \r\n    var allNearbyStops = await gtfs.searchNearbyStops(lat, lng, range, true);\r\n\r\n    if (allNearbyStops.length === 0) {\r\n        var testRange = range;\r\n        do {\r\n            testRange += 0.05;\r\n            allNearbyStops = await gtfs.searchNearbyStops(lat, lng, testRange, true, true);\r\n        } while (allNearbyStops.length === 0 && testRange < 10);\r\n\r\n        if (testRange >= 10) {\r\n            $(\".tab-panel\").append(\r\n                \"<div class=\\\"alert alert-danger alert-dismissable\\\">\" +\r\n                \"<button type=\\\"button\\\" class=\\\"close\\\" data-dismiss=\\\"alert\\\" aria-hidden=\\\"true\\\" >&#215;</button>\" +\r\n                $.i18n(\"transit-eta-no-routes-found-10-km\") +\r\n                \"</div>\"\r\n            );\r\n        } else {\r\n            $(\".tab-panel\").append(\r\n                \"<div class=\\\"alert alert-warning alert-dismissable\\\">\" +\r\n                \"<button type=\\\"button\\\" class=\\\"close\\\" data-dismiss=\\\"alert\\\" aria-hidden=\\\"true\\\" >&#215;</button>\" +\r\n                $.i18n(\"transit-eta-no-routes-found-nearby-extended-range\", range * 1000, Math.ceil(testRange * 1000)) +\r\n                \"</div>\"\r\n            );\r\n        }\r\n    }\r\n\r\n    var maxNearbyBusDisplay = Settings.get(\"max_nearby_transit_to_display\", 20);\r\n    allNearbyRoutes = [];\r\n    console.log(allNearbyStops);\r\n\r\n    for (var stopResult of allNearbyStops) {\r\n        if (allNearbyRoutes.length >= maxNearbyBusDisplay) {\r\n            break;\r\n        }\r\n\r\n        var stop = stopResult.stop;\r\n\r\n        var pkg = stop[\"package\"];\r\n        var provider = stop[\"provider\"];\r\n\r\n        var stopRoutes = await gtfs.searchStopRoutes(pkg, provider, stop[\"stop_id\"]);\r\n\r\n        //TODO: seperate trips\r\n        for (var routeId in stopRoutes.trips) {\r\n            var trip = stopRoutes.trips[routeId];\r\n            var agency = await gtfs.getAgency(pkg, provider, stopRoutes.routes[routeId][\"agency_id\"]);\r\n            var path = await gtfs.getStopTimePathByPathId(pkg, provider, trip[\"path_id\"]);\r\n            allNearbyRoutes.push({\r\n                agency: agency,\r\n                route: stopRoutes.routes[routeId],\r\n                trip: trip,\r\n                stop: stop,\r\n                stopTime: stopRoutes.stopTimes[trip[\"path_id\"]],\r\n                path: path,\r\n                distance: stopResult.distance\r\n            });\r\n        }\r\n    }\r\n\r\n    console.log(allNearbyRoutes);\r\n\r\n    var distance;\r\n    //var paths;\r\n    //var stopId;\r\n\r\n    var stop;\r\n    var agency;\r\n    var html = \"<ul class=\\\"list-group\\\">\";\r\n    for (var result of allNearbyRoutes) {\r\n        //paths = result.route.paths[result.bound];\r\n        //stopId = paths[paths.length - 1];\r\n\r\n        distance = Math.round(result.distance * 1000);\r\n        agency = await gtfs.getAgency(result.route[\"package\"], result.route[\"provider\"], result.route[\"agency_id\"]);\r\n        stop = await gtfs.getStop(result.stopTime[\"package\"], result.stopTime[\"provider\"], result.stopTime[\"stop_id\"]);\r\n\r\n        html +=\r\n            \"    <li class=\\\"list-group-item list-group-item-action d-flex justify-content-between align-items-center route-selection\\\" data-gtw-package=\\\"\" + result.route[\"package\"] + \"\\\" data-gtw-provider=\\\"\" + result.route[\"provider\"] + \"\\\" data-gtw-agency=\\\"\" + result.route[\"agency_id\"] + \"\\\" data-gtw-route-id=\\\"\" + result.route[\"route_id\"] + \"\\\" data-gtw-path-id=\\\"\" + result.trip[\"path_id\"] + \"\\\" data-gtw-stop-id=\\\"\" + result.stopTime[\"stop_id\"] + \"\\\" data-gtw-stop-seq=\\\"\" + result.stopTime[\"stop_sequence\"] + \"\\\">\" +\r\n            \"        <div class=\\\"d-flex flex-column route-id\\\">\" +\r\n            \"            <div>\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</div>\" +\r\n            \"            <div>\" + Lang.localizedKey(result.route, \"route_short_name\") + \"</div>\" +\r\n            \"        </div>\" +\r\n            \"        <div class=\\\"d-flex flex-column stop-info mr-auto\\\">\" +\r\n            //\"            <div>\" + Lang.localizedKey(result.route, \"route_long_name\") + \"</div>\" +\r\n            //\"                <b>\" + $.i18n(\"transit-eta-to\") + \":</b> <small>\" + Lang.localizedKey(TransitStops.getStopById(stopId), \"stopName\") +\r\n            //\"</small></div>\" +\r\n            \"            <div>\" +\r\n            \"                \" + gtfs.selectAgencyStopName(agency[\"agency_id\"], Lang.localizedKey(stop, \"stop_name\")) + \" (\" + distance + $.i18n(\"transit-eta-metres\") + \")\" +\r\n            \"            </div>\" +\r\n            \"        </div>\" +\r\n            \"        <span class=\\\"badge badge-primary badge-pill transit-eta\\\">\" + $.i18n(\"transit-eta-retrieving\") + \"</span>\" +\r\n            \"    </li>\";\r\n    }\r\n    html += \"</ul>\";\r\n\r\n    $(\".nearby-route-list\").html(html);\r\n\r\n    $(\".nearby-route-list .route-selection\").on(\"mouseenter\", mouseEnterPreviewRoute);\r\n\r\n    $(\".nearby-route-list .route-selection\").on(\"mouseleave\", function () {\r\n        //Map.setCenter(Loc.getCurrentPosition());\r\n        //Map.setZoom(16);\r\n        //Map.removeAllMarkers();\r\n        //Map.removeAllPolylines();\r\n    });\r\n\r\n    $(\".nearby-route-list .route-selection\").on(\"click\", mouseClickSelectRoute);\r\n\r\n    filterProviderSort(\".nearby-route-list\");\r\n\r\n    updateEta();\r\n    updateEtaTimer = setInterval(updateEta, 30000);\r\n}\r\n\r\nfunction nearbyRoutesLocSuccess() {\r\n    var html =\r\n        \"<div class=\\\"d-flex justify-content-center w-100\\\">\" +\r\n        \"    <div class=\\\"text-center\\\">\" +\r\n        \"        <div class=\\\"spinner-grow m-5\\\" style=\\\"width: 3rem; height: 3rem;\\\"></div>\" +\r\n        \"        <div>\" + $.i18n(\"transit-searching-nearby-routes\") + \"</div>\" +\r\n        \"    </div>\" +\r\n        \"</div>\";\r\n    ;\r\n    $(\".nearby-route-list\").html(html);\r\n    findNearbyRoutes();\r\n}\r\n\r\nfunction nearbyRoutesLocError(error) {\r\n    var errorText;\r\n    console.log(error);\r\n    if (error.code === 1) {\r\n        errorText = $.i18n(\"location-error-user-denied-location\");\r\n    } else if (error.code === 2 || error.code === 3) {\r\n        errorText = $.i18n(\"location-error-could-not-get-location\");\r\n    } else {\r\n        errorText = $.i18n(\"location-error-unknown\", error.message);\r\n    }\r\n\r\n    var html =\r\n        \"<div class=\\\"d-flex justify-content-center w-100\\\">\" +\r\n        \"    <div class=\\\"text-center\\\">\" +\r\n        \"        <i class=\\\"fas fa-exclamation-triangle m-5\\\" style=\\\"width: 3rem; height: 3rem;\\\"></i>\" +\r\n        \"        <div class=\\\"ml-3 mr-3\\\">\" + errorText + \"</div>\" +\r\n        \"    </div>\" +\r\n        \"</div>\";\r\n    ;\r\n    $(\".nearby-route-list\").html(html);\r\n}\r\n\r\nexport async function enable() {\r\n    RequestLimiter.clear();\r\n    TransitEta.clearCache();\r\n\r\n    TouchKeypad.addListener(touchKeypadListener = function (obj) {\r\n        var searchText;\r\n        if ($(obj).hasClass(\"touch-keypad-function-done\")) {\r\n            hideTouchKeypad();\r\n            adjustMargin();\r\n        } else if ($(obj).hasClass(\"touch-keypad-function-backspace\")) {\r\n            searchText = $(\"#search-transit-text\").val();\r\n            $(\"#search-transit-text\").val(searchText.slice(0, -1));\r\n            searchRoutes();\r\n        } else if ($(obj).hasClass(\"touch-keypad-value\")) {\r\n            var val = $(obj).html();\r\n            searchText = $(\"#search-transit-text\").val();\r\n            $(\"#search-transit-text\").val(searchText + val);\r\n            searchRoutes();\r\n        }\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_UI_BACK, eventUiBackListener = function (){\r\n        if (searchMode) {\r\n            TouchKeypad.showTouchKeypad();\r\n        }\r\n        clearInterval(updateStopEtaTimer);\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_LOCATION_ERROR, eventLocErrorListener = function (error) {\r\n        nearbyRoutesLocError(error);\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_LOCATION_SUCCESS, eventLocSuccessListener = function () {\r\n        nearbyRoutesLocSuccess();\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_LOCATION_CHANGE, eventLocChgListener = function () {\r\n        if (lastLat && lastLng) {\r\n            var newLoc = Loc.getCurrentPosition();\r\n            var dst = Misc.geoDistance(newLoc.lat, newLoc.lng, lastLat, lastLng);\r\n            if (dst > 0.125) {\r\n                console.log(\"Location moved 125 m away. Finding new nearby routes.\");\r\n                findNearbyRoutes();\r\n            }\r\n        }\r\n    });\r\n\r\n    var agencies = await gtfs.getAgencies();\r\n\r\n    if (agencies.length > 0) {\r\n        var buttonScroll =\r\n            \"<div class=\\\"hori-scroll btn-group\\\">\" +\r\n            \"    <button type=\\\"button\\\" class=\\\"btn btn-primary gtw-providersort gtw-providersort-all\\\"><i class=\\\"fa fa-reply-all\\\"></i><br />\" + $.i18n(\"transit-eta-sort-all\") + \"</button>\";\r\n\r\n        for (var agency of agencies) {\r\n            var image = \"fa-bus\";\r\n            buttonScroll += \" <button type=\\\"button\\\" class=\\\"btn btn-default gtw-providersort gtw-providersort-provider\\\" data-gtw-package=\\\"\" + agency[\"package\"] + \"\\\" data-gtw-provider=\\\"\" + agency[\"provider\"] + \"\\\" data-gtw-agency=\\\"\" + agency[\"agency_id\"] + \"\\\"><i class=\\\"fa \" + image + \"\\\"></i><br />\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</button>\";\r\n        }\r\n\r\n        buttonScroll += \"</div>\";\r\n\r\n        $(\".tab-panel\").append(buttonScroll);\r\n\r\n        var searchField =\r\n            \"<div class=\\\"input-group mb-3\\\" style=\\\"margin-top: 16px;\\\">\" +\r\n            \"    <input type=\\\"text\\\" class=\\\"form-control\\\" placeholder=\\\"\" + $.i18n(\"transit-eta-placeholder-search-for-transit\") + \"\\\" aria-label=\\\"\" + $.i18n(\"transit-eta-placeholder-search-for-transit\") + \"\\\" aria-describedby=\\\"search-transit-icon\\\" id=\\\"search-transit-text\\\" readonly/>\" +\r\n            \"    <div class=\\\"input-group-append\\\">\" +\r\n            //\"        <span class=\\\"input-group-text\\\" id=\\\"search-transit-icon\\\"><i class=\\\"fas fa-search\\\"></i></span>\" +\r\n            \"        <button class=\\\"btn btn-light disabled\\\" type=\\\"button\\\" id=\\\"button-cancel-search\\\"><i class=\\\"fas fa-search\\\"></i></button>\" +\r\n            \"    </div>\" +\r\n            \"</div>\"\r\n            ;\r\n\r\n        $(\".tab-panel\").append(searchField);\r\n\r\n        var requestProgressBar =\r\n            \"<div class=\\\"request-progress-panel\\\">\" +\r\n            \"    <div class=\\\"progress bg-white\\\">\" +\r\n            \"        <div class=\\\"progress-bar progress-bar-striped progress-bar-animated\\\" role=\\\"progressbar\\\" style=\\\"width: 0%;\\\"></div>\" +\r\n            \"    </div>\" +\r\n            \"</div>\"\r\n            ;\r\n\r\n        $(\".tab-panel\").append(requestProgressBar);\r\n\r\n        $(\".gtw-providersort\").on(\"click\", function () {\r\n            if ($(this).hasClass(\"btn-primary\")) {\r\n                return;\r\n            }\r\n            //$(\".gtw-providersort\").removeClass(\"btn-default\");\r\n\r\n            if ($(this).hasClass(\"gtw-providersort-all\")) {\r\n                resetProviderSort();\r\n            } else {\r\n                $(\".gtw-providersort\").removeClass(\"btn-primary\");\r\n\r\n                var pkg = $(this).attr(\"data-gtw-package\");\r\n                var provider = $(this).attr(\"data-gtw-provider\");\r\n                var agency = $(this).attr(\"data-gtw-agency\");\r\n                $(this).addClass(\"btn-primary\");\r\n                \r\n                var cssCond = \"[data-gtw-package='\" + pkg + \"'][data-gtw-provider='\" + provider + \"'][data-gtw-agency='\" + agency + \"']\";\r\n\r\n                $(\".gtw-providersort-provider:not(\" + cssCond + \")\").addClass(\"btn-default\");\r\n                $(\".route-selection\" + cssCond).attr(\"style\", \"\");\r\n                $(\".route-selection:not(\" + cssCond + \")\").attr(\"style\", \"display: none!important\");\r\n            }\r\n        });\r\n\r\n        $(\"#button-cancel-search\").on(\"click\", function () {\r\n            if (!$(this).hasClass(\"disabled\")) {\r\n                clearSearch();\r\n            }\r\n        });\r\n\r\n        var useKeypad = true;\r\n        if (useKeypad) {\r\n            $(\"#search-transit-text\").on(\"click\", function () {\r\n                showTouchKeypad();\r\n                showSearchRoutes();\r\n            });\r\n        }\r\n\r\n        $(\"#search-transit-text\").on(\"input\", function () {\r\n            clearTimeout(searchTimeout);\r\n            searchTimeout = setTimeout(function () {\r\n                searchRoutes();\r\n            }, 500);\r\n        });\r\n\r\n        var contentHtml = \"<div class=\\\"row item-list nearby-route-list\\\"></div><div class=\\\"row item-list all-route-list\\\"></div>\";\r\n        $(\".content-panel-container\").html(contentHtml);\r\n\r\n        if (Loc.isErrored()) {\r\n            nearbyRoutesLocError(Loc.getError());\r\n        } else if (Loc.isLocated()) {\r\n            nearbyRoutesLocSuccess();\r\n        } else {\r\n            var html =\r\n                \"<div class=\\\"d-flex justify-content-center w-100\\\">\" +\r\n                \"    <div class=\\\"text-center\\\">\" +\r\n                \"        <div class=\\\"spinner-grow m-5\\\" style=\\\"width: 3rem; height: 3rem;\\\"></div>\" +\r\n                \"        <div>\" + $.i18n(\"transit-locating-your-location\") + \"</div>\" +\r\n                \"    </div>\" +\r\n                \"</div>\";\r\n            ;\r\n            $(\".nearby-route-list\").html(html);\r\n        }\r\n    } else {\r\n        //TODO: better message or auto add plugins according to region\r\n        $(\".tab-panel\").html(\"<br /><div class=\\\"alert alert-danger\\\" role=\\\"alert\\\"><i class=\\\"fas fa-exclamation-triangle\\\"></i> \" + $.i18n(\"transit-eta-no-plugins-providing-transit-data\") + \"</div>\");\r\n    }\r\n}\r\n\r\nexport function disable() {\r\n    TouchKeypad.removeListener(touchKeypadListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_UI_BACK, eventUiBackListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_LOCATION_ERROR, eventLocErrorListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_LOCATION_SUCCESS, eventLocSuccessListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_LOCATION_CHANGE, eventLocChgListener);\r\n    clearTimeout(searchTimeout);\r\n    clearInterval(updateEtaTimer);\r\n    clearInterval(updateStopEtaTimer);\r\n    searchTimeout = false;\r\n    updateEtaTimer = false;\r\n}","var onClickListeners = [];\r\n\r\n$(\".touch-keypad-function-done\").on(\"click\", mouseClickTouchKeypadValue);\r\n$(\".touch-keypad-function-backspace\").on(\"click\", mouseClickTouchKeypadValue);\r\n$(\".touch-keypad-value\").on(\"click\", mouseClickTouchKeypadValue);\r\n\r\nfunction mouseClickTouchKeypadValue() {\r\n    $(this).blur();\r\n    if ($(this).hasClass(\"disabled\")) {\r\n        return;\r\n    }\r\n    for (var listener of onClickListeners) {\r\n        listener(this);\r\n    }\r\n}\r\n\r\nexport function reset() {\r\n    $(\".numeric-keypad .touch-keypad-value\").each(function () {\r\n        $(this).removeClass(\"disabled\");\r\n        $(this).removeClass(\"btn-secondary\");\r\n        $(this).addClass(\"btn-outline-secondary\");\r\n    });\r\n}\r\n\r\nexport function showTouchKeypad() {\r\n    $(\".touch-keypad\").css(\"display\", \"flex\");\r\n    adjustMargin();\r\n}\r\n\r\nexport function hideTouchKeypad() {\r\n    $(\".touch-keypad\").css(\"display\", \"\");\r\n    adjustMargin();\r\n}\r\n\r\nexport function addListener(listener) {\r\n    if (typeof listener !== \"function\") {\r\n        return false;\r\n    }\r\n    onClickListeners.push(listener);\r\n    return true;\r\n}\r\n\r\nexport function removeListener(listener) {\r\n    if (typeof listener !== \"function\") {\r\n        return false;\r\n    }\r\n    var index = onClickListeners.indexOf(listener);\r\n    if (index !== -1) {\r\n        onClickListeners.splice(index, 1);\r\n        return true;\r\n    }\r\n    return false;\r\n}\r\n\r\nexport function enableFunctionKeys() {\r\n    $(\".touch-keypad-function\").removeClass(\"disabled\");\r\n}\r\n\r\nexport function disableFunctionKeys() {\r\n    $(\".touch-keypad-function\").addClass(\"disabled\");\r\n}\r\n\r\nexport function setEnabled(keyMap) {\r\n    $(\".numeric-keypad .touch-keypad-value\").each(function () {\r\n        var val = $(this).html();\r\n        if (!keyMap[val]) {\r\n            $(this).addClass(\"disabled\");\r\n            $(this).addClass(\"btn-secondary\");\r\n            $(this).removeClass(\"btn-outline-secondary\");\r\n        } else {\r\n            $(this).removeClass(\"disabled\");\r\n            $(this).removeClass(\"btn-secondary\");\r\n            $(this).addClass(\"btn-outline-secondary\");\r\n        }\r\n        delete keyMap[val];\r\n    });\r\n\r\n    var keys = Object.keys(keyMap);\r\n    keys.sort(function (a, b) {\r\n        return a.charCodeAt(0) - b.charCodeAt(0);\r\n    });\r\n\r\n    var letterKeypadHtml = \"\";\r\n    for (var key of keys) {\r\n        letterKeypadHtml += \"<button type=\\\"button\\\" class=\\\"btn btn-outline-secondary py-3 touch-keypad-key touch-keypad-value\\\">\" + key + \"</button>\";\r\n    }\r\n    $(\".letter-keypad\").html(letterKeypadHtml);\r\n\r\n    $(\".letter-keypad .touch-keypad-value\").on(\"click\", mouseClickTouchKeypadValue);\r\n}"],"sourceRoot":""}