(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{204:function(t,e,r){"use strict";r.r(e),function(t){r.d(e,"onload",(function(){return i}));var n=r(33),o=r(22),a=r(7),s=r(32);function i(){return o.register("db.hktransit.ml",!0),o.register("rt.data.gov.hk",!0),n.registerProvider("gtwp-ctbnwfb","ctbnwfb",["CTB","NWFB"],new c),!0}var c=function(){this.checkDatabaseUpdate=function(e,r,n){t.ajax({url:"https://db.hktransit.ml/ctbnwfb_db-version.json",cache:!1,dataType:"json",success:function(t){var r,o;try{r=parseInt(t.version),o=parseInt(n)}catch(t){console.error("Error: Could not parse ctbnwfb_db last updated time or cached version! Forcing to be no update"),e(!1)}e(r>o)},error:function(t){console.error("Error: Could not check ctbnwfb_db update!"),e(!1)}})},this.getRefStopId=function(t){(t=t.toUpperCase()).split("/");for(var e of this.db.stops)if(t.includes(e.stopName.toUpperCase()))return e.stopId;return!1},this.fetchEta=function(e,r,n){var o=n.agency.agency_id,i=!1;if(o.includes("+")){i=!0;var c=o.split("+");for(var p of c)if("CTB"===p||"NWFB"===p){o=p;break}}if("CTB"!==o&&"NWFB"!==o)return console.error("Error: Cannot request ETA from companies that are not CTB and NWFB! Requested: "+o),void r();a.e("gtwp-hktransit","hktransit",o).then(c=>{var p=n.stop.stop_id,d=a.t(o,n.stop.stop_name),u=this.getRefStopId(d);if(!u)return console.error("Error: Could not find CTBNWFB reference stop ID using "+d),void r();var h="https://rt.data.gov.hk/v1/transport/citybus-nwfb/eta/"+o+"/"+u+"/"+n.route.route_short_name;t.ajax({url:h,method:"GET",dataType:"json",cache:!1,success:function(t){var r,o,a,d,u=[],h=[],f=[],l={tripId:n.trip.trip_id,startTime:"00:00:00",startDate:"20190101"},b=t.data;if(b.length>0)for(m=0;m<b.length;m++)if((o=b[m]).eta&&""!==o.eta&&(a=o.eta,d=void 0,d=a.split(/[: T-]/).map(parseFloat),r=new Date(d[0],d[1]-1,d[2],d[3]||0,d[4]||0,d[5]||0,0),h.push({stopId:p,arrival:{time:r.getTime()}})),o.rmk_en&&""!==o.rmk_en||o.rmk_tc&&""!==o.rmk_tc||o.rmk_sc&&""!==o.rmk_sc){var g=[{text:o.rmk_en,language:"en"},{text:o.rmk_tc,language:"zh-HK"},{text:o.rmk_sc,language:"zh-CN"}];f.push({informedEntity:[{trip:l,stopId:p}],headerText:{translation:g},descriptionText:{translation:g}})}var m,_=Date.now();if(h.length>0){var v={label:s.localizedKey(c,"agency_short_name")},w={id:n.agency.agency_id+"-"+n.stop.stop_id+"-"+n.route.route_short_name+"-trip-update-"+_,tripUpdate:{trip:l,stopTimeUpdate:h}};i&&(w.vehicle={vehicle:v}),u.push(w)}if(f.length>0)for(m=0;m<f.length;m++){w={id:n.agency.agency_id+"-"+n.stop.stop_id+"-"+n.route.route_short_name+"-alert-"+m+"-"+_,alert:f[m]};u.push(w)}e({header:{gtfsRealtimeVersion:"2.0",incrementality:"FULL_DATASET",timestamp:_},entity:u})},error:function(t,e,n){r()}})})},this.fetchDatabase=function(e,r){t.ajax({url:"https://db.hktransit.ml/ctbnwfb_db.json",cache:!1,dataType:"json",success:function(t){t.routes&&t.stops&&t.version?(t.package="gtwp-ctbnwfb",t.provider="ctbnwfb",e(t)):console.error("Error: CTBNWFB downloaded database is in wrong structure! Report to GitHub for this problem!")},error:function(t,e,n){r()}})}}}.call(this,r(0))}}]);
//# sourceMappingURL=47.47e51ded0a525202df28.js.map