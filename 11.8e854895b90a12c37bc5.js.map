{"version":3,"sources":["webpack:///./src/gtw-ui-tab-transit.js"],"names":["searchTimeout","updateStopEtaTimer","updateEtaTimer","allNearbyRoutes","maxRequest","touchKeypadListener","eventUiBackListener","eventLocChgListener","eventLocSuccessListener","eventLocErrorListener","lastLat","lastLng","searchMode","hideTouchKeypad","filterProviderSort","listNodeCss","$","each","pkg","this","attr","provider","agency","length","css","GTFS_CALENDAR_IDS","GTFS_CALENDAR_NAMES","JS_WEEKDAY_NAMES","combineCalendars","calendars","i","j","out","describeCalendar","calendar","onlyDates","i18n","text","substr","realtimeShown","__cachedFirstLetters","async","searchRoutes","overlayFadeInTimeout","setTimeout","fadeIn","firstLetters","val","st","html","Date","now","console","log","k","key","routeName","trips","trip","route","routeId","lastStop","lastStopId","stopTimes","result","serviceId","serviceIds","pathId","pathIds","agencyId","xst","fetchedAgency","fetchedTripsByRouteId","fetchedStopTimePaths","fetchedStops","beforeLoopTime","beforeLoopCount","afterLoopTime","afterLoopCount","str","includes","push","pathCalendars","hasBadgeBefore","calendarText","availableKeypads","firstLetter","on","mouseEnterPreviewRoute","mouseClickSelectRoute","clearTimeout","fadeOut","adjustMargin","resetProviderSort","removeClass","addClass","clearSearch","stopId","pathStop","distance","pos","nearestDistance","nearestStop","stopTime","lat","lng","scroll","draw","obj","tripId","exist","lastStopTime","freqByService","freq","freqs","savedFreq","stop","calendarDesc","tabs","tabContent","date","isCurrentService","hasCurrent","currentService","getDay","active","current","min","Math","round","routeListSelectStop","thisId","parent","index","lastIndexOf","newStr","con","children","elId","startsWith","scrollIntoView","coords","title","label","drawTripOnMap","showRouteList","warn","screen","width","node","notNode","icon","notIcon","scrollNode","undefined","targetPos","showingStopEta","content","tableNode","currFreq","len","time","getHours","getMinutes","showGtfsStaticFrequencies","clearInterval","func","updatingStopEta","returned","etaProviders","split","remove","opt","options","code","append","feeds","alerts","pairs","feed","entity","tripUpdate","timestamp","header","alertsHtml","headerText","prepend","pair","stopTimeUpdates","stopTimeUpdate","etaTime","departure","arrival","eta","floor","updateStopEta","setInterval","showStopEta","updateEta","requestLen","max","path","then","badgeClass","calcEta","badge","catch","err","findNearbyRoutes","range","allNearbyStops","testRange","ceil","maxNearbyBusDisplay","stopResult","stopRoutes","routes","sort","a","b","nearbyRoutesLocSuccess","nearbyRoutesLocError","error","message","enable","searchText","hasClass","slice","EVENT_UI_BACK","EVENT_LOCATION_ERROR","EVENT_LOCATION_SUCCESS","EVENT_LOCATION_CHANGE","newLoc","agencies","buttonScroll","searchField","cssCond","disable"],"mappings":"2FAAA,2GAcIA,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EAvBJ,mFAwBIC,GAAU,EACVC,GAAU,EACVC,GAAa,EAOjB,SAASC,IAEL,MA2CJ,SAASC,EAAmBC,GACxBC,EAAE,8BAA8BC,MAAK,WACjC,IAAIC,EAAMF,EAAEG,MAAMC,KAAK,oBACnBC,EAAWL,EAAEG,MAAMC,KAAK,qBACxBE,EAASN,EAAEG,MAAMC,KAAK,mBAIZJ,EAAED,EAAc,qBAFhB,sBAAwBG,EAAM,yBAA2BG,EAAW,uBAAyBC,EAAS,OAElDC,OAAS,EAEvEP,EAAEG,MAAMK,IAAI,UAAW,IAEvBR,EAAEG,MAAMK,IAAI,UAAW,WAKnC,IAAIC,EAAoB,CACpB,SACA,UACA,YACA,WACA,SACA,WACA,UAGAC,EAAsB,CACtB,SACA,UACA,YACA,WACA,SACA,WACA,UAGAC,EAAmB,CACnB,SACA,SACA,UACA,YACA,WACA,SACA,YAGJ,SAASC,EAAiBC,GACtB,IACIC,EAIAC,EALAC,EAAM,GAEV,IAAKF,EAAI,EAAGA,EAAIL,EAAkBF,OAAQO,IACtCE,EAAIP,EAAkBK,IAAM,EAGhC,IAAKA,EAAI,EAAGA,EAAID,EAAUN,OAAQO,IAC9B,IAAKC,EAAI,EAAGA,EAAIN,EAAkBF,OAAQQ,IACtCC,EAAIP,EAAkBM,KAAOF,EAAUC,GAAGL,EAAkBM,IAGpE,OAAOC,EAGX,SAASC,EAAiBC,EAAUC,GAAY,GAC5C,GAAID,EAAiB,QACjBA,EAAkB,SAClBA,EAAoB,WACpBA,EAAmB,UACnBA,EAAiB,QACjBA,EAAmB,UACnBA,EAAiB,OACjB,QAAIC,GACOnB,EAAEoB,KAAK,gDAIf,GAAIF,EAAiB,QACxBA,EAAkB,SAClBA,EAAoB,WACpBA,EAAmB,UACnBA,EAAiB,QACjBA,EAAmB,SACnB,OAAOlB,EAAEoB,KAAK,4CAA8CD,EAAY,SAAW,KAChF,GAAID,EAAiB,QACxBA,EAAkB,SAClBA,EAAoB,WACpBA,EAAmB,UACnBA,EAAiB,OACjB,OAAOlB,EAAEoB,KAAK,0CAA4CD,EAAY,SAAW,KAC9E,GAAID,EAAiB,QACxBA,EAAkB,SAClBA,EAAoB,WACpBA,EAAmB,SACnB,OAAOlB,EAAEoB,KAAK,4CAA8CD,EAAY,SAAW,KAChF,GAAID,EAAmB,UAC1BA,EAAiB,OACjB,OAAOlB,EAAEoB,KAAK,4CAA8CD,EAAY,SAAW,KAChF,GAAID,EAAmB,SAC1B,OAAOlB,EAAEoB,KAAK,gCAAkCD,EAAY,SAAW,KACpE,GAAID,EAAiB,OACxB,OAAOlB,EAAEoB,KAAK,8BAAgCD,EAAY,SAAW,KAEzE,IACIL,EADAO,EAAO,GAGX,IAAKP,EAAI,EAAGA,EAAIL,EAAkBF,OAAQO,IAGlCO,GAFEH,EAAST,EAAkBK,IAErBJ,EAAoBI,GAAGQ,OAAO,EAAG,GAEjC,IAGhB,OAAOD,EAGX,IAipBIE,EAjpBAC,GAAuB,EAE3BC,eAAeC,IACX,IAAIC,EAAuBC,YAAW,WAClC5B,EAAE,oBAAoB6B,OAAO,OAC9B,KACH,IAAuB,IACvB,MAEA,IAQIC,EARAC,EAAM/B,EAAE,wBAAwB+B,MAUpC,IAEIC,EAFAC,EAAO,0BAIX,GADAD,EAAKE,KAAKC,MACS,IAAfJ,EAAIxB,OACJ6B,QAAQC,IAAI,gBACPb,EAIDM,EAAeN,GAHfM,QAAqB,IAAsBC,EAAIxB,OAAQ,GAAG,GAC1DiB,EAAuBM,GAI3BM,QAAQC,IAAI,SAAWH,KAAKC,MAAQH,GAAM,OAC1CA,EAAKE,KAAKC,UACP,CACHC,QAAQC,IAAI,UACZ,IAIIvB,EACAC,EACAuB,EAEAC,EACAC,EACAC,EACAC,EACAC,EACArC,EAEAsC,EACAC,EACAC,EACAC,EAlBAC,QAAe,IAAkBjB,GACrCK,QAAQC,IAAI,SAAWH,KAAKC,MAAQH,GAAM,OAC1CA,EAAKE,KAAKC,MAkBV,IAEIc,EACAC,EACAC,EACAC,EAGAlD,EACAG,EACAgD,EAVAxC,EAAY,GAMhBiB,EAAe,GASf,IAaIwB,EAXAC,EAAgB,GAChBC,EAAwB,GACxBC,EAAuB,GACvBC,EAAe,GAEfC,EAAiB,EACjBC,EAAkB,EAElBC,EAAgB,EAChBC,EAAiB,EAIrB,IAAKhD,EAAI,EAAGA,EAAIkC,EAAOzC,OAAQO,IAAK,CAShC,GARAwC,EAAMpB,KAAKC,MAEXS,GADAD,EAAQK,EAAOlC,IACW,SAC1B0B,EAAY,eAAkBG,EAAO,oBACrCzC,EAAMyC,EAAe,QACrBtC,EAAWsC,EAAgB,SAC3BU,EAAWV,EAAiB,UAExBZ,EAAIxB,OAASiC,EAAUjC,OAAQ,CAC/B,IAAIwD,EAAMvB,EAAUlB,OAAOS,EAAIxB,OAAQ,GAClCuB,EAAakC,SAASD,IACvBjC,EAAamC,KAAKF,GAmB1B,IAXIzD,EAHCiD,GADLhB,EAAMrC,EAAM,IAAMG,EAAW,KACJgD,GAGZE,EAAchB,EAAMc,GAFpBE,EAAchB,EAAMc,SAAkB,IAAenD,EAAKG,EAAUgD,GAQ7EZ,EAHCe,EAAsBjB,EAAMK,GAGrBY,EAAsBjB,EAAMK,GAF5BY,EAAsBjB,EAAMK,SAAiB,IAAuB1C,EAAKG,EAAUuC,GAK/FQ,EAAU,GACVF,EAAa,GACRnC,EAAI,EAAGA,EAAI0B,EAAMlC,OAAQQ,IAE1BoC,GADAT,EAAOD,EAAM1B,IACU,QACvBkC,EAAYP,EAAiB,WACxBU,EAAQY,SAASb,IAClBC,EAAQa,KAAKd,GAEZD,EAAWc,SAASf,IACrBC,EAAWe,KAAKhB,GAMxB,IAHAU,GAAkBzB,KAAKC,MAAQmB,EAC/BM,IAEK7C,EAAI,EAAGA,EAAIqC,EAAQ7C,OAAQQ,IAAK,CACjCuC,EAAMpB,KAAKC,MACXgB,EAASC,EAAQrC,GAEjBkB,GACI,mHAAwH/B,EAAM,wBAA4BG,EAAW,sBAA0BgD,EAAW,wBAA4BV,EAAgB,SAAI,uBAA2BQ,EAAS,+DAE5Q,eAAkB7C,EAAQ,qBAAuB,sBACjDkC,EAAY,yEAc9BK,EAHCa,EAAanB,GADlBO,GAHIC,EAHCU,EAAqBlB,EAAMY,GAGhBM,EAAqBlB,EAAMY,GAF3BM,EAAqBlB,EAAMY,SAAgB,IAA6BjD,EAAKG,EAAU8C,IAKhFJ,EAAUxC,OAAS,GAAY,UAIvCmD,EAAanB,EAAMO,GAFnBY,EAAanB,EAAMO,SAAoB,IAAa5C,EAAKG,EAAUyC,GAKlFb,GAAQ,mBAAqBjC,EAAEoB,KAAK,kBAAoB,SAAW,IAA0Bd,EAAkB,UAAG,eAAkBuC,EAAU,cAAgB,SAE9J,IAAIqB,EAAgB,GACpB,IAAK5B,EAAI,EAAGA,EAAIY,EAAW3C,OAAQ+B,IAG1BzB,EAFLoC,EAAYC,EAAWZ,MAGnBzB,EAAUoC,SAAmB,IAAiB/C,EAAKG,EAAU4C,IAEjEiB,EAAcD,KAAKpD,EAAUoC,IAGjChB,GAAQ,QAGR,IAAIkC,GAAiB,EAEjBpB,EAAU,GAAY,UAAMF,EAAkB,UAC9CsB,GAAiB,EACjBlC,GACI,uCACAjC,EAAEoB,KAAK,yBACP,WAKR,IAAIgD,EAAenD,EADRL,EAAiBsD,IAExBE,IACID,IACAlC,GAAQ,IACRkC,GAAiB,GAErBlC,GACI,uCACAmC,EACA,WAGRnC,GACI,gCAGJ4B,GAAiB3B,KAAKC,MAAQmB,EAC9BQ,MAIZ1B,QAAQC,IAAI,SAAWH,KAAKC,MAAQH,GAAM,OAC1CI,QAAQC,IAAI,kBAAoBsB,EAAiBC,EAAkB,QAAUA,EAAkB,WAC/FxB,QAAQC,IAAI,iBAAmBwB,EAAgBC,EAAiB,QAAUA,EAAiB,WAC3F9B,EAAKE,KAAKC,MAEVF,GAAQ,QACRjC,EAAE,mBAAmBiC,KAAKA,GAE1BG,QAAQC,IAAIP,GACZ,IAAIuC,EAAmB,GACvB,IAAK,IAAIC,KAAexC,EACpBuC,EAAiBC,IAAe,EAEpClC,QAAQC,IAAIgC,GACZ,IAAuBA,GACvB,MAEArE,EAAE,oCAAoCuE,GAAG,aAAcC,GACvDxE,EAAE,oCAAoCuE,GAAG,QAASE,GAIlD3E,EAAmB,mBAEnB4E,aAAa/C,GACb3B,EAAE,oBAAoB2E,QAAQ,KAC9BC,eACAxC,QAAQC,IAAI,SAAWH,KAAKC,MAAQH,GAAM,OAG9C,SAAS6C,IACL7E,EAAE,qBAAqB8E,YAAY,eACnC9E,EAAE,yBAAyB+E,SAAS,eAGpC/E,EAAE,oBAAoBI,KAAK,QAAS,IAGxC,SAAS4E,IACLhF,EAAE,mBAAmBiC,KAAK,IAC1BpC,IACAG,EAAE,wBAAwB+B,IAAI,IA1X9BnC,GAAa,EAEbI,EAAE,yBAAyB+E,SAAS,aACpC/E,EAAE,yBAAyB+E,SAAS,YACpC/E,EAAE,yBAAyB8E,YAAY,cACvC9E,EAAE,yBAAyBiC,KAAK,iCAEhCjC,EAAE,sBAAsBQ,IAAI,UAAW,QACvCR,EAAE,mBAAmBQ,IAAI,UAAW,QAEpC,IAAc,OACd,IAAY,IACZ,MACA,MAEAqE,IACA/E,EAAmB,sBA4WnB,MAoBJ2B,eAAegD,IAGX,IAAIvE,EAAMF,EAAEG,MAAMC,KAAK,oBACnBC,EAAWL,EAAEG,MAAMC,KAAK,qBACxBE,EAASN,EAAEG,MAAMC,KAAK,mBACtBwC,EAAU5C,EAAEG,MAAMC,KAAK,qBACvB+C,EAASnD,EAAEG,MAAMC,KAAK,oBACtB6E,EAASjF,EAAEG,MAAMC,KAAK,oBAEtB2C,QAAkB,IAA6B7C,EAAKG,EAAU8C,GAElE,IAAK8B,GAAU,MAAiB,CAC5B,IAEIC,EACAC,EAHAC,EAAM,MAINC,GAAkB,EAClBC,GAAc,EAClB,IAAK,IAAIC,KAAYxC,EACjBmC,QAAiB,IAAahF,EAAKG,EAAUkF,EAAkB,SAC/DJ,EAAW,IAAiBD,EAAmB,SAAGA,EAAmB,SAAGE,EAAII,IAAKJ,EAAIK,OAChFJ,IAAoBC,GAAeH,EAAWE,KAC/CA,EAAkBF,EAClBG,EAAcJ,GAItB9C,QAAQC,IAAIgD,GACRA,GAAmB,IACnBJ,EAASK,EAAqB,SAItC,IAAI3D,EAAuBC,YAAW,WAClC5B,EAAE,oBAAoB6B,OAAO,OAC9B,KACH,MACA,YAyCJJ,eAA6BvB,EAAKG,EAAUgD,EAAUT,EAASO,EAAQ8B,EAAQS,GAAS,EAAOC,GAAO,GAClG,IAQIC,EAEAC,EAEAC,EAZA/C,QAAkB,IAA6B7C,EAAKG,EAAU8C,GAC9DR,QAAc,IAAczC,EAAKG,EAAUuC,GAC3CtC,QAAe,IAAeJ,EAAKG,EAAUgD,GAC7C0C,EAAehD,EAAUA,EAAUxC,OAAS,GAC5CsC,QAAiB,IAAa3C,EAAKG,EAAU0F,EAAsB,SACnEtD,QAAc,IAAuBvC,EAAKG,EAAUuC,GAEpDoD,EAAgB,GAMpB,IAAKlF,EAAI,EAAGA,EAAI2B,EAAMlC,OAAQO,IAC1B,GAAIqC,IAAWV,EAAM3B,GAAY,QAcjC,IAAK,IAAImF,KAVTJ,EAASpD,EAAM3B,GAAY,QAC3BmC,EAAYR,EAAM3B,GAAe,WAC5BkF,EAAc/C,KACf+C,EAAc/C,GAAa,CACvB/B,eAAgB,IAAiBhB,EAAKG,EAAU4C,GAChDiD,MAAO,KAGfN,EAAMI,EAAc/C,SACN,IAAoB/C,EAAKG,EAAUwF,IACzB,CAEpB,IAAK,IAAIM,KADTL,GAAQ,EACcF,EAAIM,OACtB,GAAIC,EAAsB,aAAMF,EAAiB,YAC7CE,EAAoB,WAAMF,EAAe,UACzCE,EAAwB,eAAMF,EAAmB,aAAG,CACpDH,GAAQ,EACR,MAGHA,GACDF,EAAIM,MAAMjC,KAAKgC,GAO3B,IAAIhE,EACA,0JAEkB,eAAkB3B,EAAQ,qBAAuB,sBACjD,eAAkBqC,EAAO,oBAAsB,yFAG5C3C,EAAEoB,KAAK,kBAAoB,SAAW,IAA0BiC,EAAU,eAAkBR,EAAU,cAAgB,cAE3IsB,GAAiB,EAEjBpB,EAAU,GAAY,UAAMF,EAAkB,UAC9CsB,GAAiB,EACjBlC,GACI,uCACAjC,EAAEoB,KAAK,yBACP,WAIR,IAAI8C,EAAgB,GACpB,IAAK,IAAIjB,KAAa+C,EAClB9B,EAAcD,KAAK+B,EAAc/C,GAAW/B,UAGhD,IAuCIkF,EAtCAhC,EAAenD,EADJL,EAAiBsD,IAE5BE,IACID,IACAlC,GAAQ,IACRkC,GAAiB,GAErBlC,GACI,uCACAmC,EACA,WA8BR,IA1BAnC,GACI,6RAG8KjC,EAAEoB,KAAK,gCAAkC,0MAGnCpB,EAAEoB,KAAK,+BAAiC,4NAGtBpB,EAAEoB,KAAK,kCAAoC,qBAIrPpB,EAAE,wBAAwBiC,KAAKA,GAI/BA,EACI,oQAOCnB,EAAI,EAAGA,EAAIiC,EAAUxC,OAAQO,IAE9BsF,QAAa,IAAalG,EAAKG,EAAU0C,EAAUjC,GAAY,SAC/DmB,GACI,qDAA0D/B,EAAM,wBAA4BG,EAAW,sBAA0BgD,EAAW,wBAA4BT,EAAU,uBAA2BO,EAAS,uBAA2BiD,EAAc,QAAI,oGAGjPtF,EAAI,GACtB,0IAE+FZ,EAAM,wBAA4BG,EAAW,sBAA0BgD,EAAW,wBAA4BT,EAAU,uBAA2BO,EAAS,uBAA2BiD,EAAc,QAAI,6BAAiCrD,EAAUjC,GAAkB,cAAI,0BAA8BA,EAAI,KAAQ,IAA0BuC,EAAU,eAAkB+C,EAAM,cAAgB,4FAOvenE,GACI,uJAOJ,IAEIoE,EAFAC,EAAO,4EACPC,EAAa,qDAGbC,EAAO,IAAItE,KACXuE,EAAmB,GACnBC,GAAa,EACjB,IAAK,IAAIzD,KAAa+C,EAAe,CACjC,IAAIW,EAAwF,IAAvEX,EAAc/C,GAAW/B,SAASP,EAAiB6F,EAAKI,WAC7EH,EAAiBxD,GAAa0D,EAC9BD,GAAcC,EAGlB,IAAI7F,EAAI,EACR,IAAK,IAAImC,KAAa+C,EAAe,CAIjC,IAAIa,EACAC,EA0BJ,GA9BAlB,EAAMI,EAAc/C,GACpBoD,EAAepF,EAAiB2E,EAAI1E,UAAU,GAI1CwF,GACAI,EAAUL,EAAiBxD,GAC3B4D,EAASC,IAETA,GAAU,EACVD,EAAe,IAAN/F,GAGbwF,GACI,+CAC6BO,EAAS,UAAY,IAAM,kBAAsB5D,EAAY,4CAAkDA,EAAY,wCAA8CA,EAAY,qBAAyB4D,EAAS,OAAS,SAAW,MAASC,EAAU,yCAA6C,IAAMT,EAAe,YAGjWE,GACI,6BAAgCM,EAAS,eAAiB,IAAM,kBAAsB5D,EAAY,+CAAqDA,EAAY,+HAIjH6D,GAAWJ,EAAa,IAAM,KAAO,KAAQ1G,EAAEoB,KAAK,oCAAsC,wCACrGpB,EAAEoB,KAAK,uCAAyC,wDAI3FN,IAEI8E,EAAIM,MAAM3F,OAAS,EACnB,IAAK,IAAI0F,KAAQL,EAAIM,MAAO,CACxB,IAAIa,EAAMC,KAAKC,MAAMhB,EAAmB,aAAI,IAC5CM,GACI,mBAEAO,GAAWJ,IACP,IAAwBT,GACxBM,GACI,iEAEJA,GACI,6BAIZA,GACI,uBAAyBN,EAAiB,WAAI,sDAErBA,EAAe,SAAI,4BACnBc,EAAM,8BAIvCR,GACI,mCAAuCvG,EAAEoB,KAAK,4BAA8B,yBAIpFmF,GACI,qCAMRtE,IAFAqE,GAAQ,SAGGC,EACP,6HAKJtE,GACI,eAGJjC,EAAE,wBAAwBiC,KAAKA,GAE/BjC,EAAE,+BAA+BuE,GAAG,SAAS,WACzC,IAAIrE,EAAMF,EAAEG,MAAMC,KAAK,oBACnBC,EAAWL,EAAEG,MAAMC,KAAK,qBACxBiD,EAAWrD,EAAEG,MAAMC,KAAK,mBACxBwC,EAAU5C,EAAEG,MAAMC,KAAK,qBACvB+C,EAASnD,EAAEG,MAAMC,KAAK,oBACtB6E,EAASjF,EAAEG,MAAMC,KAAK,oBAC1B8G,EAAoBhH,EAAKG,EAAUgD,EAAUT,EAASO,EAAQJ,EAAWkC,MAI7EjF,EAAE,0CAA0CuE,GAAG,SAAS,WACpD,IAAI4C,EAASnH,EAAEG,MAAMiH,SAASA,SAAShH,KAAK,MACxCiH,EAAQF,EAAOG,YAAY,QAC3BC,EAASJ,EAAO7F,OAAO,EAAG+F,GAAS,cACnCG,EAAMxH,EAAEG,MAAMC,KAAK,iBACvBJ,EAAE,oBAAsBuH,EAAS,MAAME,SAAS,aAAaxH,MAAK,WAC9D,IAAIyH,EAAO1H,EAAEG,MAAMC,KAAK,MACpBsH,IAASF,GACTxH,EAAEG,MAAM2E,YAAY,QACpB9E,EAAEG,MAAM2E,YAAY,YAEpB9E,EAAEG,MAAM4E,SAAS,QACjB/E,EAAEG,MAAM4E,SAAS,UACZ2C,EAAKC,WAAW,cACjB3H,EAAEG,MAAM,GAAGyH,wBAMvBjC,SAtWRlE,eAA6BsB,GACzB,IACIqC,EACAgB,EACAtF,EAHA+G,EAAS,GAIb,IAAK/G,EAAI,EAAGA,EAAIiC,EAAUxC,OAAQO,IAE9BsE,EAAM,CAAEI,KADRY,QAAa,IAAarD,EAAUjC,GAAY,QAAGiC,EAAUjC,GAAa,SAAGiC,EAAUjC,GAAY,UACvE,SAAG2E,IAAKW,EAAe,UACnDyB,EAAO5D,KAAKmB,GACZ,IAAcA,EAAK,CACf0C,MAAO1B,EAAgB,UACvB2B,MAAO,IAAMjH,EAAI,KAGzB,IAAgB+G,EAAQ,UAAW,GAyVzBG,CAAcjF,GAGxB6B,eAjTMqD,CAAc/H,EAAKG,EAAUC,EAAQsC,EAASO,EAAQ8B,GAAQ,GAAM,GAE1E,MACApF,UAEMqH,EAAoBhH,EAAKG,EAAUC,EAAQsC,EAASO,EAAQJ,EAAWkC,GAC7EP,aAAa/C,GACb3B,EAAE,oBAAoB2E,QAAQ,KAGlC,SAASH,IACLpC,QAAQ8F,KAAK,uBAySjBzG,eAAeyF,EAAoBhH,EAAKG,EAAUgD,EAAUT,EAASO,EAAQJ,EAAWkC,GACpF,IAAImC,EAASe,OAAOC,OAAS,IAAM,WAAa,UAE5CC,EAAOrI,EAAEoH,EAAS,sCAAwCnC,EAAS,MACnEqD,EAAUtI,EAAEoH,EAAS,2CAA6CnC,EAAS,OAE3EsD,EAAOF,EAAKZ,SAAS,yBAAyBA,SAAS,kBACvDe,EAAUH,EAAKZ,SAAS,yBAAyBA,SAAS,kBAa9D,GAXAc,EAAKzD,YAAY,YACjByD,EAAKxD,SAAS,cAEdyD,EAAQzD,SAAS,YACjByD,EAAQ1D,YAAY,cAGLwD,EAAQb,SAAS,yBAAyBA,SAAS,mBAAmBA,SAAS,KAErFxF,KAAK,IAEVyD,OAAQ,CACR,IAAI+C,EAAaJ,EAAK,QACHK,IAAfD,IACAA,EAAazI,EAAEoH,EAAS,oBAAoB,IAEhDqB,EAAWb,iBAGf,GAAI3C,EAAQ,CACR,IAAI3E,QAAe,IAAeJ,EAAKG,EAAUgD,GAC7CV,QAAc,IAAczC,EAAKG,EAAUuC,GAC3CF,QAAa,IAAoBxC,EAAKG,EAAUsC,EAAgB,UAChEyD,QAAa,IAAalG,EAAKG,EAAU4E,GAEzC0D,EAAY,CAAEnD,IAAKY,EAAe,SAAGX,IAAKW,EAAe,UAE7D,IAAcuC,GACd,IAAY,IAiRpBlH,eAA2BnB,EAAQqC,EAAOD,EAAMK,EAAWqD,GACvD,GAAIwC,EACA,OAEJA,GAAiB,EAEjB,IAAIP,EAAOrI,EAAE,qCAAuCoG,EAAc,QAAI,qBAElEyC,EACA,MAAQ7I,EAAEoB,KAAK,eAAiB,kPAGsEpB,EAAEoB,KAAK,+BAAiC,yBAGlJiH,EAAKpG,KAAK4G,GAMVtH,GAAgB,EA9RpBE,eAAyCvB,EAAKG,EAAUuC,EAASqC,EAAQ9B,GACrE,IAAI2F,EAAY9I,EAAE,qCAAuCiF,EAAS,oBAE9DiB,QAAc,IAA6BhG,EAAKG,EAAUuC,EAASO,GAEnE4F,GAAY,EAEhB,IAAKjI,EAAI,EAAGA,EAAIoF,EAAM3F,OAAQO,IAC1B,GAAI,IAAwBoF,EAAMpF,IAAK,CACnCiI,EAAWjI,EACX,MAIR,IAAI+H,EAAU,GACd,IAAkB,IAAdE,EAEA,IADA,IAAIC,EAAMD,EAAW,GAAK7C,EAAM3F,OAAS2F,EAAM3F,OAASwI,EAAW,EAC1DjI,EAAIiI,EAAUjI,EAAIkI,EAAKlI,IAAK,CACjC,IAAIiG,EAAMC,KAAKC,MAAMf,EAAMpF,GAAiB,aAAI,IAE5CmI,EAAO,IAAgB/C,EAAMpF,GAAe,YAEhD+H,GACI,8BAAiC/H,GAAKiI,EAAW,UAAY,IAAM,aACtD/I,EAAEoB,KAAK,4BAA6B2F,GAAO,4BAC7B,IAAckC,EAAKC,YAAc,IAAM,IAAcD,EAAKE,cAAgB,kBAGrF,IAAjBjD,EAAM3F,OACbsI,GACI,8CAC2B7I,EAAEoB,KAAK,4BAA8B,aAGpEyH,GACI,8CAC2B7I,EAAEoB,KAAK,8BAAgC,aAIrEG,GACDuH,EAAU7G,KAAK4G,GAsPnBO,CAA0BzG,EAAe,QAAGA,EAAgB,SAAGA,EAAgB,SAAGyD,EAAc,QAAGrD,EAAU,GAAY,SAMzHsG,cAAcpK,GACd,IAAIqK,EAAO,YAvPf7H,eAA6BnB,EAAQqC,EAAOD,EAAMK,EAAWqD,GACzD,GAAImD,EACA,OAEJA,GAAkB,EAClBvJ,EAAE,wBAAwBQ,IAAI,UAAW,IACzC,IACI,IAAIgJ,QAAiB,WAAoB,CACrCC,aAAcnJ,EAAkB,UAAEoJ,MAAM,KACxCpJ,OAAQA,EACRqC,MAAOA,EACPD,KAAMA,EACNK,UAAWA,EACXqD,KAAMA,IAEVpG,EAAE,iBAAiB2J,SACnB3J,EAAE,wBAAwBQ,IAAI,UAAW,QACzC4B,QAAQC,IAAImH,GACZ,IAAII,EAAMJ,EAASK,QACfhB,EAAU,GACH7I,EAAE,qCAAuC4J,EAAIxD,KAAc,QAAI,iCAC1E,IAAuB,IAAnBoD,EAASM,KAAa,CACtB,IAAI7H,EAAO,4BAAgCjC,EAAEoB,KAAK,gCAAkC,OAEpFpB,EAAE,qCAAuC4J,EAAIxD,KAAc,QAAI,qBAAqB2D,OAAO9H,QACxF,IAAuB,IAAnBuH,EAASM,MAAgBN,EAASQ,OAAmC,IAA1BR,EAASQ,MAAMzJ,OAAe,CAC5E0B,EAAO,4BAAgCjC,EAAEoB,KAAK,gCAAkC,OAEpFpB,EAAE,qCAAuC4J,EAAIxD,KAAc,QAAI,qBAAqB2D,OAAO9H,OACxF,CACH,IAAIgI,EAAS,GACTC,EAAQ,GACZ,IAAK,IAAIC,KAAQX,EAASQ,MACtB,IAAK,IAAII,KAAUD,EAAKC,OAAQ,CAC5B,IAAIC,EAAaD,EAAmB,WACpC,GAAIC,EAAY,CACZ,IAAIC,EAAYD,EAAWC,UAAYD,EAAWC,UAAYH,EAAKI,OAAOD,UAC1EJ,EAAMjG,KAAK,CACPqG,UAAWA,EACXF,OAAQA,IAIZA,EAAc,OACdH,EAAOhG,KAAKmG,EAAc,OAKtC,GAAIH,EAAO1J,OAAS,EAAG,CACnB,IAAIiK,EAAa,GAEbA,EADkB,IAAlBP,EAAO1J,OAEH,gGAAsG,mBAAsB0J,EAAO,GAAGQ,YAAc,aAGpJ,gGAAsGzK,EAAEoB,KAAK,oCAAqC6I,EAAO1J,QAAU,oDAAwDP,EAAEoB,KAAK,0CAA4C,kBAEtRpB,EAAE,qCAAuC4J,EAAIxD,KAAc,QAAI,qBAAqBsE,QAAQF,GAC5FxK,EAAE,mBAAmBuE,GAAG,SAAS,WAC7B,IAAa,iBAAkB0F,MAIvC,GAAqB,IAAjBC,EAAM3J,OAAc,CAChB0B,EAAO,4BAAgCjC,EAAEoB,KAAK,oCAAsC,OAExFpB,EAAE,qCAAuC4J,EAAIxD,KAAc,QAAI,qBAAqB2D,OAAO9H,OACxF,CACC4G,EAAU,GAAd,IAEIhC,GAAS,EACb,IAAK,IAAI8D,KAAQT,EAAO,CACpB,IAAIU,EAAkBD,EAAKP,OAAOC,WAA2B,eAC7D,GAAIO,GAAmBA,EAAgBrK,OAAS,EAC5C,IAAK,IAAIsK,KAAkBD,EACvB,IAAKC,EAAqC,sBAAgD,cAA3CA,EAAqC,qBAAmB,CACnG,IAAIC,EAEAD,EAAeE,UACfD,EAAUD,EAAeE,UAAU9B,KAC5B4B,EAAeG,UACtBF,EAAUD,EAAeG,QAAQ/B,MAGrC,IAAIgC,EAAMjE,KAAKkE,OAAOJ,EAAUH,EAAKL,WAAa,IAAO,IAErDrI,EAAO,oBAGPA,GADAgJ,GAAO,GACC,YACDA,GAAO,GACN,OACDA,GAAO,GACN,UACDA,GAAO,EACN,UACDA,GAAO,EACN,SAEA,QAGPpE,GAAUoE,EAAM,IACjBpE,GAAS,EACT5E,GAAQ,WAGZA,GAAQ,KAqBJ0I,EAAKP,OAAgB,SAAKO,EAAKP,OAAgB,QAAW,SAAKO,EAAKP,OAAgB,QAAW,QAAS,QACxGnI,GAAQ,OAAS0I,EAAKP,OAAgB,QAAW,QAAS,MAAI,SAUlEnI,GAAQ,OAaJA,GADAgJ,EAAM,EACEjL,EAAEoB,KAAK,sBAAuB6J,GAE9BjL,EAAEoB,KAAK,4BAGnBa,GAAQ,WAMRA,GAAQ,eAERA,GAAQ,IAER,IAAIgH,EAAO,IAAI/G,KAAK4I,GAEpB7I,GAAQ,IAAcgH,EAAKC,YAAc,IAAM,IAAcD,EAAKE,cAQlElH,GAAQ,QAaR4G,GADA5G,GAAQ,SAWxBjC,EAAE,qCAAuC4J,EAAIxD,KAAc,QAAI,iCAAiCnE,KAAK4G,GACrGtH,GAAgB,IAG1B,MAAOsI,GACL7J,EAAE,wBAAwBQ,IAAI,UAAW,QACrCyB,EAAO,wCAA4CjC,EAAEoB,KAAK,kCAAoC,OAElGpB,EAAE,qCAAuCoG,EAAc,QAAI,qBAAqB2D,OAAO9H,GAI3FsH,GAAkB,EAmCd4B,CAAc7K,EAAQqC,EAAOD,EAAMK,EAAWqD,IAElDkD,IACArK,EAAqBmM,YAAY9B,EAAM,KAEvCV,GAAiB,EAlTbyC,CAAY/K,EAAQqC,EAAOD,EAAMK,EAAWqD,IAmDpD,IAAImD,GAAkB,EA0NtB,IAAIX,GAAiB,EAwCrB,SAAS0C,IACL,IAAIC,EAAa,IAAwBhL,OACzC,GAAIgL,EAAa,EAAG,CAChBvL,EAAE,2BAA2B6B,OAAO,KAEpC,IAAI2J,EAAMpM,IACLoM,GAAOD,EAAaC,KACrBA,EAAMpM,EAAamM,GAGvBvL,EAAE,yCAAyCiC,KAAKjC,EAAEoB,KAAK,8BAA+BoK,EAAMD,EAAYC,IAExGxL,EAAE,yCAAyCQ,IAAI,QAASwG,KAAKkE,OAAOM,EAAMD,GAAcC,EAAM,KAAO,UAErGpM,EAAa,EACbY,EAAE,yCAAyCQ,IAAI,QAAS,QACxDR,EAAE,2BAA2B2E,QAAQ,KAAK,WACtC3E,EAAE,yCAAyCQ,IAAI,QAAS,SAIhE,IAAK,IAAIwC,KAAU7D,EAAiB,CACnB,MACL,WAAoB,CACxBsK,aAAczG,EAAOL,MAAiB,UAAE+G,MAAM,KAC9CpJ,OAAQ0C,EAAO1C,OACfqC,MAAOK,EAAOL,MACdD,KAAMM,EAAON,KACb0D,KAAMpD,EAAOoD,KACbrD,UAAWC,EAAOyI,OAEpBC,MAAK,SAAUlC,GACb,IAAInI,EAAO,GACPuI,EAAMJ,EAASK,QAEfxB,EAAOrI,EAAE,yDAA4D4J,EAAItJ,OAAgB,QAAI,yBAA6BsJ,EAAItJ,OAAiB,SAAI,uBAA2BsJ,EAAItJ,OAAkB,UAAI,yBAA6BsJ,EAAIjH,MAAgB,SAAI,wBAA4BiH,EAAIlH,KAAc,QAAI,wBAA4BkH,EAAIxD,KAAc,QAAI,MAErWiC,EAAKvD,YAAY,6BACjBuD,EAAKvD,YAAY,wBACjBuD,EAAKvD,YAAY,2BACjBuD,EAAKvD,YAAY,2BACjBuD,EAAKvD,YAAY,0BACjBuD,EAAKvD,YAAY,yBACjBuD,EAAKvD,YAAY,wBAEjB,IAAI6G,EAAa,gBAEjB,GAAInC,EAASM,KAAO,EAChBzI,EAAOrB,EAAEoB,KAAK,yCACdiH,EAAKtD,SAAS,8BACX,GAA8B,IAA1ByE,EAASQ,MAAMzJ,OACtBc,EAAOrB,EAAEoB,KAAK,gCACdiH,EAAKtD,SAAS,6BACX,CACH,IAAImF,EAAQ,GACZ,IAAK,IAAIC,KAAQX,EAASQ,MACtB,IAAK,IAAII,KAAUD,EAAKC,OAAQ,CAC5B,IAAIC,EAAaD,EAAmB,WACpC,GAAIC,EAAY,CACZ,IAAIC,EAAYD,EAAWC,UAAYD,EAAWC,UAAYH,EAAKI,OAAOD,UAC1EJ,EAAMjG,KAAK,CACPqG,UAAWA,EACXD,WAAYA,KAiB5B,GAAqB,IAAjBH,EAAM3J,OACNc,EAAOrB,EAAEoB,KAAK,0CACdiH,EAAKtD,SAAS,6BACX,CACH,IAAI4F,EAAOT,EAAM,GAEbU,EAAkBD,EAAKN,WAA2B,eACtD,GAAIO,GAAmBA,EAAgBrK,OAAS,EAAG,CAC/C,IAAIsK,EAAiBD,EAAgB,GAErC,GAAKC,EAAqC,sBAAgD,cAA3CA,EAAqC,qBA+DhFzI,QAAQC,IAAI,cA/DuF,CACnG,IAAIyI,EAEAD,EAAeE,UACfD,EAAUD,EAAeE,UAAU9B,KAC5B4B,EAAeG,UACtBF,EAAUD,EAAeG,QAAQ/B,MAKrC,IAAI2C,EAAU5E,KAAKkE,OAAOJ,EAAUH,EAAKL,WAAa,IAAO,IAEzD9J,EAAM,GAGNA,EADAoL,GAAW,GACL,YACCA,GAAW,GACZ,OACCA,GAAW,GACZ,UACCA,GAAW,EACZ,UACCA,GAAW,EACZ,SAEA,OAEVvD,EAAKtD,SAAS,mBAAqBvE,GAEnCmL,EAAa,gBACTC,EAAU,EACVvK,GAAQrB,EAAEoB,KAAK,sBAAuBwK,IAEtCvK,GAAQrB,EAAEoB,KAAK,2BAA4BwK,GAC3CD,EAAa,oBAgCrBvJ,QAAQC,IAAI,cAKxB,IAAIwJ,EAAQxD,EAAKZ,SAAS,gBAE1BoE,EAAM/G,YAAY,iBAClB+G,EAAM/G,YAAY,mBAClB+G,EAAM/G,YAAY,iBAClB+G,EAAM/G,YAAY,gBAClB+G,EAAM/G,YAAY,cAClB+G,EAAM9G,SAAS4G,GAEfE,EAAM5J,KAAKZ,MACZyK,OAAM,SAAUjC,EAASkC,GACxB,IAAI1D,EAAOrI,EAAE,yDAA4D6J,EAAQvJ,OAAgB,QAAI,yBAA6BuJ,EAAQvJ,OAAiB,SAAI,uBAA4BuJ,EAAQvJ,OAAkB,UAAI,yBAA6BuJ,EAAQlH,MAAgB,SAAI,wBAA4BkH,EAAQnH,KAAc,QAAI,wBAA4BmH,EAAQzD,KAAc,QAAI,MAE9XiC,EAAKvD,YAAY,6BACjBuD,EAAKvD,YAAY,wBACjBuD,EAAKvD,YAAY,2BACjBuD,EAAKvD,YAAY,2BACjBuD,EAAKvD,YAAY,0BACjBuD,EAAKvD,YAAY,yBACjBuD,EAAKvD,YAAY,wBACjBuD,EAAKtD,SAAS,yBAEd,IAAI8G,EAAQxD,EAAKZ,SAAS,gBAE1BoE,EAAM/G,YAAY,iBAClB+G,EAAM/G,YAAY,mBAClB+G,EAAM/G,YAAY,iBAClB+G,EAAM/G,YAAY,gBAClB+G,EAAM/G,YAAY,cAClB+G,EAAM9G,SAAS,gBAEf8G,EAAM5J,KAAKjC,EAAEoB,KAAK,6CAK9BK,eAAeuK,IACX3C,cAAcnK,GAEd,IAAIkG,EAAM,MAENI,EAAMJ,EAAII,IACVC,EAAML,EAAIK,IAEd/F,EAAU8F,EACV7F,EAAU8F,EAEV,IAAIwG,EAAQ,MAAa,2BAA4B,KAAO,IAExDjK,EAAKE,KAAKC,MACV+J,QAAuB,IAAuB1G,EAAKC,EAAKwG,GAAO,GAEnE,GAA8B,IAA1BC,EAAe3L,OAAc,CAC7B,IAAI4L,EAAYF,EAChB,GACIE,GAAa,IACbD,QAAuB,IAAuB1G,EAAKC,EAAK0G,GAAW,GAAM,SAC1C,IAA1BD,EAAe3L,QAAgB4L,EAAY,IAEhDA,GAAa,GACbnM,EAAE,cAAc+J,OACZ,iJAEA/J,EAAEoB,KAAK,qCACP,UAGJpB,EAAE,cAAc+J,OACZ,kJAEA/J,EAAEoB,KAAK,oDAA6D,IAAR6K,EAAcjF,KAAKoF,KAAiB,IAAZD,IACpF,UAIZ/J,QAAQC,IAAI,UAAYH,KAAKC,MAAQH,IAErCA,EAAKE,KAAKC,MACV,IA2CIgD,EA3CAkH,EAAsB,MAAa,gCAAiC,IAIxE,IAAK,IAAIC,KAHTnN,EAAkB,GAClBiD,QAAQC,IAAI6J,GAEWA,GAAgB,CACnC,GAAI/M,EAAgBoB,QAAU8L,EAC1B,MAGJ,IAAIjG,EAEAlG,GAFAkG,EAAOkG,EAAWlG,MAEE,QACpB/F,EAAW+F,EAAe,SAE1BmG,QAAmB,IAAsBrM,EAAKG,EAAU+F,EAAc,SAG1E,IAAK,IAAIxD,KAAW2J,EAAW9J,MAAO,CAClC,IAAIC,EAAO6J,EAAW9J,MAAMG,GACxBtC,QAAe,IAAeJ,EAAKG,EAAUkM,EAAWC,OAAO5J,GAAoB,WACnF6I,QAAa,IAA6BvL,EAAKG,EAAUqC,EAAc,SAC3EvD,EAAgB8E,KAAK,CACjB3D,OAAQA,EACRqC,MAAO4J,EAAWC,OAAO5J,GACzBF,KAAMA,EACN0D,KAAMA,EACNb,SAAUgH,EAAWxJ,UAAUL,EAAc,SAC7C+I,KAAMA,EACNtG,SAAUmH,EAAWnH,YAKjC/C,QAAQC,IAAI,UAAYH,KAAKC,MAAQH,IACrCA,EAAKE,KAAKC,MACVhD,EAAgBsN,KAAK,CAACC,EAAGC,IACdD,EAAEvH,SAAWwH,EAAExH,UAG1B/C,QAAQC,IAAI,UAAYH,KAAKC,MAAQH,IACrCA,EAAKE,KAAKC,MACVC,QAAQC,IAAIlD,GAQZ,IAAI8C,EAAO,0BACX,IAAK,IAAIe,KAAU7D,EAIfgG,EAAW6B,KAAKC,MAAwB,IAAlBjE,EAAOmC,UAC7B7E,QAAe,IAAe0C,EAAOL,MAAe,QAAGK,EAAOL,MAAgB,SAAGK,EAAOL,MAAiB,WACzGyD,QAAa,IAAapD,EAAOuC,SAAkB,QAAGvC,EAAOuC,SAAmB,SAAGvC,EAAOuC,SAAkB,SAE5GtD,GACI,8IAAmJe,EAAOL,MAAe,QAAI,wBAA4BK,EAAOL,MAAgB,SAAI,sBAA0BK,EAAOL,MAAiB,UAAI,wBAA4BK,EAAOL,MAAgB,SAAI,uBAA2BK,EAAON,KAAc,QAAI,uBAA2BM,EAAOuC,SAAkB,QAAI,wBAA4BvC,EAAOuC,SAAwB,cAAI,uEAEte,eAAkBjF,EAAQ,qBAAuB,0BACjD,eAAkB0C,EAAOL,MAAO,oBAAsB,kHAOvD,IAA0BrC,EAAkB,UAAG,eAAkB8F,EAAM,cAAgB,KAAOjB,EAAWnF,EAAEoB,KAAK,sBAAwB,qGAGrFpB,EAAEoB,KAAK,0BAA4B,mBAGnHa,GAAQ,QAERjC,EAAE,sBAAsBiC,KAAKA,GAC7BG,QAAQC,IAAI,UAAYH,KAAKC,MAAQH,IAErChC,EAAE,uCAAuCuE,GAAG,aAAcC,GAE1DxE,EAAE,uCAAuCuE,GAAG,cAAc,eAO1DvE,EAAE,uCAAuCuE,GAAG,QAASE,GAErD3E,EAAmB,sBAEnBwL,IACApM,EAAiBkM,YAAYE,EAAW,KAG5C,SAASsB,IACL,IAAI3K,EACA,6KAGkBjC,EAAEoB,KAAK,mCAAqC,yBAIlEpB,EAAE,sBAAsBiC,KAAKA,GAC7B+J,IAGJ,SAASa,EAAqBC,GAE1B1K,QAAQC,IAAIyK,GASZ,IAAI7K,EACA,qNATe,IAAf6K,EAAMhD,KACM9J,EAAEoB,KAAK,uCACG,IAAf0L,EAAMhD,MAA6B,IAAfgD,EAAMhD,KACrB9J,EAAEoB,KAAK,yCAEPpB,EAAEoB,KAAK,yBAA0B0L,EAAMC,UAOD,yBAItD/M,EAAE,sBAAsBiC,KAAKA,GAG1BR,eAAeuL,IAClB,MACA,eAEA,IAAwB3N,EAAsB,SAAUuG,GACpD,IAAIqH,EACJ,GAAIjN,EAAE4F,GAAKsH,SAAS,8BAChBrN,IACA+E,oBACG,GAAI5E,EAAE4F,GAAKsH,SAAS,mCACvBD,EAAajN,EAAE,wBAAwB+B,MACvC/B,EAAE,wBAAwB+B,IAAIkL,EAAWE,MAAM,GAAI,IACnDzL,SACG,GAAI1B,EAAE4F,GAAKsH,SAAS,sBAAuB,CAC9C,IAAInL,EAAM/B,EAAE4F,GAAK3D,OACjBgL,EAAajN,EAAE,wBAAwB+B,MACvC/B,EAAE,wBAAwB+B,IAAIkL,EAAalL,GAC3CL,OAIR,IAAkB,IAAa0L,cAAe9N,EAAsB,WAC5DM,GACA,MAEJyJ,cAAcpK,KAGlB,IAAkB,IAAaoO,qBAAsB5N,EAAwB,SAAUqN,GACnFD,EAAqBC,KAGzB,IAAkB,IAAaQ,uBAAwB9N,EAA0B,WAC7EoN,MAGJ,IAAkB,IAAaW,sBAAuBhO,EAAsB,WACxE,GAAIG,GAAWC,EAAS,CACpB,IAAI6N,EAAS,MACH,IAAiBA,EAAOhI,IAAKgI,EAAO/H,IAAK/F,EAASC,GAClD,OACNyC,QAAQC,IAAI,yDACZ2J,QAKZ,IAAIyB,QAAiB,MAErB,GAAIA,EAASlN,OAAS,EAAG,CACrB,IAAImN,EACA,mKACwI1N,EAAEoB,KAAK,wBAA0B,YAE7K,IAAK,IAAId,KAAUmN,EAAU,CAEzBC,GAAgB,+GAAsHpN,EAAgB,QAAI,wBAA4BA,EAAiB,SAAI,sBAA0BA,EAAkB,UAAI,oCAAgD,eAAkBA,EAAQ,qBAAuB,YAGhWoN,GAAgB,SAEhB1N,EAAE,cAAc+J,OAAO2D,GAEvB,IAAIC,EACA,oHACmE3N,EAAEoB,KAAK,8CAAgD,iBAAqBpB,EAAEoB,KAAK,8CAAgD,gQAQ1MpB,EAAE,cAAc+J,OAAO4D,GAUvB3N,EAAE,cAAc+J,OAPZ,oNASJ/J,EAAE,qBAAqBuE,GAAG,SAAS,WAC/B,IAAIvE,EAAEG,MAAM+M,SAAS,eAKrB,GAAIlN,EAAEG,MAAM+M,SAAS,wBACjBrI,QACG,CACH7E,EAAE,qBAAqB8E,YAAY,eAEnC,IAAI5E,EAAMF,EAAEG,MAAMC,KAAK,oBACnBC,EAAWL,EAAEG,MAAMC,KAAK,qBACxBE,EAASN,EAAEG,MAAMC,KAAK,mBAC1BJ,EAAEG,MAAM4E,SAAS,eAEjB,IAAI6I,EAAU,sBAAwB1N,EAAM,yBAA2BG,EAAW,uBAAyBC,EAAS,KAEpHN,EAAE,kCAAoC4N,EAAU,KAAK7I,SAAS,eAC9D/E,EAAE,mBAAqB4N,GAASxN,KAAK,QAAS,IAC9CJ,EAAE,wBAA0B4N,EAAU,KAAKxN,KAAK,QAAS,+BAIjEJ,EAAE,yBAAyBuE,GAAG,SAAS,WAC9BvE,EAAEG,MAAM+M,SAAS,aAClBlI,OAMJhF,EAAE,wBAAwBuE,GAAG,SAAS,WA7kD9C,MASA3E,GAAa,EAEbI,EAAE,yBAAyB8E,YAAY,aACvC9E,EAAE,yBAAyB8E,YAAY,YACvC9E,EAAE,yBAAyB+E,SAAS,cACpC/E,EAAE,yBAAyBiC,KAAK,gCAEhCjC,EAAE,sBAAsBQ,IAAI,UAAW,QACvCR,EAAE,mBAAmBQ,IAAI,UAAW,QACpC,IAAc,OACd,IAAY,IACZ,MACA,MACAkB,IACAmD,IACA/E,EAAmB,sBA2jDfE,EAAE,wBAAwBuE,GAAG,SAAS,WAClCG,aAAa1F,GACbA,EAAgB4C,YAAW,WACvBF,MACD,QAMP,GAFA1B,EAAE,4BAA4BiC,KADZ,uGAGd,MACA4K,EAAqB,YAClB,GAAI,MACPD,QACG,CACH,IAAI3K,EACA,6KAGkBjC,EAAEoB,KAAK,kCAAoC,yBAIjEpB,EAAE,sBAAsBiC,KAAKA,SAIjCjC,EAAE,cAAciC,KAAK,kGAA0GjC,EAAEoB,KAAK,iDAAmD,UAI1L,SAASyM,IACZ,IAA2BxO,GAC3B,IAAqB,IAAa+N,cAAe9N,GACjD,IAAqB,IAAa+N,qBAAsB5N,GACxD,IAAqB,IAAa6N,uBAAwB9N,GAC1D,IAAqB,IAAa+N,sBAAuBhO,GACzDmF,aAAa1F,GACbqK,cAAcnK,GACdmK,cAAcpK,GACdD,GAAgB,EAChBE,GAAiB,I","file":"11.8e854895b90a12c37bc5.js","sourcesContent":["import * as Transit from './gtw-citydata-transit';\r\nimport * as TransitEta from './gtw-citydata-transit-eta';\r\nimport * as RequestLimiter from './gtw-requestlimiter';\r\nimport * as Settings from './gtw-settings';\r\nimport * as Misc from './gtw-misc';\r\nimport * as Lang from './gtw-lang';\r\nimport * as Loc from './gtw-location';\r\nimport * as TouchKeypad from './gtw-ui-touchkeypad';\r\nimport * as Event from './gtw-event';\r\nimport * as UI from './gtw-ui';\r\nimport * as Map from './gtw-map';\r\nimport * as gtfs from './gtw-citydata-transit-gtfs';\r\nimport { languages } from './gtw-lang';\r\n\r\nvar searchTimeout;\r\nvar updateStopEtaTimer;\r\nvar updateEtaTimer;\r\nvar allNearbyRoutes;\r\nvar maxRequest;\r\nvar touchKeypadListener;\r\nvar eventUiBackListener;\r\nvar eventLocChgListener;\r\nvar eventLocSuccessListener;\r\nvar eventLocErrorListener;\r\nvar lastLat = false;\r\nvar lastLng = false;\r\nvar searchMode = false;\r\n\r\nfunction showTouchKeypad() {\r\n    //$(\"#search-transit-text\").removeAttr(\"readonly\");\r\n    TouchKeypad.showTouchKeypad();\r\n}\r\n\r\nfunction hideTouchKeypad() {\r\n    //$(\"#search-transit-text\").attr(\"readonly\", \"readonly\");\r\n    TouchKeypad.hideTouchKeypad();\r\n}\r\n\r\nfunction showSearchRoutes() {\r\n    searchMode = true;\r\n\r\n    $(\"#button-cancel-search\").removeClass(\"btn-light\");\r\n    $(\"#button-cancel-search\").removeClass(\"disabled\");\r\n    $(\"#button-cancel-search\").addClass(\"btn-danger\");\r\n    $(\"#button-cancel-search\").html(\"<i class=\\\"fas fa-times\\\"></i>\");\r\n\r\n    $(\".nearby-route-list\").css(\"display\", \"none\");\r\n    $(\".all-route-list\").css(\"display\", \"flex\");\r\n    Map.setCenter(Loc.getCurrentPosition());\r\n    Map.setZoom(16);\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n    searchRoutes();\r\n    resetProviderSort();\r\n    filterProviderSort(\".all-route-list\");\r\n}\r\n\r\n\r\nfunction hideSearchRoutes() {\r\n    searchMode = false;\r\n\r\n    $(\"#button-cancel-search\").addClass(\"btn-light\");\r\n    $(\"#button-cancel-search\").addClass(\"disabled\");\r\n    $(\"#button-cancel-search\").removeClass(\"btn-danger\");\r\n    $(\"#button-cancel-search\").html(\"<i class=\\\"fas fa-search\\\"></i>\");\r\n\r\n    $(\".nearby-route-list\").css(\"display\", \"flex\");\r\n    $(\".all-route-list\").css(\"display\", \"none\");\r\n\r\n    Map.setCenter(Loc.getCurrentPosition());\r\n    Map.setZoom(16);\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n\r\n    resetProviderSort();\r\n    filterProviderSort(\".nearby-route-list\");\r\n}\r\n\r\nfunction filterProviderSort(listNodeCss) {\r\n    $(\".gtw-providersort-provider\").each(function () {\r\n        var pkg = $(this).attr(\"data-gtw-package\");\r\n        var provider = $(this).attr(\"data-gtw-provider\");\r\n        var agency = $(this).attr(\"data-gtw-agency\");\r\n\r\n        var cssCond = \"[data-gtw-package='\" + pkg + \"'][data-gtw-provider='\" + provider + \"'][data-gtw-agency='\" + agency + \"']\";\r\n\r\n        var contain = $(listNodeCss + \" .route-selection\" + cssCond + \"\").length > 0;\r\n        if (contain) {\r\n            $(this).css(\"display\", \"\");\r\n        } else {\r\n            $(this).css(\"display\", \"none\");\r\n        }\r\n    });\r\n}\r\n\r\nvar GTFS_CALENDAR_IDS = [\r\n    \"monday\",\r\n    \"tuesday\",\r\n    \"wednesday\",\r\n    \"thursday\",\r\n    \"friday\",\r\n    \"saturday\",\r\n    \"sunday\"\r\n];\r\n\r\nvar GTFS_CALENDAR_NAMES = [\r\n    \"Monday\",\r\n    \"Tuesday\",\r\n    \"Wednesday\",\r\n    \"Thursday\",\r\n    \"Friday\",\r\n    \"Saturday\",\r\n    \"Sunday\"\r\n];\r\n\r\nvar JS_WEEKDAY_NAMES = [\r\n    \"sunday\",\r\n    \"monday\",\r\n    \"tuesday\",\r\n    \"wednesday\",\r\n    \"thursday\",\r\n    \"friday\",\r\n    \"saturday\"\r\n];\r\n\r\nfunction combineCalendars(calendars) {\r\n    var out = {};\r\n    var i;\r\n    for (i = 0; i < GTFS_CALENDAR_IDS.length; i++) {\r\n        out[GTFS_CALENDAR_IDS[i]] = 0;\r\n    }\r\n    var j;\r\n    for (i = 0; i < calendars.length; i++) {\r\n        for (j = 0; j < GTFS_CALENDAR_IDS.length; j++) {\r\n            out[GTFS_CALENDAR_IDS[j]] |= calendars[i][GTFS_CALENDAR_IDS[j]];\r\n        }\r\n    }\r\n    return out;\r\n}\r\n\r\nfunction describeCalendar(calendar, onlyDates = false) {\r\n    if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"] &&\r\n        calendar[\"friday\"] &&\r\n        calendar[\"saturday\"] &&\r\n        calendar[\"sunday\"]) {\r\n        if (onlyDates) {\r\n            return $.i18n(\"transit-calendar-from-monday-to-sunday-dates\");\r\n        } else {\r\n            return false;\r\n        }\r\n    } else if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"] &&\r\n        calendar[\"friday\"] &&\r\n        calendar[\"saturday\"]) {\r\n        return $.i18n(\"transit-calendar-from-monday-to-saturday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"] &&\r\n        calendar[\"friday\"]) {\r\n        return $.i18n(\"transit-calendar-from-monday-to-friday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"monday\"] &&\r\n        calendar[\"tuesday\"] &&\r\n        calendar[\"wednesday\"] &&\r\n        calendar[\"thursday\"]) {\r\n        return $.i18n(\"transit-calendar-from-monday-to-thursday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"saturday\"] &&\r\n        calendar[\"sunday\"]) {\r\n        return $.i18n(\"transit-calendar-from-saturday-to-sunday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"saturday\"]) {\r\n        return $.i18n(\"transit-calendar-on-saturday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    } else if (calendar[\"sunday\"]) {\r\n        return $.i18n(\"transit-calendar-on-sunday\" + (onlyDates ? \"-dates\" : \"\"));\r\n    }\r\n    var text = \"\";\r\n    var i;\r\n    var val;\r\n    for (i = 0; i < GTFS_CALENDAR_IDS.length; i++) {\r\n        val = calendar[GTFS_CALENDAR_IDS[i]];\r\n        if (val) {\r\n            text += GTFS_CALENDAR_NAMES[i].substr(0, 1);\r\n        } else {\r\n            text += \".\";\r\n        }\r\n    }\r\n    return text;\r\n}\r\n\r\nvar __cachedFirstLetters = false;\r\n\r\nasync function searchRoutes() {\r\n    var overlayFadeInTimeout = setTimeout(function () {\r\n        $(\".loading-overlay\").fadeIn(500);\r\n    }, 500);\r\n    TouchKeypad.setEnabled({});\r\n    TouchKeypad.disableFunctionKeys();\r\n\r\n    var val = $(\"#search-transit-text\").val();\r\n\r\n    var useKeypad = true;\r\n    if (!useKeypad) {\r\n        clearSearch();\r\n        return;\r\n    }\r\n    \r\n    var firstLetters;\r\n    \r\n    var html = \"<ul class=\\\"list-group\\\">\";\r\n\r\n    var st;\r\n    st = Date.now();\r\n    if (val.length === 0) {\r\n        console.log(\"FIRSTLETTERS\");\r\n        if (!__cachedFirstLetters) {\r\n            firstLetters = await gtfs.getAllRouteNames(val.length, 1, true);\r\n            __cachedFirstLetters = firstLetters;\r\n        } else {\r\n            firstLetters = __cachedFirstLetters;\r\n        }\r\n        console.log(\"Used \" + (Date.now() - st) + \" ms\");\r\n        st = Date.now();\r\n    } else {\r\n        console.log(\"SEARCH\");\r\n        var result = await gtfs.searchRoutes(val);\r\n        console.log(\"Used \" + (Date.now() - st) + \" ms\");\r\n        st = Date.now();\r\n\r\n        var i;\r\n        var j;\r\n        var k;\r\n        var l;\r\n        var key;\r\n        var routeName;\r\n        var trips;\r\n        var trip;\r\n        var route;\r\n        var agency;\r\n        var tripId;\r\n        var routeId;\r\n        var lastStop;\r\n        var lastStopId;\r\n        var stopTimes;\r\n        var calendar;\r\n        var calendars = {};\r\n        var calendarDates = {};\r\n        var serviceId;\r\n        var serviceIds;\r\n        var pathId;\r\n        var pathIds;\r\n        firstLetters = [];\r\n\r\n        var pkg;\r\n        var provider;\r\n        var agencyId;\r\n        \r\n        var serviceArray;\r\n        var noServiceArray;\r\n\r\n        var count = 0;\r\n\r\n        var fetchedAgency = {};\r\n        var fetchedTripsByRouteId = {};\r\n        var fetchedStopTimePaths = {};\r\n        var fetchedStops = {};\r\n\r\n        var beforeLoopTime = 0;\r\n        var beforeLoopCount = 0;\r\n\r\n        var afterLoopTime = 0;\r\n        var afterLoopCount = 0;\r\n\r\n        var xst;\r\n\r\n        for (i = 0; i < result.length; i++) {\r\n            xst = Date.now();\r\n            route = result[i];\r\n            routeId = route[\"route_id\"];\r\n            routeName = Lang.localizedKey(route, \"route_short_name\");\r\n            pkg = route[\"package\"];\r\n            provider = route[\"provider\"];\r\n            agencyId = route[\"agency_id\"];\r\n\r\n            if (val.length < routeName.length) {\r\n                var str = routeName.substr(val.length, 1);\r\n                if (!firstLetters.includes(str)) {\r\n                    firstLetters.push(str);\r\n                }\r\n            }\r\n\r\n            key = pkg + \",\" + provider + \",\" ;\r\n            if (!fetchedAgency[key + agencyId]) {\r\n                agency = fetchedAgency[key + agencyId] = await gtfs.getAgency(pkg, provider, agencyId);\r\n            } else {\r\n                agency = fetchedAgency[key + agencyId];\r\n            }\r\n\r\n            if (!fetchedTripsByRouteId[key + routeId]) {\r\n                trips = fetchedTripsByRouteId[key + routeId] = await gtfs.getTripsByRouteId(pkg, provider, routeId);\r\n            } else {\r\n                trips = fetchedTripsByRouteId[key + routeId];\r\n            }\r\n\r\n            pathIds = [];\r\n            serviceIds = [];\r\n            for (j = 0; j < trips.length; j++) {\r\n                trip = trips[j];\r\n                pathId = trip[\"path_id\"];\r\n                serviceId = trip[\"service_id\"];\r\n                if (!pathIds.includes(pathId)) {\r\n                    pathIds.push(pathId);\r\n                }\r\n                if (!serviceIds.includes(serviceId)) {\r\n                    serviceIds.push(serviceId);\r\n                }\r\n            }\r\n            beforeLoopTime += Date.now() - xst;\r\n            beforeLoopCount++;\r\n\r\n            for (j = 0; j < pathIds.length; j++) {\r\n                xst = Date.now();\r\n                pathId = pathIds[j];\r\n\r\n                html +=\r\n                    \"<li class=\\\"list-group-item list-group-item-action d-flex align-items-center route-selection\\\"  data-gtw-package=\\\"\" + pkg + \"\\\" data-gtw-provider=\\\"\" + provider + \"\\\" data-gtw-agency=\\\"\" + agencyId + \"\\\" data-gtw-route-id=\\\"\" + route[\"route_id\"] + \"\\\" data-gtw-path-id=\\\"\" + pathId + \"\\\">\" +\r\n                    \"    <div class=\\\"d-flex flex-column route-id\\\">\" +\r\n                    \"        <div>\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</div>\" +\r\n                    \"        <div>\" + routeName + \"</div>\" +\r\n                    \"    </div>\" +\r\n                    \"    <div class=\\\"d-flex flex-column stop-info mr-auto\\\">\";\r\n\r\n                if (!fetchedStopTimePaths[key + pathId]) {\r\n                    stopTimes = fetchedStopTimePaths[key + pathId] = await gtfs.getStopTimePathByPathId(pkg, provider, pathId);\r\n                } else {\r\n                    stopTimes = fetchedStopTimePaths[key + pathId];\r\n                }\r\n\r\n                lastStopId = stopTimes[stopTimes.length - 1][\"stop_id\"];\r\n                if (!fetchedStops[key + lastStopId]) {\r\n                    lastStop = fetchedStops[key + lastStopId] = await gtfs.getStop(pkg, provider, lastStopId);\r\n                } else {\r\n                    lastStop = fetchedStops[key + lastStopId];\r\n                }\r\n\r\n                html += \"        <div><b>\" + $.i18n(\"transit-eta-to\") + \":</b> \" + gtfs.selectAgencyStopName(agency[\"agency_id\"], Lang.localizedKey(lastStop, \"stop_name\")) + \"</div>\";\r\n\r\n                var pathCalendars = [];\r\n                for (k = 0; k < serviceIds.length; k++) {\r\n                    serviceId = serviceIds[k];\r\n\r\n                    if (!calendars[serviceId]) {\r\n                        calendars[serviceId] = await gtfs.getCalendar(pkg, provider, serviceId);\r\n                    }\r\n                    pathCalendars.push(calendars[serviceId]);\r\n                }\r\n\r\n                html += \"<div>\";\r\n                //TODO: Calendar Dates\r\n\r\n                var hasBadgeBefore = false;\r\n\r\n                if (stopTimes[0][\"stop_id\"] === lastStop[\"stop_id\"]) {\r\n                    hasBadgeBefore = true;\r\n                    html +=\r\n                        \"<span class=\\\"badge badge-secondary\\\">\" +\r\n                        $.i18n(\"transit-circular-path\") +\r\n                        \"</span>\"\r\n                        ;\r\n                }\r\n\r\n                calendar = combineCalendars(pathCalendars);\r\n                var calendarText = describeCalendar(calendar)\r\n                if (calendarText) {\r\n                    if (hasBadgeBefore) {\r\n                        html += \" \";\r\n                        hasBadgeBefore = false;\r\n                    }\r\n                    html +=\r\n                        \"<span class=\\\"badge badge-secondary\\\">\" +\r\n                        calendarText +\r\n                        \"</span>\"\r\n                        ;\r\n                }\r\n                html +=\r\n                    \"        </div>\" +\r\n                    \"    </div>\" +\r\n                    \"</li>\";\r\n                afterLoopTime += Date.now() - xst;\r\n                afterLoopCount++;\r\n            }\r\n        }\r\n    }\r\n    console.log(\"Used \" + (Date.now() - st) + \" ms\");\r\n    console.log(\"BeforeLoopAvg: \" + beforeLoopTime / beforeLoopCount + \" ms (\" + beforeLoopCount + \" times)\");\r\n    console.log(\"AfterLoopAvg: \" + afterLoopTime / afterLoopCount + \" ms (\" + afterLoopCount + \" times)\");\r\n    st = Date.now();\r\n\r\n    html += \"</ul>\";\r\n    $(\".all-route-list\").html(html);\r\n\r\n    console.log(firstLetters);\r\n    var availableKeypads = {};\r\n    for (var firstLetter of firstLetters) {\r\n        availableKeypads[firstLetter] = true;\r\n    }\r\n    console.log(availableKeypads);\r\n    TouchKeypad.setEnabled(availableKeypads);\r\n    TouchKeypad.enableFunctionKeys();\r\n\r\n    $(\".all-route-list .route-selection\").on(\"mouseenter\", mouseEnterPreviewRoute);\r\n    $(\".all-route-list .route-selection\").on(\"click\", mouseClickSelectRoute);\r\n\r\n    //$(\".all-route-list .route-selection:nth-child(1)\").mouseenter();\r\n\r\n    filterProviderSort(\".all-route-list\");\r\n\r\n    clearTimeout(overlayFadeInTimeout);\r\n    $(\".loading-overlay\").fadeOut(500);\r\n    adjustMargin();\r\n    console.log(\"Used \" + (Date.now() - st) + \" ms\");\r\n}\r\n\r\nfunction resetProviderSort() {\r\n    $(\".gtw-providersort\").removeClass(\"btn-primary\");\r\n    $(\".gtw-providersort-all\").addClass(\"btn-primary\");\r\n\r\n    //$(\".gtw-providersort-provider\").addClass(\"btn-default\");\r\n    $(\".route-selection\").attr(\"style\", \"\");\r\n}\r\n\r\nfunction clearSearch() {\r\n    $(\".all-route-list\").html(\"\");\r\n    hideTouchKeypad();\r\n    $(\"#search-transit-text\").val(\"\");\r\n    hideSearchRoutes();\r\n    TouchKeypad.reset();\r\n}\r\n\r\nasync function drawTripOnMap(stopTimes) {\r\n    var coords = [];\r\n    var pos;\r\n    var stop;\r\n    var i;\r\n    for (i = 0; i < stopTimes.length; i++) {\r\n        stop = await gtfs.getStop(stopTimes[i][\"package\"], stopTimes[i][\"provider\"], stopTimes[i][\"stop_id\"]);\r\n        pos = { lat: stop[\"stop_lat\"], lng: stop[\"stop_lon\"] };\r\n        coords.push(pos);\r\n        Map.addMarker(pos, {\r\n            title: stop[\"stop_name\"],\r\n            label: \"\" + (i + 1)\r\n        });\r\n    }\r\n    Map.addPolyline(coords, \"#FF0000\", 2);\r\n}\r\n\r\nasync function mouseClickSelectRoute() {\r\n    //fromSearch = $(this).parent().parent().hasClass(\"all-route-list\");\r\n\r\n    var pkg = $(this).attr(\"data-gtw-package\");\r\n    var provider = $(this).attr(\"data-gtw-provider\");\r\n    var agency = $(this).attr(\"data-gtw-agency\");\r\n    var routeId = $(this).attr(\"data-gtw-route-id\");\r\n    var pathId = $(this).attr(\"data-gtw-path-id\");\r\n    var stopId = $(this).attr(\"data-gtw-stop-id\");\r\n\r\n    var stopTimes = await gtfs.getStopTimePathByPathId(pkg, provider, pathId);\r\n\r\n    if (!stopId && Loc.isLocated()) {\r\n        var pos = Loc.getCurrentPosition();\r\n        \r\n        var pathStop;\r\n        var distance;\r\n        var nearestDistance = false;\r\n        var nearestStop = false;\r\n        for (var stopTime of stopTimes) {\r\n            pathStop = await gtfs.getStop(pkg, provider, stopTime[\"stop_id\"]);\r\n            distance = Misc.geoDistance(pathStop[\"stop_lat\"], pathStop[\"stop_lon\"], pos.lat, pos.lng);\r\n            if (!nearestDistance || !nearestStop || distance < nearestDistance) {\r\n                nearestDistance = distance;\r\n                nearestStop = pathStop;\r\n            }\r\n        }\r\n\r\n        console.log(nearestDistance);\r\n        if (nearestDistance <= 2) {\r\n            stopId = nearestStop[\"stop_id\"];\r\n        }\r\n    }\r\n\r\n    var overlayFadeInTimeout = setTimeout(function () {\r\n        $(\".loading-overlay\").fadeIn(500);\r\n    }, 500);\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n\r\n    await showRouteList(pkg, provider, agency, routeId, pathId, stopId, true, true);\r\n\r\n    UI.hidePanel();\r\n    hideTouchKeypad();\r\n\r\n    await routeListSelectStop(pkg, provider, agency, routeId, pathId, stopTimes, stopId);\r\n    clearTimeout(overlayFadeInTimeout);\r\n    $(\".loading-overlay\").fadeOut(500);\r\n}\r\n\r\nfunction mouseEnterPreviewRoute() {\r\n    console.warn(\"TODO: Preview route\");\r\n    /*\r\n    Map.removeAllMarkers();\r\n    Map.removeAllPolylines();\r\n    var provider = TransitRoutes.getProvider($(this).attr(\"gtw-provider\"));\r\n    var route = provider.getRouteById($(this).attr(\"gtw-route-id\"));\r\n    var sstop = TransitStops.getStopById($(this).attr(\"gtw-stop-id\"));\r\n    var bound = $(this).attr(\"gtw-bound\");\r\n    drawRouteOnMap(route, bound);\r\n\r\n    if (sstop) {\r\n        var targetPos = { lat: sstop.lat, lng: sstop.lng };\r\n        Map.setCenter(targetPos);\r\n        Map.setZoom(18);\r\n    } else {\r\n        var path = route.paths[bound];\r\n\r\n        var latlngs = [];\r\n        var stop;\r\n        for (var stopId of path) {\r\n            stop = TransitStops.getStopById(stopId);\r\n            latlngs.push({ lat: parseFloat(stop.lat), lng: parseFloat(stop.lng) });\r\n        }\r\n        Map.fitBounds(latlngs);\r\n    }\r\n    */\r\n}\r\n\r\nasync function showRouteList(pkg, provider, agencyId, routeId, pathId, stopId, scroll = false, draw = false) {\r\n    var stopTimes = await gtfs.getStopTimePathByPathId(pkg, provider, pathId);\r\n    var route = await gtfs.getRoute(pkg, provider, routeId);\r\n    var agency = await gtfs.getAgency(pkg, provider, agencyId);\r\n    var lastStopTime = stopTimes[stopTimes.length - 1];\r\n    var lastStop = await gtfs.getStop(pkg, provider, lastStopTime[\"stop_id\"]);\r\n    var trips = await gtfs.getTripsByRouteId(pkg, provider, routeId);\r\n\r\n    var freqByService = {};\r\n    var obj;\r\n    var freqs;\r\n    var tripId;\r\n    var serviceId;\r\n    var exist;\r\n    for (i = 0; i < trips.length; i++) {\r\n        if (pathId !== trips[i][\"path_id\"]) {\r\n            continue;\r\n        }\r\n\r\n        tripId = trips[i][\"trip_id\"];\r\n        serviceId = trips[i][\"service_id\"];\r\n        if (!freqByService[serviceId]) {\r\n            freqByService[serviceId] = {\r\n                calendar: await gtfs.getCalendar(pkg, provider, serviceId),\r\n                freqs: []\r\n            };\r\n        }\r\n        obj = freqByService[serviceId];\r\n        freqs = await gtfs.getFrequencies(pkg, provider, tripId);\r\n        for (var freq of freqs) {\r\n            exist = false;\r\n            for (var savedFreq of obj.freqs) {\r\n                if (savedFreq[\"start_time\"] === freq[\"start_time\"] &&\r\n                    savedFreq[\"end_time\"] === freq[\"end_time\"] &&\r\n                    savedFreq[\"headway_secs\"] === freq[\"headway_secs\"]) {\r\n                    exist = true;\r\n                    break;\r\n                }\r\n            }\r\n            if (!exist) {\r\n                obj.freqs.push(freq);\r\n            }\r\n        }\r\n    }\r\n\r\n    //Header\r\n\r\n    var html =\r\n        \"<ul class=\\\"list-group\\\"><li class=\\\"list-group-item d-flex align-items-center route-selection\\\">\" +\r\n        \"    <div class=\\\"d-flex flex-column route-id\\\">\" +\r\n        \"        <div>\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</div>\" +\r\n        \"        <div>\" + Lang.localizedKey(route, \"route_short_name\") + \"</div>\" +\r\n        \"    </div>\" +\r\n        \"    <div class=\\\"d-flex flex-column stop-info mr-auto\\\">\" +\r\n        \"        <div><b>\" + $.i18n(\"transit-eta-to\") + \":</b> \" + gtfs.selectAgencyStopName(agencyId, Lang.localizedKey(lastStop, \"stop_name\")) + \"</div><div>\";\r\n\r\n    var hasBadgeBefore = false;\r\n\r\n    if (stopTimes[0][\"stop_id\"] === lastStop[\"stop_id\"]) {\r\n        hasBadgeBefore = true;\r\n        html +=\r\n            \"<span class=\\\"badge badge-secondary\\\">\" +\r\n            $.i18n(\"transit-circular-path\") +\r\n            \"</span>\"\r\n            ;\r\n    }\r\n\r\n    var pathCalendars = [];\r\n    for (var serviceId in freqByService) {\r\n        pathCalendars.push(freqByService[serviceId].calendar);\r\n    }\r\n\r\n    var calendar = combineCalendars(pathCalendars);\r\n    var calendarText = describeCalendar(calendar)\r\n    if (calendarText) {\r\n        if (hasBadgeBefore) {\r\n            html += \" \";\r\n            hasBadgeBefore = false;\r\n        }\r\n        html +=\r\n            \"<span class=\\\"badge badge-secondary\\\">\" +\r\n            calendarText +\r\n            \"</span>\"\r\n            ;\r\n    }\r\n\r\n    html +=\r\n        \"</div></div></li></ul>\" +\r\n        \"<ul class=\\\"nav nav-pills nav-fill m-2\\\" role=\\\"tablist\\\" id=\\\"pills-route-list-tab\\\">\" +\r\n        \"    <li class=\\\"nav-item\\\">\" +\r\n        \"        <a class=\\\"nav-link active\\\" id=\\\"pills-route-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#pills-route\\\" role=\\\"tab\\\" aria-controls=\\\"pills-route\\\" aria-selected=\\\"true\\\">\" + $.i18n(\"transit-route-tab-route-list\") + \"</a>\" +\r\n        \"    </li>\" +\r\n        \"    <li class=\\\"nav-item\\\">\" +\r\n        \"        <a class=\\\"nav-link\\\" id=\\\"pills-timetable-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#pills-timetable\\\" role=\\\"tab\\\" aria-controls=\\\"pills-timetable\\\" aria-selected=\\\"false\\\">\" + $.i18n(\"transit-route-tab-timetable\") + \"</a>\" +\r\n        \"    </li>\" +\r\n        \"    <li class=\\\"nav-item\\\">\" +\r\n        \"        <a class=\\\"nav-link disabled\\\" id=\\\"pills-other-routes-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#pills-other-routes\\\" role=\\\"tab\\\" aria-controls=\\\"pills-other-routes\\\" aria-selected=\\\"false\\\">\" + $.i18n(\"transit-route-tab-other-routes\") + \"</a>\" +\r\n        \"    </li>\" +\r\n        \"</ul>\"\r\n        ;\r\n    $(\".split-map-tab-panel\").html(html);\r\n\r\n    //Route Tab\r\n\r\n    html =\r\n        \"<div class=\\\"tab-content\\\" id=\\\"pills-route-list-tabContent\\\">\" +\r\n        \"    <div class=\\\"tab-pane fade show active\\\" id=\\\"pills-route\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"pills-route-tab\\\">\" +\r\n        \"        <div class=\\\"row\\\" style=\\\"padding: 2%;\\\">\" +\r\n        \"            <div class=\\\"timeline-centered\\\">\"\r\n        ;\r\n    var i;\r\n    var stop;\r\n    for (i = 0; i < stopTimes.length; i++) {\r\n        //TODO: Fare attributes and rules\r\n        stop = await gtfs.getStop(pkg, provider, stopTimes[i][\"stop_id\"]);\r\n        html +=\r\n            \"<article class=\\\"timeline-entry\\\" data-gtw-package=\\\"\" + pkg + \"\\\" data-gtw-provider=\\\"\" + provider + \"\\\" data-gtw-agency=\\\"\" + agencyId + \"\\\" data-gtw-route-id=\\\"\" + routeId + \"\\\" data-gtw-path-id=\\\"\" + pathId + \"\\\" data-gtw-stop-id=\\\"\" + stop[\"stop_id\"] + \"\\\">\" +\r\n            \"    <div class=\\\"timeline-entry-inner\\\">\" +\r\n            \"        <div class=\\\"timeline-icon bg-light\\\">\" +\r\n            \"            \" + (i + 1) +\r\n            \"        </div>\" +\r\n            \"        <div class=\\\"timeline-label\\\">\" +\r\n            \"            <h2><button style=\\\"padding: 0px;\\\" class=\\\"btn btn-link\\\" data-gtw-package=\\\"\" + pkg + \"\\\" data-gtw-provider=\\\"\" + provider + \"\\\" data-gtw-agency=\\\"\" + agencyId + \"\\\" data-gtw-route-id=\\\"\" + routeId + \"\\\" data-gtw-path-id=\\\"\" + pathId + \"\\\" data-gtw-stop-id=\\\"\" + stop[\"stop_id\"] + \"\\\" data-gtw-stop-sequence=\\\"\" + stopTimes[i][\"stop_sequence\"] + \"\\\" data-gtw-stop-index=\\\"\" + i + \"\\\">\" + gtfs.selectAgencyStopName(agencyId, Lang.localizedKey(stop, \"stop_name\")) + \"</button></h2>\" +\r\n            \"            <p class=\\\"stop-eta-info\\\"></p>\" +\r\n            \"        </div>\" +\r\n            \"    </div>\" +\r\n            \"</article>\"\r\n            ;\r\n    }\r\n    html +=\r\n        \"            </div>\" +\r\n        \"        </div>\" +\r\n        \"    </div>\" +\r\n        \"    <div class=\\\"tab-pane fade\\\" id=\\\"pills-timetable\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"pills-timetable-tab\\\">\";\r\n\r\n    //Timetable Tab\r\n\r\n    var tabs = \"<ul class=\\\"nav nav-pills nav-fill mb-3\\\" id=\\\"calendar-tab\\\" role=\\\"tablist\\\">\";\r\n    var tabContent = \"<div class=\\\"tab-content\\\" id=\\\"calendar-tabContent\\\">\";\r\n    var calendarDesc;\r\n\r\n    var date = new Date();\r\n    var isCurrentService = {};\r\n    var hasCurrent = false;\r\n    for (var serviceId in freqByService) {\r\n        var currentService = freqByService[serviceId].calendar[JS_WEEKDAY_NAMES[date.getDay()]] === 1;\r\n        isCurrentService[serviceId] = currentService;\r\n        hasCurrent |= currentService;\r\n    }\r\n\r\n    var i = 0;\r\n    for (var serviceId in freqByService) {\r\n        obj = freqByService[serviceId];\r\n        calendarDesc = describeCalendar(obj.calendar, true);\r\n\r\n        var active;\r\n        var current;\r\n        if (hasCurrent) {\r\n            current = isCurrentService[serviceId];\r\n            active = current;\r\n        } else {\r\n            current = false;\r\n            active = i === 0;\r\n        }\r\n\r\n        tabs +=\r\n            \"<li class=\\\"nav-item\\\">\" +\r\n            \"    <a class=\\\"nav-link\" + (active ? \" active\" : \"\") + \"\\\" id=\\\"calendar-\" + serviceId + \"-tab\\\" data-toggle=\\\"pill\\\" href=\\\"#calendar-\" + serviceId + \"\\\" role=\\\"tab\\\" aria-controls=\\\"calendar-\" + serviceId + \"\\\" aria-selected=\\\"\" + (active ? \"true\" : \"false\") + \"\\\">\" + (current ? \"<i class=\\\"fas fa-hourglass-half\\\"></i> \" : \"\") + calendarDesc + \"</a>\" +\r\n            \"</li>\"\r\n            ;\r\n        tabContent +=\r\n            \"<div class=\\\"tab-pane fade\" + (active ? \" show active\" : \"\") + \"\\\" id=\\\"calendar-\" + serviceId + \"\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"calendar-\" + serviceId + \"-tab\\\">\" +\r\n            \"    <table class=\\\"table\\\">\" +\r\n            \"        <thead class=\\\"thead-light\\\">\" +\r\n            \"            <tr>\" +\r\n            \"                <th scope=\\\"col\\\" colspan=\\\"\" + (current && hasCurrent ? \"4\" : \"3\") + \"\\\">\" + $.i18n(\"transit-calendar-header-timeslot\") + \"</th>\" +\r\n            \"                <th scope=\\\"col\\\">\" + $.i18n(\"transit-calendar-header-headway-min\") + \"</th>\" +\r\n            \"            </tr>\" +\r\n            \"        </thead>\" +\r\n            \"        <tbody>\";\r\n        i++;\r\n\r\n        if (obj.freqs.length > 0) {\r\n            for (var freq of obj.freqs) {\r\n                var min = Math.round(freq[\"headway_secs\"] / 60);\r\n                tabContent +=\r\n                    \"            <tr>\";\r\n\r\n                if (current && hasCurrent) {\r\n                    if (gtfs.isCurrentFrequency(freq)) {\r\n                        tabContent +=\r\n                            \"                <td><i class=\\\"fas fa-hourglass-half\\\"></i></td>\";\r\n                    } else {\r\n                        tabContent +=\r\n                            \"                <td></td>\";\r\n                    }\r\n                }\r\n\r\n                tabContent +=\r\n                    \"                <td>\" + freq[\"start_time\"] + \"</td>\" +\r\n                    \"                <td>-</td>\" +\r\n                    \"                <td>\" + freq[\"end_time\"] + \"</td>\" +\r\n                    \"                <td>\" + min + \"</td>\" +\r\n                    \"            </tr>\";\r\n            }\r\n        } else {\r\n            tabContent +=\r\n                \"                <td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-no-timetable\") + \"</td>\" +\r\n                \"            </tr>\";\r\n        }\r\n\r\n        tabContent +=\r\n            \"        </tbody>\" +\r\n            \"    </table>\" +\r\n            \"</div>\";\r\n    }\r\n    tabs += \"</ul>\";\r\n\r\n    html +=\r\n        tabs + tabContent +\r\n        \"    </div>\" +\r\n        \"    <div class=\\\"tab-pane fade\\\" id=\\\"pills-other-routes\\\" role=\\\"tabpanel\\\" aria-labelledby=\\\"pills-other-routes-tab\\\">\";\r\n\r\n    //Other routes tab\r\n\r\n    html +=\r\n        \"</div>\" +\r\n        \"</div>\"\r\n        ;\r\n    $(\".split-map-container\").html(html);\r\n\r\n    $(\".split-map-container button\").on(\"click\", function () {\r\n        var pkg = $(this).attr(\"data-gtw-package\");\r\n        var provider = $(this).attr(\"data-gtw-provider\");\r\n        var agencyId = $(this).attr(\"data-gtw-agency\");\r\n        var routeId = $(this).attr(\"data-gtw-route-id\");\r\n        var pathId = $(this).attr(\"data-gtw-path-id\");\r\n        var stopId = $(this).attr(\"data-gtw-stop-id\");\r\n        routeListSelectStop(pkg, provider, agencyId, routeId, pathId, stopTimes, stopId);\r\n    });\r\n\r\n    //I don't know why Bootstrap's tab is not working... custom JS code\r\n    $(\".nav-pills[role='tablist'] .nav-item a\").on(\"click\", function () {\r\n        var thisId = $(this).parent().parent().attr(\"id\");\r\n        var index = thisId.lastIndexOf(\"-tab\");\r\n        var newStr = thisId.substr(0, index) + \"-tabContent\";\r\n        var con = $(this).attr(\"aria-controls\");\r\n        $(\".tab-content[id='\" + newStr + \"']\").children(\".tab-pane\").each(function () {\r\n            var elId = $(this).attr(\"id\");\r\n            if (elId !== con) {\r\n                $(this).removeClass(\"show\");\r\n                $(this).removeClass(\"active\");\r\n            } else {\r\n                $(this).addClass(\"show\");\r\n                $(this).addClass(\"active\");\r\n                if (!elId.startsWith(\"calendar-\")) {\r\n                    $(this)[0].scrollIntoView();\r\n                }\r\n            }\r\n        });\r\n    });\r\n\r\n    if (draw) {\r\n        await drawTripOnMap(stopTimes);\r\n    }\r\n\r\n    adjustMargin();\r\n}\r\n\r\nasync function routeListSelectStop(pkg, provider, agencyId, routeId, pathId, stopTimes, stopId) {\r\n    var parent = screen.width >= 768 ? \".desktop\" : \".mobile\";\r\n\r\n    var node = $(parent + \" .timeline-entry[data-gtw-stop-id='\" + stopId + \"']\");\r\n    var notNode = $(parent + \" .timeline-entry:not([data-gtw-stop-id='\" + stopId + \"'])\");\r\n\r\n    var icon = node.children(\".timeline-entry-inner\").children(\".timeline-icon\");\r\n    var notIcon = node.children(\".timeline-entry-inner\").children(\".timeline-icon\");\r\n\r\n    icon.removeClass(\"bg-light\");\r\n    icon.addClass(\"bg-primary\");\r\n\r\n    notIcon.addClass(\"bg-light\");\r\n    notIcon.removeClass(\"bg-primary\");\r\n\r\n    //var nodeP = node.children(\".timeline-entry-inner\").children(\".timeline-label\").children(\"p\");\r\n    var notNodeP = notNode.children(\".timeline-entry-inner\").children(\".timeline-label\").children(\"p\");\r\n\r\n    notNodeP.html(\"\");\r\n\r\n    if (scroll) {\r\n        var scrollNode = node[0];\r\n        if (scrollNode === undefined) {\r\n            scrollNode = $(parent + \" .timeline-entry\")[0];\r\n        }\r\n        scrollNode.scrollIntoView();\r\n    }\r\n\r\n    if (stopId) {\r\n        var agency = await gtfs.getAgency(pkg, provider, agencyId);\r\n        var route = await gtfs.getRoute(pkg, provider, routeId);\r\n        var trip = await gtfs.getCurrentTrip(pkg, provider, route[\"route_id\"]);\r\n        var stop = await gtfs.getStop(pkg, provider, stopId);\r\n\r\n        var targetPos = { lat: stop[\"stop_lat\"], lng: stop[\"stop_lon\"] };\r\n\r\n        Map.setCenter(targetPos);\r\n        Map.setZoom(18);\r\n\r\n        showStopEta(agency, route, trip, stopTimes, stop);\r\n    }\r\n}\r\n\r\nvar realtimeShown;\r\n\r\nasync function showGtfsStaticFrequencies(pkg, provider, routeId, stopId, pathId) {\r\n    var tableNode = $(\".timeline-entry[data-gtw-stop-id='\" + stopId + \"'] p table tbody\");\r\n\r\n    var freqs = await gtfs.getRoutePathFrequencies(pkg, provider, routeId, pathId);\r\n\r\n    var currFreq = -1;\r\n    var i;\r\n    for (i = 0; i < freqs.length; i++) {\r\n        if (gtfs.isCurrentFrequency(freqs[i])) {\r\n            currFreq = i;\r\n            break;\r\n        }\r\n    }\r\n\r\n    var content = \"\";\r\n    if (currFreq !== -1) {\r\n        var len = currFreq + 3 >= freqs.length ? freqs.length : currFreq + 3;\r\n        for (var i = currFreq; i < len; i++) {\r\n            var min = Math.round(freqs[i][\"headway_secs\"] / 60);\r\n\r\n            var time = gtfs.timeToDate(freqs[i][\"start_time\"]);\r\n\r\n            content +=\r\n                \"<tr class=\\\"table-secondary\" + (i == currFreq ? \" active\" : \"\") + \"\\\">\" +\r\n                \"    <td>\" + $.i18n(\"transit-eta-every-minutes\", min) + \"</td>\" +\r\n                \"    <td colspan=\\\"2\\\">\" + Misc.fillZero(time.getHours()) + \":\" + Misc.fillZero(time.getMinutes()) + \"</td>\" +\r\n                \"</tr>\";\r\n        }\r\n    } else if (freqs.length === 0) {\r\n        content +=\r\n            \"<tr class=\\\"table-dark\\\">\" +\r\n            \"    <td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-no-timetable\") + \"</td>\" +\r\n            \"</tr>\";\r\n    } else {\r\n        content +=\r\n            \"<tr class=\\\"table-dark\\\">\" +\r\n            \"    <td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-not-in-service\") + \"</td>\" +\r\n            \"</tr>\";\r\n    }\r\n\r\n    if (!realtimeShown) {\r\n        tableNode.html(content);\r\n    }\r\n}\r\n\r\nvar updatingStopEta = false;\r\n\r\nasync function updateStopEta(agency, route, trip, stopTimes, stop) {\r\n    if (updatingStopEta) {\r\n        return;\r\n    }\r\n    updatingStopEta = true;\r\n    $(\".eta-loading-spinner\").css(\"display\", \"\");\r\n    try {\r\n        var returned = await TransitEta.fetchEta({\r\n            etaProviders: agency[\"agency_id\"].split(\"+\"),\r\n            agency: agency,\r\n            route: route,\r\n            trip: trip,\r\n            stopTimes: stopTimes,\r\n            stop: stop\r\n        });\r\n        $(\".stop-eta-msg\").remove();\r\n        $(\".eta-loading-spinner\").css(\"display\", \"none\");\r\n        console.log(returned);\r\n        var opt = returned.options;\r\n        var content = \"\";\r\n        var node = $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] .stop-eta-info table tbody\");\r\n        if (returned.code === -2) {\r\n            var html = \"<p class=\\\"stop-eta-msg\\\">*\" + $.i18n(\"transit-eta-no-eta-providers\") + \"</p>\";\r\n            ;\r\n            $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] .stop-eta-info\").append(html);\r\n        } else if (returned.code === -1 || (returned.feeds && returned.feeds.length === 0)) {\r\n            var html = \"<p class=\\\"stop-eta-msg\\\">*\" + $.i18n(\"transit-eta-no-data-received\") + \"</p>\";\r\n            ;\r\n            $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] .stop-eta-info\").append(html);\r\n        } else {\r\n            var alerts = [];\r\n            var pairs = [];\r\n            for (var feed of returned.feeds) {\r\n                for (var entity of feed.entity) {\r\n                    var tripUpdate = entity[\"tripUpdate\"];\r\n                    if (tripUpdate) {\r\n                        var timestamp = tripUpdate.timestamp ? tripUpdate.timestamp : feed.header.timestamp;\r\n                        pairs.push({\r\n                            timestamp: timestamp,\r\n                            entity: entity\r\n                        });\r\n                    }\r\n\r\n                    if (entity[\"alert\"]) {\r\n                        alerts.push(entity[\"alert\"]);\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (alerts.length > 0) {\r\n                var alertsHtml = \"\";\r\n                if (alerts.length === 1) {\r\n                    alertsHtml =\r\n                        \"<div class=\\\"stop-eta-msg alert alert-warning\\\"><i class=\\\"fas fa-exclamation-triangle\\\"></i> <b>\" + Lang.translatedString(alerts[0].headerText) + \"</b></div>\";\r\n                } else {\r\n                    alertsHtml =\r\n                        \"<div class=\\\"stop-eta-msg alert alert-warning\\\"><i class=\\\"fas fa-exclamation-triangle\\\"></i> <b>\" + $.i18n(\"transit-eta-alerts-affecting-stop\", alerts.length) + \"</b> <button class=\\\"btn btn-link view-alert-btn\\\">\" + $.i18n(\"transit-eta-view-alerts-affecting-stop\") + \"</button></div>\";\r\n                }\r\n                $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] .stop-eta-info\").prepend(alertsHtml);\r\n                $(\".view-alert-btn\").on(\"click\", function () {\r\n                    UI.showModal(\"viewgtfsalerts\", alerts);\r\n                });\r\n            }\r\n\r\n            if (pairs.length === 0) {\r\n                var html = \"<p class=\\\"stop-eta-msg\\\">*\" + $.i18n(\"transit-eta-no-schedules-pending\") + \"</p>\";\r\n                ;\r\n                $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] .stop-eta-info\").append(html);\r\n            } else {\r\n                var content = \"\";\r\n\r\n                var active = false;\r\n                for (var pair of pairs) {\r\n                    var stopTimeUpdates = pair.entity.tripUpdate[\"stopTimeUpdate\"];\r\n                    if (stopTimeUpdates && stopTimeUpdates.length > 0) {\r\n                        for (var stopTimeUpdate of stopTimeUpdates) {\r\n                            if (!stopTimeUpdate[\"scheduleRelationship\"] || stopTimeUpdate[\"scheduleRelationship\"] === \"SCHEDULED\") {\r\n                                var etaTime;\r\n                                //TODO: Calculate non-absolute time from trips\r\n                                if (stopTimeUpdate.departure) {\r\n                                    etaTime = stopTimeUpdate.departure.time;\r\n                                } else if (stopTimeUpdate.arrival) {\r\n                                    etaTime = stopTimeUpdate.arrival.time;\r\n                                }\r\n\r\n                                var eta = Math.floor((etaTime - pair.timestamp) / 1000 / 60);\r\n\r\n                                var html = \"<tr class=\\\"table-\";\r\n\r\n                                if (eta >= 20) {\r\n                                    html += \"secondary\";\r\n                                } else if (eta >= 15) {\r\n                                    html += \"info\";\r\n                                } else if (eta >= 10) {\r\n                                    html += \"success\";\r\n                                } else if (eta >= 5) {\r\n                                    html += \"warning\";\r\n                                } else if (eta >= 1) {\r\n                                    html += \"danger\";\r\n                                } else {\r\n                                    html += \"dark\";\r\n                                }\r\n\r\n                                if (!active && eta > 0) {\r\n                                    active = true;\r\n                                    html += \" active\";\r\n                                }\r\n\r\n                                html += \"\\\">\";\r\n\r\n                                /*\r\n                                //TODO: isOutdated\r\n    \r\n                                var provider = TransitEta.getProvider(schedule.provider);\r\n                                if (!provider) {\r\n                                    console.error(\"Error: Could not find TransitEta provider to get localized names: \" + schedule.provider);\r\n                                    return;\r\n                                }\r\n                                */\r\n\r\n                                var colspan = 4;\r\n\r\n                                /*\r\n                                if (opt.etaProviders.length > 1) {\r\n                                    html += \"<td>\" + Lang.localizedKey(provider, \"name\") + \"</td>\";\r\n                                    colspan--;\r\n                                }\r\n                                */\r\n\r\n                                if (pair.entity[\"vehicle\"] && pair.entity[\"vehicle\"][\"vehicle\"] && pair.entity[\"vehicle\"][\"vehicle\"][\"label\"]) {\r\n                                    html += \"<td>\" + pair.entity[\"vehicle\"][\"vehicle\"][\"label\"] + \"</td>\";\r\n                                    colspan--;\r\n                                }\r\n\r\n                                /*\r\n                                if (schedule.msg !== undefined && schedule.time === undefined) {\r\n                                    html += \"<td colspan=\\\"\" + colspan + \"\\\">\" + schedule.msg + \"</td>\";\r\n                                }\r\n                                */\r\n\r\n                                html += \"<td>\";\r\n                                /*\r\n                                if (schedule.msg !== undefined) {\r\n                                    html += schedule.msg;\r\n                                }\r\n                                if (schedule.time !== undefined) {\r\n                                    if (schedule.msg !== undefined) {\r\n                                        html += \"<br />\";\r\n                                    }\r\n                                }\r\n                                */\r\n\r\n                                if (eta > 0) {\r\n                                    html += $.i18n(\"transit-eta-minutes\", eta);\r\n                                } else {\r\n                                    html += $.i18n(\"transit-eta-arrived-left\");\r\n                                }\r\n\r\n                                html += \"</td><td\";\r\n\r\n                                /*\r\n                                if (schedule.isLive === undefined) {\r\n                                }\r\n                                */\r\n                                html += \" colspan=\\\"2\\\"\";\r\n\r\n                                html += \">\";\r\n\r\n                                var time = new Date(etaTime);\r\n\r\n                                html += Misc.fillZero(time.getHours()) + \":\" + Misc.fillZero(time.getMinutes());\r\n                                /*\r\n                                if (schedule.time !== undefined) {\r\n                                } else {\r\n                                    html += \"---\";\r\n                                }\r\n                                */\r\n\r\n                                html += \"</td>\";\r\n\r\n                                /*\r\n                                if (schedule.isLive !== undefined) {\r\n                                    if (schedule.isLive) {\r\n                                        html += \"<td><span style=\\\"color: red; float: right; font-size: 10px;\\\"><i class=\\\"fa fa-circle\\\"></i> \" + $.i18n(\"transit-eta-live\") + \"</span></td>\";\r\n                                    } else {\r\n                                        html += \"<td><span style=\\\"font-size: 10px; float: right; font-style: italic;\\\">\" + $.i18n(\"transit-eta-scheduled\") + \"</span></td>\";\r\n                                    }\r\n                                }\r\n                                */\r\n\r\n                                html += \"</tr>\";\r\n                                content += html;\r\n                            } else {\r\n                                //TODO: cancelled\r\n                            }\r\n                        }\r\n                    } else {\r\n                        //TODO: NO Data\r\n                    }\r\n                }\r\n\r\n                $(\".timeline-entry[data-gtw-stop-id='\" + opt.stop[\"stop_id\"] + \"'] .stop-eta-info table tbody\").html(content);\r\n                realtimeShown = true;\r\n            }\r\n        }\r\n    } catch (options) {\r\n        $(\".eta-loading-spinner\").css(\"display\", \"none\");\r\n        var html = \"<p class=\\\"text-danger stop-eta-msg\\\">*\" + $.i18n(\"transit-eta-error-fetching-eta\") + \"</p>\";\r\n        ;\r\n        $(\".timeline-entry[data-gtw-stop-id='\" + stop[\"stop_id\"] + \"'] .stop-eta-info\").append(html);\r\n        //var node = $(\".timeline-entry[data-gtw-stop-id='\" + options.stop[\"stop_id\"] + \"'] p table tbody\");\r\n        //node.html(\"<tr class=\\\"table-danger\\\"><td colspan=\\\"4\\\">\" + $.i18n(\"transit-eta-error-fetching-eta\") + \"</td></tr>\");\r\n    }\r\n    updatingStopEta = false;\r\n}\r\n\r\nvar showingStopEta = false;\r\n\r\nasync function showStopEta(agency, route, trip, stopTimes, stop) {\r\n    if (showingStopEta) {\r\n        return;\r\n    }\r\n    showingStopEta = true;\r\n\r\n    var node = $(\".timeline-entry[data-gtw-stop-id='\" + stop[\"stop_id\"] + \"'] .stop-eta-info\");\r\n\r\n    var content =\r\n        \"<u>\" + $.i18n(\"transit-eta\") + \"</u> <div class=\\\"spinner-border spinner-border-sm eta-loading-spinner\\\" role=\\\"status\\\"></div>\" +\r\n        \"<table class=\\\"table stop-eta\\\">\" +\r\n        \"    <tr class=\\\"table-dark\\\">\" +\r\n        \"        <td colspan=\\\"4\\\"><div class=\\\"spinner-border spinner-border-sm\\\" role=\\\"status\\\"></div> \" + $.i18n(\"transit-eta-retrieving-data\") + \"</td>\" +\r\n        \"    </tr>\" +\r\n        \"</table>\";\r\n    node.html(content);\r\n\r\n    //\r\n    // GTFS-static freqencies\r\n    //\r\n\r\n    realtimeShown = false;\r\n    showGtfsStaticFrequencies(route[\"package\"], route[\"provider\"], route[\"route_id\"], stop[\"stop_id\"], stopTimes[0][\"path_id\"]);\r\n\r\n    //\r\n    // GTFS Realtime data\r\n    //\r\n\r\n    clearInterval(updateStopEtaTimer);\r\n    var func = function () {\r\n        updateStopEta(agency, route, trip, stopTimes, stop);\r\n    };\r\n    func();\r\n    updateStopEtaTimer = setInterval(func, 30000);\r\n\r\n    showingStopEta = false;\r\n}\r\n\r\nfunction updateEta() {\r\n    var requestLen = RequestLimiter.requests.length;\r\n    if (requestLen > 0) {\r\n        $(\".request-progress-panel\").fadeIn(500);\r\n\r\n        var max = maxRequest;\r\n        if (!max || requestLen > max) {\r\n            max = maxRequest = requestLen;\r\n        }\r\n\r\n        $(\".request-progress-panel .progress-bar\").html($.i18n(\"transit-eta-requesting-data\", max - requestLen, max));\r\n        //$(\".request-progress-panel .progress-bar\").html(Math.floor((max - requestLen) / max * 100) + \"%\");\r\n        $(\".request-progress-panel .progress-bar\").css(\"width\", Math.floor((max - requestLen) / max * 100) + \"%\");\r\n    } else {\r\n        maxRequest = 0;\r\n        $(\".request-progress-panel .progress-bar\").css(\"width\", \"100%\");\r\n        $(\".request-progress-panel\").fadeOut(500, function () {\r\n            $(\".request-progress-panel .progress-bar\").css(\"width\", \"0%\");\r\n        });\r\n    }\r\n    //var h;\r\n    for (var result of allNearbyRoutes) {\r\n        var agency = gtfs.get\r\n        var p = TransitEta.fetchEta({\r\n            etaProviders: result.route[\"agency_id\"].split(\"+\"),\r\n            agency: result.agency,\r\n            route: result.route,\r\n            trip: result.trip,\r\n            stop: result.stop,\r\n            stopTimes: result.path\r\n        });\r\n        p.then(function (returned) {\r\n            var text = \"\";\r\n            var opt = returned.options;\r\n\r\n            var node = $(\".nearby-route-list .route-selection[data-gtw-package=\\\"\" + opt.agency[\"package\"] + \"\\\"][data-gtw-provider=\\\"\" + opt.agency[\"provider\"] + \"\\\"][data-gtw-agency=\\\"\" + opt.agency[\"agency_id\"] + \"\\\"][data-gtw-route-id=\\\"\" + opt.route[\"route_id\"] + \"\\\"][data-gtw-path-id=\\\"\" + opt.trip[\"path_id\"] + \"\\\"][data-gtw-stop-id=\\\"\" + opt.stop[\"stop_id\"] + \"\\\"]\");\r\n\r\n            node.removeClass(\"list-group-item-secondary\");\r\n            node.removeClass(\"list-group-item-info\");\r\n            node.removeClass(\"list-group-item-success\");\r\n            node.removeClass(\"list-group-item-warning\");\r\n            node.removeClass(\"list-group-item-danger\");\r\n            node.removeClass(\"list-group-item-light\");\r\n            node.removeClass(\"list-group-item-dark\");\r\n\r\n            var badgeClass = \"btn-secondary\";\r\n\r\n            if (returned.code < 0) {\r\n                text = $.i18n(\"transit-eta-route-not-available-short\");\r\n                node.addClass(\"list-group-item-light\");\r\n            } else if (returned.feeds.length === 0) {\r\n                text = $.i18n(\"transit-eta-no-feed-received\");\r\n                node.addClass(\"list-group-item-light\");\r\n            } else {\r\n                var pairs = [];\r\n                for (var feed of returned.feeds) {\r\n                    for (var entity of feed.entity) {\r\n                        var tripUpdate = entity[\"tripUpdate\"];\r\n                        if (tripUpdate) {\r\n                            var timestamp = tripUpdate.timestamp ? tripUpdate.timestamp : feed.header.timestamp;\r\n                            pairs.push({\r\n                                timestamp: timestamp,\r\n                                tripUpdate: tripUpdate\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n                //TODO: Sort trip updates\r\n                /*\r\n                tripUpdates.sort((a, b) => {\r\n                    if (a[\"stop_time_update\"].departure && b[\"stop_time_update\"].departure) {\r\n                        return a[\"stop_time_update\"].departure - b[\"stop_time_update\"].departure;\r\n                    } else if (a[\"stop_time_update\"].arrival && b[\"stop_time_update\"].departure) {\r\n                        return a[\"stop_time_update\"].arrival - b[\"stop_time_update\"].departure;\r\n                    } else if (a[\"stop_time_update\"].departure && b[\"stop_time_update\"].arrival) {\r\n                        return a[\"stop_time_update\"].departure - b[\"stop_time_update\"].arrival;\r\n                    }\r\n                });\r\n                */\r\n                if (pairs.length === 0) {\r\n                    text = $.i18n(\"transit-eta-no-schedules-pending-short\");\r\n                    node.addClass(\"list-group-item-light\");\r\n                } else {\r\n                    var pair = pairs[0];\r\n\r\n                    var stopTimeUpdates = pair.tripUpdate[\"stopTimeUpdate\"];\r\n                    if (stopTimeUpdates && stopTimeUpdates.length > 0) {\r\n                        var stopTimeUpdate = stopTimeUpdates[0];\r\n\r\n                        if (!stopTimeUpdate[\"scheduleRelationship\"] || stopTimeUpdate[\"scheduleRelationship\"] === \"SCHEDULED\") {\r\n                            var etaTime;\r\n                            //TODO: Calculate non-absolute time from trips\r\n                            if (stopTimeUpdate.departure) {\r\n                                etaTime = stopTimeUpdate.departure.time;\r\n                            } else if (stopTimeUpdate.arrival) {\r\n                                etaTime = stopTimeUpdate.arrival.time;\r\n                            }\r\n\r\n                            //TODO: uncertainty\r\n\r\n                            var calcEta = Math.floor((etaTime - pair.timestamp) / 1000 / 60);\r\n\r\n                            var css = \"\";\r\n\r\n                            if (calcEta >= 20) {\r\n                                css = \"secondary\";\r\n                            } else if (calcEta >= 15) {\r\n                                css = \"info\";\r\n                            } else if (calcEta >= 10) {\r\n                                css = \"success\";\r\n                            } else if (calcEta >= 5) {\r\n                                css = \"warning\";\r\n                            } else if (calcEta >= 1) {\r\n                                css = \"danger\";\r\n                            } else {\r\n                                css = \"dark\";\r\n                            }\r\n                            node.addClass(\"list-group-item-\" + css);\r\n\r\n                            badgeClass = \"badge-primary\";\r\n                            if (calcEta > 0) {\r\n                                text += $.i18n(\"transit-eta-minutes\", calcEta);\r\n                            } else {\r\n                                text += $.i18n(\"transit-eta-arrived-left\", calcEta);\r\n                                badgeClass = \"badge-dark\";\r\n                            }\r\n                            /*\r\n                            if (schedule.msg !== undefined) {\r\n                                var msg = schedule.msg;\r\n                                if (msg.length > 20) {\r\n                                    text = $.i18n(\"transit-eta-transit-notice\");\r\n                                } else {\r\n                                    text = schedule.msg;\r\n                                }\r\n                                badgeClass = \"badge-warning\";\r\n                            } else if (schedule.time !== undefined) {\r\n                                if (schedule.msg !== undefined) {\r\n                                    text += \"<br />\";\r\n                                }\r\n\r\n                                if (schedule.isLive !== undefined) {\r\n                                    text += \"<br /><span style=\\\"font-size: 10px; position: absolute; top: 16px; right: 16px; \";\r\n                                    if (schedule.isLive) {\r\n                                        text += \"color: red;\\\"><i class=\\\"fa fa-circle\\\"></i> \" + $.i18n(\"transit-eta-live\") + \"</span>\";\r\n                                    } else {\r\n                                        text += \"color: black; font-style: italic;\\\">\" + $.i18n(\"transit-eta-scheduled\") + \"</span>\";\r\n                                    }\r\n                                }\r\n                            }\r\n                            */\r\n                        } else {\r\n                            //TODO: No data or skipped\r\n                            console.log(\"NODATA\");\r\n                        }\r\n                    } else {\r\n                        //TODO: Cancelled\r\n                        console.log(\"Cancelled\");\r\n                    }        \r\n                }\r\n            }\r\n\r\n            var badge = node.children(\".transit-eta\");\r\n\r\n            badge.removeClass(\"badge-primary\");\r\n            badge.removeClass(\"badge-secondary\");\r\n            badge.removeClass(\"badge-warning\");\r\n            badge.removeClass(\"badge-danger\");\r\n            badge.removeClass(\"badge-dark\");\r\n            badge.addClass(badgeClass);\r\n\r\n            badge.html(text);\r\n        }).catch(function (options, err) {\r\n            var node = $(\".nearby-route-list .route-selection[data-gtw-package=\\\"\" + options.agency[\"package\"] + \"\\\"][data-gtw-provider=\\\"\" + options.agency[\"provider\"] + \"\\\"][data-gtw-agency=\\\"\"  + options.agency[\"agency_id\"] + \"\\\"][data-gtw-route-id=\\\"\" + options.route[\"route_id\"] + \"\\\"][data-gtw-path-id=\\\"\" + options.trip[\"path_id\"] + \"\\\"][data-gtw-stop-id=\\\"\" + options.stop[\"stop_id\"] + \"\\\"]\");\r\n\r\n            node.removeClass(\"list-group-item-secondary\");\r\n            node.removeClass(\"list-group-item-info\");\r\n            node.removeClass(\"list-group-item-success\");\r\n            node.removeClass(\"list-group-item-warning\");\r\n            node.removeClass(\"list-group-item-danger\");\r\n            node.removeClass(\"list-group-item-light\");\r\n            node.removeClass(\"list-group-item-dark\");\r\n            node.addClass(\"list-group-item-light\");\r\n\r\n            var badge = node.children(\".transit-eta\");\r\n\r\n            badge.removeClass(\"badge-primary\");\r\n            badge.removeClass(\"badge-secondary\");\r\n            badge.removeClass(\"badge-warning\");\r\n            badge.removeClass(\"badge-danger\");\r\n            badge.removeClass(\"badge-dark\");\r\n            badge.addClass(\"badge-danger\");\r\n\r\n            badge.html($.i18n(\"transit-eta-error-fetching-eta-short\"));\r\n        });\r\n    }\r\n}\r\n\r\nasync function findNearbyRoutes() {\r\n    clearInterval(updateEtaTimer);\r\n\r\n    var pos = Loc.getCurrentPosition();\r\n\r\n    var lat = pos.lat;\r\n    var lng = pos.lng;\r\n\r\n    lastLat = lat;\r\n    lastLng = lng;\r\n\r\n    var range = Settings.get(\"min_nearby_transit_range\", 200) / 1000.0;\r\n\r\n    var st = Date.now();\r\n    var allNearbyStops = await gtfs.searchNearbyStops(lat, lng, range, true);\r\n\r\n    if (allNearbyStops.length === 0) {\r\n        var testRange = range;\r\n        do {\r\n            testRange += 0.05;\r\n            allNearbyStops = await gtfs.searchNearbyStops(lat, lng, testRange, true, true);\r\n        } while (allNearbyStops.length === 0 && testRange < 10);\r\n\r\n        if (testRange >= 10) {\r\n            $(\".tab-panel\").append(\r\n                \"<div class=\\\"alert alert-danger alert-dismissable\\\">\" +\r\n                \"<button type=\\\"button\\\" class=\\\"close\\\" data-dismiss=\\\"alert\\\" aria-hidden=\\\"true\\\" >&#215;</button>\" +\r\n                $.i18n(\"transit-eta-no-routes-found-10-km\") +\r\n                \"</div>\"\r\n            );\r\n        } else {\r\n            $(\".tab-panel\").append(\r\n                \"<div class=\\\"alert alert-warning alert-dismissable\\\">\" +\r\n                \"<button type=\\\"button\\\" class=\\\"close\\\" data-dismiss=\\\"alert\\\" aria-hidden=\\\"true\\\" >&#215;</button>\" +\r\n                $.i18n(\"transit-eta-no-routes-found-nearby-extended-range\", range * 1000, Math.ceil(testRange * 1000)) +\r\n                \"</div>\"\r\n            );\r\n        }\r\n    }\r\n    console.log(\"Used: \" + (Date.now() - st));\r\n\r\n    st = Date.now();\r\n    var maxNearbyBusDisplay = Settings.get(\"max_nearby_transit_to_display\", 20);\r\n    allNearbyRoutes = [];\r\n    console.log(allNearbyStops);\r\n\r\n    for (var stopResult of allNearbyStops) {\r\n        if (allNearbyRoutes.length >= maxNearbyBusDisplay) {\r\n            break;\r\n        }\r\n\r\n        var stop = stopResult.stop;\r\n\r\n        var pkg = stop[\"package\"];\r\n        var provider = stop[\"provider\"];\r\n\r\n        var stopRoutes = await gtfs.searchStopRoutes(pkg, provider, stop[\"stop_id\"]);\r\n\r\n        //TODO: seperate trips\r\n        for (var routeId in stopRoutes.trips) {\r\n            var trip = stopRoutes.trips[routeId];\r\n            var agency = await gtfs.getAgency(pkg, provider, stopRoutes.routes[routeId][\"agency_id\"]);\r\n            var path = await gtfs.getStopTimePathByPathId(pkg, provider, trip[\"path_id\"]);\r\n            allNearbyRoutes.push({\r\n                agency: agency,\r\n                route: stopRoutes.routes[routeId],\r\n                trip: trip,\r\n                stop: stop,\r\n                stopTime: stopRoutes.stopTimes[trip[\"path_id\"]],\r\n                path: path,\r\n                distance: stopResult.distance\r\n            });\r\n        }\r\n    }\r\n\r\n    console.log(\"Used: \" + (Date.now() - st));\r\n    st = Date.now();\r\n    allNearbyRoutes.sort((a, b) => {\r\n        return a.distance - b.distance;\r\n    });\r\n\r\n    console.log(\"Used: \" + (Date.now() - st));\r\n    st = Date.now();\r\n    console.log(allNearbyRoutes);\r\n\r\n    var distance;\r\n    //var paths;\r\n    //var stopId;\r\n\r\n    var stop;\r\n    var agency;\r\n    var html = \"<ul class=\\\"list-group\\\">\";\r\n    for (var result of allNearbyRoutes) {\r\n        //paths = result.route.paths[result.bound];\r\n        //stopId = paths[paths.length - 1];\r\n\r\n        distance = Math.round(result.distance * 1000);\r\n        agency = await gtfs.getAgency(result.route[\"package\"], result.route[\"provider\"], result.route[\"agency_id\"]);\r\n        stop = await gtfs.getStop(result.stopTime[\"package\"], result.stopTime[\"provider\"], result.stopTime[\"stop_id\"]);\r\n\r\n        html +=\r\n            \"    <li class=\\\"list-group-item list-group-item-action d-flex justify-content-between align-items-center route-selection\\\" data-gtw-package=\\\"\" + result.route[\"package\"] + \"\\\" data-gtw-provider=\\\"\" + result.route[\"provider\"] + \"\\\" data-gtw-agency=\\\"\" + result.route[\"agency_id\"] + \"\\\" data-gtw-route-id=\\\"\" + result.route[\"route_id\"] + \"\\\" data-gtw-path-id=\\\"\" + result.trip[\"path_id\"] + \"\\\" data-gtw-stop-id=\\\"\" + result.stopTime[\"stop_id\"] + \"\\\" data-gtw-stop-seq=\\\"\" + result.stopTime[\"stop_sequence\"] + \"\\\">\" +\r\n            \"        <div class=\\\"d-flex flex-column route-id\\\">\" +\r\n            \"            <div>\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</div>\" +\r\n            \"            <div>\" + Lang.localizedKey(result.route, \"route_short_name\") + \"</div>\" +\r\n            \"        </div>\" +\r\n            \"        <div class=\\\"d-flex flex-column stop-info mr-auto\\\">\" +\r\n            //\"            <div>\" + Lang.localizedKey(result.route, \"route_long_name\") + \"</div>\" +\r\n            //\"                <b>\" + $.i18n(\"transit-eta-to\") + \":</b> <small>\" + Lang.localizedKey(TransitStops.getStopById(stopId), \"stopName\") +\r\n            //\"</small></div>\" +\r\n            \"            <div>\" +\r\n            \"                \" + gtfs.selectAgencyStopName(agency[\"agency_id\"], Lang.localizedKey(stop, \"stop_name\")) + \" (\" + distance + $.i18n(\"transit-eta-metres\") + \")\" +\r\n            \"            </div>\" +\r\n            \"        </div>\" +\r\n            \"        <span class=\\\"badge badge-primary badge-pill transit-eta\\\">\" + $.i18n(\"transit-eta-retrieving\") + \"</span>\" +\r\n            \"    </li>\";\r\n    }\r\n    html += \"</ul>\";\r\n\r\n    $(\".nearby-route-list\").html(html);\r\n    console.log(\"Used: \" + (Date.now() - st));\r\n\r\n    $(\".nearby-route-list .route-selection\").on(\"mouseenter\", mouseEnterPreviewRoute);\r\n\r\n    $(\".nearby-route-list .route-selection\").on(\"mouseleave\", function () {\r\n        //Map.setCenter(Loc.getCurrentPosition());\r\n        //Map.setZoom(16);\r\n        //Map.removeAllMarkers();\r\n        //Map.removeAllPolylines();\r\n    });\r\n\r\n    $(\".nearby-route-list .route-selection\").on(\"click\", mouseClickSelectRoute);\r\n\r\n    filterProviderSort(\".nearby-route-list\");\r\n\r\n    updateEta();\r\n    updateEtaTimer = setInterval(updateEta, 30000);\r\n}\r\n\r\nfunction nearbyRoutesLocSuccess() {\r\n    var html =\r\n        \"<div class=\\\"d-flex justify-content-center w-100\\\">\" +\r\n        \"    <div class=\\\"text-center\\\">\" +\r\n        \"        <div class=\\\"spinner-grow m-5\\\" style=\\\"width: 3rem; height: 3rem;\\\"></div>\" +\r\n        \"        <div>\" + $.i18n(\"transit-searching-nearby-routes\") + \"</div>\" +\r\n        \"    </div>\" +\r\n        \"</div>\";\r\n    ;\r\n    $(\".nearby-route-list\").html(html);\r\n    findNearbyRoutes();\r\n}\r\n\r\nfunction nearbyRoutesLocError(error) {\r\n    var errorText;\r\n    console.log(error);\r\n    if (error.code === 1) {\r\n        errorText = $.i18n(\"location-error-user-denied-location\");\r\n    } else if (error.code === 2 || error.code === 3) {\r\n        errorText = $.i18n(\"location-error-could-not-get-location\");\r\n    } else {\r\n        errorText = $.i18n(\"location-error-unknown\", error.message);\r\n    }\r\n\r\n    var html =\r\n        \"<div class=\\\"d-flex justify-content-center w-100\\\">\" +\r\n        \"    <div class=\\\"text-center text-dark\\\">\" +\r\n        \"        <i class=\\\"fas fa-exclamation-triangle m-5\\\" style=\\\"width: 3rem; height: 3rem;\\\"></i>\" +\r\n        \"        <div class=\\\"ml-3 mr-3\\\">\" + errorText + \"</div>\" +\r\n        \"    </div>\" +\r\n        \"</div>\";\r\n    ;\r\n    $(\".nearby-route-list\").html(html);\r\n}\r\n\r\nexport async function enable() {\r\n    RequestLimiter.clear();\r\n    TransitEta.clearCache();\r\n\r\n    TouchKeypad.addListener(touchKeypadListener = function (obj) {\r\n        var searchText;\r\n        if ($(obj).hasClass(\"touch-keypad-function-done\")) {\r\n            hideTouchKeypad();\r\n            adjustMargin();\r\n        } else if ($(obj).hasClass(\"touch-keypad-function-backspace\")) {\r\n            searchText = $(\"#search-transit-text\").val();\r\n            $(\"#search-transit-text\").val(searchText.slice(0, -1));\r\n            searchRoutes();\r\n        } else if ($(obj).hasClass(\"touch-keypad-value\")) {\r\n            var val = $(obj).html();\r\n            searchText = $(\"#search-transit-text\").val();\r\n            $(\"#search-transit-text\").val(searchText + val);\r\n            searchRoutes();\r\n        }\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_UI_BACK, eventUiBackListener = function (){\r\n        if (searchMode) {\r\n            TouchKeypad.showTouchKeypad();\r\n        }\r\n        clearInterval(updateStopEtaTimer);\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_LOCATION_ERROR, eventLocErrorListener = function (error) {\r\n        nearbyRoutesLocError(error);\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_LOCATION_SUCCESS, eventLocSuccessListener = function () {\r\n        nearbyRoutesLocSuccess();\r\n    });\r\n\r\n    Event.addListener(Event.EVENTS.EVENT_LOCATION_CHANGE, eventLocChgListener = function () {\r\n        if (lastLat && lastLng) {\r\n            var newLoc = Loc.getCurrentPosition();\r\n            var dst = Misc.geoDistance(newLoc.lat, newLoc.lng, lastLat, lastLng);\r\n            if (dst > 0.125) {\r\n                console.log(\"Location moved 125 m away. Finding new nearby routes.\");\r\n                findNearbyRoutes();\r\n            }\r\n        }\r\n    });\r\n\r\n    var agencies = await gtfs.getAgencies();\r\n\r\n    if (agencies.length > 0) {\r\n        var buttonScroll =\r\n            \"<div class=\\\"hori-scroll btn-group\\\">\" +\r\n            \"    <button type=\\\"button\\\" class=\\\"btn btn-primary gtw-providersort gtw-providersort-all\\\"><i class=\\\"fa fa-reply-all\\\"></i><br />\" + $.i18n(\"transit-eta-sort-all\") + \"</button>\";\r\n\r\n        for (var agency of agencies) {\r\n            var image = \"fa-bus\";\r\n            buttonScroll += \" <button type=\\\"button\\\" class=\\\"btn btn-default gtw-providersort gtw-providersort-provider\\\" data-gtw-package=\\\"\" + agency[\"package\"] + \"\\\" data-gtw-provider=\\\"\" + agency[\"provider\"] + \"\\\" data-gtw-agency=\\\"\" + agency[\"agency_id\"] + \"\\\"><i class=\\\"fa \" + image + \"\\\"></i><br />\" + Lang.localizedKey(agency, \"agency_short_name\") + \"</button>\";\r\n        }\r\n\r\n        buttonScroll += \"</div>\";\r\n\r\n        $(\".tab-panel\").append(buttonScroll);\r\n\r\n        var searchField =\r\n            \"<div class=\\\"input-group mb-3\\\" style=\\\"margin-top: 16px;\\\">\" +\r\n            \"    <input type=\\\"text\\\" class=\\\"form-control\\\" placeholder=\\\"\" + $.i18n(\"transit-eta-placeholder-search-for-transit\") + \"\\\" aria-label=\\\"\" + $.i18n(\"transit-eta-placeholder-search-for-transit\") + \"\\\" aria-describedby=\\\"search-transit-icon\\\" id=\\\"search-transit-text\\\" readonly/>\" +\r\n            \"    <div class=\\\"input-group-append\\\">\" +\r\n            //\"        <span class=\\\"input-group-text\\\" id=\\\"search-transit-icon\\\"><i class=\\\"fas fa-search\\\"></i></span>\" +\r\n            \"        <button class=\\\"btn btn-light disabled\\\" type=\\\"button\\\" id=\\\"button-cancel-search\\\"><i class=\\\"fas fa-search\\\"></i></button>\" +\r\n            \"    </div>\" +\r\n            \"</div>\"\r\n            ;\r\n\r\n        $(\".tab-panel\").append(searchField);\r\n\r\n        var requestProgressBar =\r\n            \"<div class=\\\"request-progress-panel\\\">\" +\r\n            \"    <div class=\\\"progress bg-white\\\">\" +\r\n            \"        <div class=\\\"progress-bar progress-bar-striped progress-bar-animated\\\" role=\\\"progressbar\\\" style=\\\"width: 0%;\\\"></div>\" +\r\n            \"    </div>\" +\r\n            \"</div>\"\r\n            ;\r\n\r\n        $(\".tab-panel\").append(requestProgressBar);\r\n\r\n        $(\".gtw-providersort\").on(\"click\", function () {\r\n            if ($(this).hasClass(\"btn-primary\")) {\r\n                return;\r\n            }\r\n            //$(\".gtw-providersort\").removeClass(\"btn-default\");\r\n\r\n            if ($(this).hasClass(\"gtw-providersort-all\")) {\r\n                resetProviderSort();\r\n            } else {\r\n                $(\".gtw-providersort\").removeClass(\"btn-primary\");\r\n\r\n                var pkg = $(this).attr(\"data-gtw-package\");\r\n                var provider = $(this).attr(\"data-gtw-provider\");\r\n                var agency = $(this).attr(\"data-gtw-agency\");\r\n                $(this).addClass(\"btn-primary\");\r\n                \r\n                var cssCond = \"[data-gtw-package='\" + pkg + \"'][data-gtw-provider='\" + provider + \"'][data-gtw-agency='\" + agency + \"']\";\r\n\r\n                $(\".gtw-providersort-provider:not(\" + cssCond + \")\").addClass(\"btn-default\");\r\n                $(\".route-selection\" + cssCond).attr(\"style\", \"\");\r\n                $(\".route-selection:not(\" + cssCond + \")\").attr(\"style\", \"display: none!important\");\r\n            }\r\n        });\r\n\r\n        $(\"#button-cancel-search\").on(\"click\", function () {\r\n            if (!$(this).hasClass(\"disabled\")) {\r\n                clearSearch();\r\n            }\r\n        });\r\n\r\n        var useKeypad = true;\r\n        if (useKeypad) {\r\n            $(\"#search-transit-text\").on(\"click\", function () {\r\n                showTouchKeypad();\r\n                showSearchRoutes();\r\n            });\r\n        }\r\n\r\n        $(\"#search-transit-text\").on(\"input\", function () {\r\n            clearTimeout(searchTimeout);\r\n            searchTimeout = setTimeout(function () {\r\n                searchRoutes();\r\n            }, 500);\r\n        });\r\n\r\n        var contentHtml = \"<div class=\\\"row item-list nearby-route-list\\\"></div><div class=\\\"row item-list all-route-list\\\"></div>\";\r\n        $(\".content-panel-container\").html(contentHtml);\r\n\r\n        if (Loc.isErrored()) {\r\n            nearbyRoutesLocError(Loc.getError());\r\n        } else if (Loc.isLocated()) {\r\n            nearbyRoutesLocSuccess();\r\n        } else {\r\n            var html =\r\n                \"<div class=\\\"d-flex justify-content-center w-100\\\">\" +\r\n                \"    <div class=\\\"text-center\\\">\" +\r\n                \"        <div class=\\\"spinner-grow m-5\\\" style=\\\"width: 3rem; height: 3rem;\\\"></div>\" +\r\n                \"        <div>\" + $.i18n(\"transit-locating-your-location\") + \"</div>\" +\r\n                \"    </div>\" +\r\n                \"</div>\";\r\n            ;\r\n            $(\".nearby-route-list\").html(html);\r\n        }\r\n    } else {\r\n        //TODO: better message or auto add plugins according to region\r\n        $(\".tab-panel\").html(\"<br /><div class=\\\"alert alert-danger\\\" role=\\\"alert\\\"><i class=\\\"fas fa-exclamation-triangle\\\"></i> \" + $.i18n(\"transit-eta-no-plugins-providing-transit-data\") + \"</div>\");\r\n    }\r\n}\r\n\r\nexport function disable() {\r\n    TouchKeypad.removeListener(touchKeypadListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_UI_BACK, eventUiBackListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_LOCATION_ERROR, eventLocErrorListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_LOCATION_SUCCESS, eventLocSuccessListener);\r\n    Event.removeListener(Event.EVENTS.EVENT_LOCATION_CHANGE, eventLocChgListener);\r\n    clearTimeout(searchTimeout);\r\n    clearInterval(updateEtaTimer);\r\n    clearInterval(updateStopEtaTimer);\r\n    searchTimeout = false;\r\n    updateEtaTimer = false;\r\n}"],"sourceRoot":""}