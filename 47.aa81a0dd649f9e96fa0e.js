(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{195:function(t,e,r){"use strict";r.r(e),function(t){r.d(e,"onload",(function(){return p}));var o=r(33),a=r(22),n=r(6),s=r(32),i=r(43);function p(){return a.register("db.kmbeta.ml",!0),a.register("etav3.kmb.hk",!1),o.registerProvider("gtwp-kmblwb","kmblwb",["KMB","LWB"],new c),!0}var c=function(){this.checkDatabaseUpdate=function(e,r,o){t.ajax({url:"https://db.kmbeta.ml/kmbeta_db-version.json",cache:!1,dataType:"json",success:function(t){var r,a;try{r=parseInt(t.version),a=parseInt(o)}catch(t){console.error("Error: Could not parse kmbeta_db last updated time or cached version! Forcing to be no update"),e(!1)}e(r>a)},error:function(t){console.error("Error: Could not check kmbeta_db update!"),e(!1)}})},this.fetchEta=function(e,r,o){console.log(o);var a=o.agency.agency_id,p=!1;if(a.includes("+")){p=!0;var c=a.split("+");for(var d of c)if("KMB"===d||"LWB"===d){a=d;break}}if("KMB"!==a&&"LWB"!==a)return console.error("Error: Cannot request ETA from companies that are not KMB and LWB! Requested: "+a),void r();n.f("gtwp-hktransit","hktransit",a).then(a=>{var n=s.localizedKey(a,"agency_short_name"),c=o.trip.trip_id.split("-"),d=parseInt(c[1]),u=o.route.route_short_name,l=!1;for(var h of this.db.routes)if(h.routeId===u){l=h;break}if(!l)return console.error("Error: Could not find KMBLWB reference route using "+u),void r();if(l.paths[d-1].length!==o.stopTimes.length)return console.error("Error: KMBLWB reference route path mismatch with stop times."),void r();var f,m=-1;for(f=0;f<o.stopTimes.length;f++)if(o.stopTimes[f].stop_id===o.stop.stop_id){m=f;break}if(-1===m)return console.error("Error: Could not find KMBLWB stop index in stop times!"),void r();var b,g=l.paths[d-1][m],v=s.getLocale(),_="http://etav3.kmb.hk/?action=geteta&lang="+(b="zh"===v?"tc":"en")+"&route="+u+"&bound="+d+"&stop="+g+"&stop_seq="+(m+1);i.b(()=>{t.ajax({url:_,method:"GET",dataType:"json",cache:!1,success:function(t){var r,a,s=[],i=[],c=[],d={tripId:o.trip.trip_id,startTime:"00:00:00",startDate:"20190101"},u=new Date(t.generated),l=t.response;if(l&&l.length>0)for(k=0;k<l.length;k++){r=!1;var h=(a=l[k]).t.toLowerCase();if(h.length>=5){var f=parseInt(h.substring(0,2)),m=parseInt(h.substring(3,5));isNaN(f)||isNaN(m)||((r=new Date(t.updated)).setHours(f),r.setMinutes(m))}if(r)i.push({stopId:o.stop.stop_id,arrival:{time:r.getTime()}});else if(h.length>0){var g;g="tc"===b?"zh-HK":"en";var v="";p&&(v+=n+": ");var _=[{text:v+=a.t,language:g}];c.push({informedEntity:[{trip:d,stop_id:o.stop.stop_id}],headerText:{translation:_},descriptionText:{translation:_}})}}var k,w=Date.now();if(i.length>0){var B={label:n},y={id:o.agency.agency_id+"-"+o.stop.stop_id+"-"+o.route.route_short_name+"-trip-update-"+w,tripUpdate:{trip:d,timestamp:u,stopTimeUpdate:i}};p&&(y.vehicle={vehicle:B}),s.push(y)}if(c.length>0)for(k=0;k<c.length;k++){y={id:o.agency.agency_id+"-"+o.stop.stop_id+"-"+o.route.route_short_name+"-alert-"+k+"-"+w,alert:c[k]};s.push(y)}e({header:{gtfsRealtimeVersion:"2.0",incrementality:"FULL_DATASET",timestamp:w},entity:s})},error:function(t,e,o){r()}})})})},this.fetchDatabase=function(e,r){t.ajax({url:"https://db.kmbeta.ml/kmbeta_db.json",cache:!1,dataType:"json",success:function(t){t.routes&&t.stops&&t.version?(t.package="gtwp-kmblwb",t.provider="kmblwb",e(t)):console.error("Error: KMBLWB downloaded database is in wrong structure! Report to GitHub for this problem!")},error:function(t,e,o){r()}})}}}.call(this,r(0))}}]);
//# sourceMappingURL=47.aa81a0dd649f9e96fa0e.js.map